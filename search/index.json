[{"content":"ç®€ä»‹ keycloakæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æƒé™è®¤è¯ç³»ç»Ÿï¼Œæˆ‘ä»¬ä½¿ç”¨keycloakå¯ä»¥æ–¹ä¾¿çš„å®ç°SSOçš„åŠŸèƒ½ã€‚è™½ç„¶keycloakåº•å±‚ä½¿ç”¨çš„wildflyï¼Œä½†æ˜¯æä¾›äº†éå¸¸æ–¹ä¾¿çš„Client Adapterså’Œå„ç§æœåŠ¡å™¨è¿›è¡Œå¯¹æ¥ï¼Œæ¯”å¦‚wildflyï¼Œtomcatï¼ŒJettyç­‰ã€‚\nå¯¹äºæœ€æµè¡Œçš„SpringBootæ¥è¯´ï¼Œkeycloakæœ‰å®˜æ–¹Adapterï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®å³å¯ã€‚å¦‚æœéSpringBootåº”ç”¨å‘¢ï¼Œé‚£å°±åªèƒ½ä½¿ç”¨Java Servlet Filter Adapteräº†ã€‚\nSpringBootæ¥å…¥keycloakçš„ä¾‹å­æ¯”è¾ƒå¤šï¼Œæˆ‘å°±ä¸èµ˜è¿°äº†ã€‚è¿™é‡Œåªç®€å•è¯´æ˜ä¸‹ã€‚\næ¥å…¥å‰çš„å‰ç½®å‡†å¤‡ åœ¨æ¥å…¥å„ç§åº”ç”¨ä¹‹å‰ï¼Œéœ€è¦åœ¨keycloakä¸­åšå¥½ç›¸åº”çš„é…ç½®ã€‚ä¸€èˆ¬æ¥è¯´éœ€è¦ä½¿ç”¨ä¸‹é¢çš„æ­¥éª¤ï¼š\n  åˆ›å»ºæ–°çš„realm\nä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†éš”ç¦»ä¸åŒç±»å‹çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬å»ºè®®ä¸ºä¸åŒçš„clientåˆ›å»ºä¸åŒçš„realmã€‚å½“ç„¶ï¼Œå¦‚æœè¿™äº›clientæ˜¯ç›¸å…³è”çš„ï¼Œåˆ™å¯ä»¥åˆ›å»ºåœ¨åŒä¸€ä¸ªrealmä¸­ã€‚\n  åˆ›å»ºæ–°çš„ç”¨æˆ·å’Œè§’è‰²ã€‚\nç”¨æˆ·æ˜¯ç”¨æ¥ç™»å½•keycloakç”¨çš„ï¼Œå¦‚æœæ˜¯ä¸åŒçš„realmï¼Œåˆ™éœ€è¦åˆ†åˆ«åˆ›å»ºç”¨æˆ·ã€‚ç”¨æˆ·å¯†ç ä¹Ÿæ˜¯åœ¨è¿™ä¸€æ­¥åˆ›å»ºçš„\n  æ·»åŠ å’Œé…ç½®client\nè¿™ä¸€æ­¥æ˜¯éå¸¸é‡è¦çš„ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®åº”ç”¨ç¨‹åºçš„ä¸åŒï¼Œé…ç½®ä¸åŒçš„root URLï¼Œredirect URIç­‰ã€‚\nè¿˜å¯ä»¥é…ç½®mapperå’Œscopeä¿¡æ¯ã€‚\næœ€åï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨ç«¯çš„é…ç½®çš„è¯ï¼Œè¿˜éœ€è¦installationçš„ä¸€äº›ä¿¡æ¯ã€‚\næœ‰äº†è¿™äº›åŸºæœ¬çš„é…ç½®ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å‡†å¤‡æ¥å…¥åº”ç”¨ç¨‹åºäº†ã€‚\n  Springbootæ¥å…¥keycloak å¼•å…¥ä¾èµ– \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.keycloak\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;keycloak-spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;11.0.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;  ç„¶åé…ç½®application.yml keycloak: auth-server-url: http://localhost:8080/auth realm: wildfly public-client: true resource: product-app securityConstraints: - authRoles: # ä»¥ä¸‹è·¯å¾„éœ€è¦userè§’è‰²æ‰èƒ½è®¿é—® - user securityCollections: # nameå¯ä»¥éšä¾¿å†™ - name: user-role-mappings patterns: - /users/*  è‡³æ­¤å°±æ¥å…¥å®Œæˆäº†ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•ä»£ç ã€‚\nè·å–KeycloakSecurityContext ä½†æ˜¯å®é™…ä½¿ç”¨ä¸­ï¼Œå…‰èƒ½æ§åˆ¶ç™»é™†æƒé™è¿˜ä¸å¤Ÿï¼Œä¸šåŠ¡ä»£ç ä¸­è¿˜éœ€è¦èƒ½è·å–åˆ°å½“å‰è§’è‰²ï¼Œç”¨æˆ·åç­‰ä¿¡æ¯ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°KeycloakSecurityContextäº†ã€‚KeycloakSecurityContextæ˜¯keycloakçš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…¶ä¸­è·å–åˆ°AccessTokenï¼ŒIDTokenï¼ŒAuthorizationContextå’Œrealmä¿¡æ¯ã€‚\nIdentity.java\nimport java.util.List; import org.keycloak.AuthorizationContext; import org.keycloak.KeycloakSecurityContext; import org.keycloak.representations.idm.authorization.Permission; /** * \u0026lt;p\u0026gt;This is a simple facade to obtain information from authenticated users. You should see usages of instances of this class when * rendering the home page (@code home.ftl). * * \u0026lt;p\u0026gt;Instances of this class are are added to models as attributes in order to make them available to templates. * * @author \u0026lt;a href=\u0026quot;mailto:psilva@redhat.com\u0026quot;\u0026gt;Pedro Igor\u0026lt;/a\u0026gt; * @see com.github.your.demo.controller.HomeController */ public class Identity { private final KeycloakSecurityContext securityContext; public Identity(KeycloakSecurityContext securityContext) { this.securityContext = securityContext; } /** * An example on how you can use the {@link org.keycloak.AuthorizationContext} to check for permissions granted by Keycloak for a particular user. * * @param name the name of the resource * @return true if user has was granted with a permission for the given resource. Otherwise, false. */ public boolean hasResourcePermission(String name) { return getAuthorizationContext().hasResourcePermission(name); } /** * An example on how you can use {@link KeycloakSecurityContext} to obtain information about user's identity. * * @return the user name */ public String getName() { return securityContext.getIdToken().getPreferredUsername(); } /** * An example on how you can use the {@link org.keycloak.AuthorizationContext} to obtain all permissions granted for a particular user. * * @return */ public List\u0026lt;Permission\u0026gt; getPermissions() { return getAuthorizationContext().getPermissions(); } /** * Returns a {@link AuthorizationContext} instance holding all permissions granted for an user. The instance is build based on * the permissions returned by Keycloak. For this particular application, we use the Entitlement API to obtain permissions for every single * resource on the server. * * @return */ private AuthorizationContext getAuthorizationContext() { return securityContext.getAuthorizationContext(); } }  ä½¿ç”¨\n@RestController public class HomeController { private Logger logger = LoggerFactory.getLogger(HomeController.class); @Autowired private JdbcTemplate jdbcTemplate; @Autowired private HttpServletRequest request; @RequestMapping(\u0026quot;/users\u0026quot;) @ResponseBody public List\u0026lt;Users\u0026gt; users() { logIdentity(); logger.info(\u0026quot;ä½¿ç”¨JdbcTemplateæŸ¥è¯¢æ•°æ®åº“\u0026quot;); String sql = \u0026quot;SELECT * FROM users \u0026quot;; List\u0026lt;Users\u0026gt; queryAllList = jdbcTemplate.query(sql, new Object[]{}, new BeanPropertyRowMapper\u0026lt;\u0026gt;(Users.class)); logger.info(\u0026quot;æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨\u0026quot; + queryAllList); return queryAllList; } @RequestMapping(\u0026quot;/\u0026quot;) public String home() { return \u0026quot;Hello Docker World\u0026quot;; } private void logIdentity() { KeycloakSecurityContext context=getKeycloakSecurityContext(); if(context!=null){ Identity identity=new Identity(context); logger.info(\u0026quot;KeycloakSecurityContext identity={}\u0026quot;,identity); }else{ logger.info(\u0026quot;KeycloakSecurityContext is null\u0026quot;); } } private KeycloakSecurityContext getKeycloakSecurityContext() { return (KeycloakSecurityContext) request.getAttribute(KeycloakSecurityContext.class.getName()); } }  Identityç±»æ¥è‡ªKeycloakçš„å®˜æ–¹exampleã€‚ä¸Šé¢ä»‹ç»çš„Spring Bootä¸­çš„å…¶å®æ˜¯éšè—çš„åšæ³•ï¼Œadaptorè‡ªåŠ¨ä¸ºæˆ‘ä»¬åšäº†å’ŒKeycloakè®¤è¯æœåŠ¡è¿æ¥çš„äº‹æƒ…ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å»å¤„ç†ï¼Œåˆ™éœ€è¦ç”¨åˆ°Authorization Client Java APIã€‚\næ·»åŠ mavenä¾èµ–ï¼š\n\u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.keycloak\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;keycloak-authz-client\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${KEYCLOAK_VERSION}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt;  å…·ä½“ä½¿ç”¨AuthzClientå¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚\nRestæ¥å£ æœ‰äº†è¿™äº›é…ç½®ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸºäºspring bootå’Œkeycloakçš„ä¸€ä¸ªrestæœåŠ¡äº†ã€‚\nå‡å¦‚æˆ‘ä»¬ä¸ºkeycloakçš„clientåˆ›å»ºäº†æ–°çš„ç”¨æˆ·ï¼šaliceã€‚\nç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦æ‹¿åˆ°aliceçš„access tokenï¼Œåˆ™å¯ä»¥è¿™æ ·æ“ä½œï¼š\nexport access_token=$(\\ curl -X POST http://localhost:8180/auth/realms/spring-boot-quickstart/protocol/openid-connect/token \\ -H 'Authorization: Basic YXBwLWF1dGh6LXJlc3Qtc3ByaW5nYm9vdDpzZWNyZXQ=' \\ -H 'content-type: application/x-www-form-urlencoded' \\ -d 'username=alice\u0026amp;password=alice\u0026amp;grant_type=password' | jq --raw-output '.access_token' \\ )  è¿™ä¸ªå‘½ä»¤æ˜¯ç›´æ¥é€šè¿‡ç”¨æˆ·åå¯†ç çš„æ–¹å¼å»keycloakæœåŠ¡å™¨ä¸­æ‹¿å–access_token,é™¤äº†access_tokenï¼Œè¿™ä¸ªå‘½ä»¤è¿˜ä¼šè¿”å›refresh_tokenå’Œsession stateçš„ä¿¡æ¯ã€‚\nå› ä¸ºæ˜¯ç›´æ¥å’Œkeycloakè¿›è¡Œäº¤æ¢ï¼Œæ‰€ä»¥keycloakçš„directAccessGrantsEnabledä¸€å®šè¦è®¾ç½®ä¸ºtrueã€‚\nä¸Šé¢å‘½ä»¤ä¸­çš„Authorizationæ˜¯ä»€ä¹ˆå€¼å‘¢ï¼Ÿ\nè¿™ä¸ªå€¼æ˜¯ä¸ºäº†é˜²æ­¢æœªæˆæƒçš„clientå¯¹keycloakæœåŠ¡å™¨çš„éæ³•è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦è¯·æ±‚å®¢æˆ·ç«¯æä¾›client-idå’Œå¯¹åº”çš„client-secretå¹¶ä¸”ä»¥ä¸‹é¢çš„æ–¹å¼è¿›è¡Œç¼–ç å¾—åˆ°çš„ï¼š\nAuthorization: basic BASE64(client-id + ':' + client-secret)  access_tokenæ˜¯JWTæ ¼å¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•è§£å¯†ä¸€ä¸‹ä¸Šé¢å‘½ä»¤å¾—å‡ºçš„token:\n{ alg: \u0026quot;RS256\u0026quot;, typ: \u0026quot;JWT\u0026quot;, kid: \u0026quot;FJ86GcF3jTbNLOco4NvZkUCIUmfYCqoqtOQeMfbhNlE\u0026quot; }. { exp: 1603614445, iat: 1603614145, jti: \u0026quot;b69c784d-5b2d-46ad-9f8d-46214add7afb\u0026quot;, iss: \u0026quot;http://localhost:8180/auth/realms/spring-boot-quickstart\u0026quot;, sub: \u0026quot;e6606d93-99f6-4829-ba99-1329be604159\u0026quot;, typ: \u0026quot;Bearer\u0026quot;, azp: \u0026quot;app-authz-springboot\u0026quot;, session_state: \u0026quot;bdc33764-fd1a-400e-9fe0-90a82f4873c1\u0026quot;, acr: \u0026quot;1\u0026quot;, allowed-origins: [ \u0026quot;http://localhost:8080\u0026quot; ], realm_access: { roles: [ \u0026quot;user\u0026quot; ] }, scope: \u0026quot;email profile\u0026quot;, email_verified: false, preferred_username: \u0026quot;alice\u0026quot; }. [signature]  æœ‰äº†access_token,æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®access_tokenå»åšå¾ˆå¤šäº‹æƒ…äº†ã€‚\næ¯”å¦‚ï¼šè®¿é—®å—é™çš„èµ„æºï¼š\ncurl http://localhost:8080/api/resourcea \\ -H \u0026quot;Authorization: Bearer \u0026quot;$access_token  è¿™é‡Œçš„api/resourceaåªæ˜¯æˆ‘ä»¬æœ¬åœ°spring bootåº”ç”¨ä¸­ä¸€ä¸ªéå¸¸ç®€å•çš„è¯·æ±‚èµ„æºé“¾æ¥ï¼Œä¸€åˆ‡çš„æƒé™æ ¡éªŒå·¥ä½œéƒ½ä¼šè¢«keycloakæ‹¦æˆªï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªapiçš„å®ç°ï¼š\n@RequestMapping(value = \u0026quot;/api/resourcea\u0026quot;, method = RequestMethod.GET) public String handleResourceA() { return createResponse(); } private String createResponse() { return \u0026quot;Access Granted\u0026quot;; }  å¯ä»¥çœ‹åˆ°è¿™ä¸ªåªæ˜¯ä¸€ä¸ªç®€å•çš„txtè¿”å›ï¼Œä½†æ˜¯å› ä¸ºæœ‰keycloakçš„åŠ æŒï¼Œå°±å˜æˆäº†ä¸€ä¸ªå¸¦æƒé™çš„èµ„æºè°ƒç”¨ã€‚\nä¸Šé¢çš„access_tokenè§£æè¿‡åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢æ˜¯æ²¡æœ‰åŒ…å«æƒé™ä¿¡æ¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨access_tokenæ¥äº¤æ¢ä¸€ä¸ªç‰¹æ®Šçš„RPTçš„tokenï¼Œè¿™ä¸ªtokené‡Œé¢åŒ…å«ç”¨æˆ·çš„æƒé™ä¿¡æ¯ï¼š\ncurl -X POST \\ http://localhost:8180/auth/realms/spring-boot-quickstart/protocol/openid-connect/token \\ -H \u0026quot;Authorization: Bearer \u0026quot;$access_token \\ --data \u0026quot;grant_type=urn:ietf:params:oauth:grant-type:uma-ticket\u0026quot; \\ --data \u0026quot;audience=app-authz-rest-springboot\u0026quot; \\ --data \u0026quot;permission=Default Resource\u0026quot; | jq --raw-output '.access_token'  å°†å¾—å‡ºçš„ç»“æœè§£å¯†ä¹‹åï¼Œçœ‹ä¸‹é‡Œé¢çš„å†…å®¹ï¼š\n{ alg: \u0026quot;RS256\u0026quot;, typ: \u0026quot;JWT\u0026quot;, kid: \u0026quot;FJ86GcF3jTbNLOco4NvZkUCIUmfYCqoqtOQeMfbhNlE\u0026quot; }. { exp: 1603614507, iat: 1603614207, jti: \u0026quot;93e42d9b-4bc6-486a-a650-b912185c35db\u0026quot;, iss: \u0026quot;http://localhost:8180/auth/realms/spring-boot-quickstart\u0026quot;, aud: \u0026quot;app-authz-springboot\u0026quot;, sub: \u0026quot;e6606d93-99f6-4829-ba99-1329be604159\u0026quot;, typ: \u0026quot;Bearer\u0026quot;, azp: \u0026quot;app-authz-springboot\u0026quot;, session_state: \u0026quot;bdc33764-fd1a-400e-9fe0-90a82f4873c1\u0026quot;, acr: \u0026quot;1\u0026quot;, allowed-origins: [ \u0026quot;http://localhost:8080\u0026quot; ], realm_access: { roles: [ \u0026quot;user\u0026quot; ] }, authorization: { permissions: [ { rsid: \u0026quot;e26d5d63-5976-4959-8683-94b7d85318e7\u0026quot;, rsname: \u0026quot;Default Resource\u0026quot; } ] }, scope: \u0026quot;email profile\u0026quot;, email_verified: false, preferred_username: \u0026quot;alice\u0026quot; }. [signature]  å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªRPTå’Œä¹‹å‰çš„access_tokençš„åŒºåˆ«æ˜¯è¿™ä¸ªé‡Œé¢åŒ…å«äº†authorizationä¿¡æ¯ã€‚\næˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªRPTçš„tokenå’Œä¹‹å‰çš„access_tokenä¸€æ ·ä½¿ç”¨ã€‚\nJetty+Jerseyæ¡†æ¶æ¥å…¥Keycloak æˆ‘ä»¬æœ‰ä¸€ä¸ªè€ç³»ç»Ÿï¼Œç”¨çš„embeded Jetty+Jerseyï¼Œè™½ç„¶å®˜æ–¹æä¾›äº†Jetty 9.x Adaptersï¼Œä½†è¿™æ˜¯é’ˆå¯¹standaloneè€Œè¨€çš„ï¼Œç°åœ¨å‡ ä¹æ²¡äººè¿™ä¹ˆç”¨äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—è‡ªå·±æ¥ã€‚å®˜æ–¹æœ‰Java Servlet Filter Adapterçš„æ•™ç¨‹ï¼Œä½†æ˜¯ç”¨çš„æ˜¯web.xmlçš„ä¾‹å­ï¼Œè€Œä¸”è¯­ç„‰ä¸è¯¦ï¼Œæ‰€ä»¥è¿™é‡Œå°±æˆ‘è‡ªå·±çš„æ‘¸ç´¢æä¾›ä¸€ç‚¹å‚è€ƒã€‚\nJettyæ•´åˆJerseyæ¡†æ¶ å…ˆæ¥çœ‹ä¸€ä¸‹Jetty+Jerseyçš„åŸç”Ÿä¾‹å­ï¼Œæ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ App.java\npackage xyz.chen; import org.eclipse.jetty.server.Server; import org.eclipse.jetty.servlet.ServletContextHandler; import org.eclipse.jetty.servlet.ServletHolder; import org.glassfish.jersey.servlet.ServletContainer; public class App { public static void main(String[] args) { Server server = new Server(9999); ServletContextHandler context = new ServletContextHandler(ServletContextHandler.NO_SESSIONS); context.setContextPath(\u0026quot;/\u0026quot;); server.setHandler(context); // é…ç½®Servlet ServletHolder holder = context.addServlet(ServletContainer.class.getCanonicalName(), \u0026quot;/rest/*\u0026quot;); holder.setInitOrder(1); holder.setInitParameter(\u0026quot;jersey.config.server.provider.packages\u0026quot;, \u0026quot;xyz.chen\u0026quot;); holder.setInitParameter(\u0026quot;jersey.config.server.provider.classnames\u0026quot;, \u0026quot;org.glassfish.jersey.server.filter.CsrfProtectionFilter\u0026quot;); try { server.start(); server.join(); } catch (Exception e) { e.printStackTrace(); } finally { server.destroy(); } } }  ç„¶åæ˜¯ä¸šåŠ¡ç±»ï¼š HelloResource.java\npackage xyz.chen; import javax.ws.rs.*; import javax.ws.rs.core.MediaType; import javax.ws.rs.core.MultivaluedMap; import javax.ws.rs.core.PathSegment; import javax.ws.rs.core.Response; import java.util.HashMap; import java.util.List; import java.util.Map; import java.util.Map.Entry; @Path(\u0026quot;hello\u0026quot;) public class HelloResource { @Path(\u0026quot;index\u0026quot;) @GET @Consumes(MediaType.TEXT_PLAIN) @Produces(MediaType.TEXT_PLAIN) public Response helloworld() { return Response.ok(\u0026quot;hello jersey\u0026quot;).build(); } @GET @Path(\u0026quot;/user/{userName}\u0026quot;) public Response getThemeCss(@PathParam(\u0026quot;userName\u0026quot;) String userName) { StringBuilder sb = new StringBuilder(userName); return Response.ok(sb.toString()).build(); } }  pom.xmlæ–‡ä»¶\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;UTF-8\u0026quot;?\u0026gt; \u0026lt;project xmlns=\u0026quot;http://maven.apache.org/POM/4.0.0\u0026quot; xmlns:xsi=\u0026quot;http://www.w3.org/2001/XMLSchema-instance\u0026quot; xsi:schemaLocation=\u0026quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\u0026quot;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;groupId\u0026gt;org.example\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jersey-demo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;Maven\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.apache.org/\u0026lt;/url\u0026gt; \u0026lt;inceptionYear\u0026gt;2001\u0026lt;/inceptionYear\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;project.build.sourceEncoding\u0026gt;UTF-8\u0026lt;/project.build.sourceEncoding\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.glassfish.jersey.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jersey-server\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.glassfish.jersey.inject\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jersey-hk2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.glassfish.jersey.containers\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jersey-container-servlet-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.glassfish.jersey.containers\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jersey-container-jetty-http\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.jetty\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jetty-server\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;9.4.12.v20180830\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.jetty\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jetty-servlet\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;9.4.12.v20180830\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.eclipse.jetty\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jetty-util\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;9.4.12.v20180830\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-shade-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.4.3\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;createDependencyReducedPom\u0026gt;true\u0026lt;/createDependencyReducedPom\u0026gt; \u0026lt;filters\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;artifact\u0026gt;*:*\u0026lt;/artifact\u0026gt; \u0026lt;excludes\u0026gt; \u0026lt;exclude\u0026gt;META-INF/*.SF\u0026lt;/exclude\u0026gt; \u0026lt;exclude\u0026gt;META-INF/*.DSA\u0026lt;/exclude\u0026gt; \u0026lt;exclude\u0026gt;META-INF/*.RSA\u0026lt;/exclude\u0026gt; \u0026lt;/excludes\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;/filters\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;phase\u0026gt;package\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;shade\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;transformers\u0026gt; \u0026lt;transformer implementation=\u0026quot;org.apache.maven.plugins.shade.resource.ServicesResourceTransformer\u0026quot; /\u0026gt; \u0026lt;transformer implementation=\u0026quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\u0026quot;\u0026gt; \u0026lt;manifestEntries\u0026gt; \u0026lt;Main-Class\u0026gt;xyz.chen.App\u0026lt;/Main-Class\u0026gt; \u0026lt;/manifestEntries\u0026gt; \u0026lt;/transformer\u0026gt; \u0026lt;/transformers\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt;  è¿è¡Œå°±ä¸å†ä¸¾ä¾‹äº†ã€‚\næ•´åˆkeycloak å¼•å…¥ä¾èµ–\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.keycloak\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;keycloak-servlet-filter-adapter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;11.0.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;  ä¿®æ”¹Appç±»ï¼ŒåŠ å…¥Filter\nServletHandler handler = new ServletHandler(); FilterHolder fh=handler.addFilterWithMapping(org.keycloak.adapters.servlet.KeycloakOIDCFilter.class,\u0026quot;/*\u0026quot;, EnumSet.of(DispatcherType.REQUEST)); fh.setInitParameter(\u0026quot;keycloak.config.file\u0026quot;, \u0026quot;keycloak.json\u0026quot;); context.addFilter(fh, \u0026quot;/*\u0026quot;, EnumSet.of(DispatcherType.REQUEST)); server.setHandler(context);  å…¶ä¸­ï¼Œkeycloak.jsonæ–‡ä»¶æ¥è‡ªkeycloak-clients-installtionï¼Œå½¢å¦‚\n{ \u0026quot;realm\u0026quot;: \u0026quot;wildfly\u0026quot;, \u0026quot;auth-server-url\u0026quot;: \u0026quot;http://localhost:8080/auth/\u0026quot;, \u0026quot;ssl-required\u0026quot;: \u0026quot;external\u0026quot;, \u0026quot;resource\u0026quot;: \u0026quot;product-app\u0026quot;, \u0026quot;public-client\u0026quot;: true, \u0026quot;confidential-port\u0026quot;: 0 }  keycloakçš„é…ç½®ä¸å†èµ˜è¿°ã€‚\nè·å–ç”¨æˆ·æƒé™ä¿¡æ¯ è¿™å—ä¸å†ä¸¾ä¾‹ï¼Œè‡ªå·±å†™ä¸ªFilterå»KeycloakSecurityContexté‡Œæ‹¿å°±å¯ä»¥äº†ã€‚\nå‚è€ƒ https://www.keycloak.org/docs/latest/securing_apps/#_jetty9_adapter\nhttps://stackoverflow.com/questions/22188285/does-embedded-jetty-have-the-ability-to-set-the-init-params-of-a-filter\n","date":"2021-03-24","permalink":"https://iminto.github.io/post/keycloak%E6%8E%A5%E5%85%A5%E8%87%AA%E7%A0%94%E7%B3%BB%E7%BB%9F/","tags":["Java"],"title":"Keycloakæ¥å…¥è‡ªç ”ç³»ç»Ÿ"},{"content":"å®‰è£…ä¾èµ– yum list | grep google-authenticator yum install google-authenticator yum install qrencode  é…ç½®Google Authenticator å®‰è£…å®Œç›´æ¥è·‘ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé…ç½®ï¼Œæ³¨æ„åªåœ¨å½“å‰ç”¨æˆ·ç”Ÿæ•ˆ\n\u0026gt; google-authenticator  ä¹‹åä¼šéœ€è¦ç¡®è®¤å‡ ç‚¹ä¿¡æ¯\nDo you want authentication tokens to be time-based (y/n) y  æ˜¯å¦é…ç½®åŸºäºæ—¶é—´çš„åŠ¨æ€å¯†é’¥ï¼Œé€‰æ‹©yï¼Œä¹‹åä¼šå‡ºç°è¶…çº§å¤§ä¸€ä¸ªäºŒç»´ç ï¼Œä¸‹é¢è¿˜ä¼šæœ‰ä¸€äº›å°å­—,è¿™é‡Œçš„keyå°±æ˜¯ç”¨äºé…ç½®æ‰‹æœºç«¯appçš„ï¼Œæˆ‘ä»¬å…ˆä¿å­˜ä¸‹æ¥ï¼Œä¸ç”¨æ…Œï¼Œå› ä¸ºè¿™ä¸ªkeyéšæ—¶éƒ½å¯ä»¥æŸ¥å¾—åˆ°.\nDo you want me to update your \u0026quot;/root/.google_authenticator\u0026quot; file? (y/n) y  æ˜¯å¦å°†é…ç½®ä¿¡æ¯æ›´æ–°åˆ°è‡ªå·±å®¶ç›®å½•ï¼Œé€‰æ‹©yè¿›è¡Œæ›´æ–°ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œé¢å°±ä¿å­˜ç€ä¸Šé¢çš„keyä¿¡æ¯ï¼Œä»¥é˜²åç»­è¿˜æœ‰æ–°çš„æ‰‹æœºè®¾å¤‡éœ€è¦ç”¨åˆ°key\nDo you want to disallow multiple uses of the same authentication token? This restricts you to one login about every 30s, but it increases your chances to notice or even prevent man-in-the-middle attacks (y/n) y  æ˜¯å¦ç¦æ­¢åŒä¸€å¯†é’¥åœ¨30ç§’å†…è¢«å¤šæ¬¡ä½¿ç”¨ï¼Œå¦‚æœæƒ³è¦æ›´å®‰å…¨å°±é€‰æ‹©yï¼Œå¦‚æœæƒ³è¦æ›´æ–¹ä¾¿å°±é€‰æ‹©n\nBy default, a new token is generated every 30 seconds by the mobile app. In order to compensate for possible time-skew between the client and the server, we allow an extra token before and after the current time. This allows for a time skew of up to 30 seconds between authentication server and client. If you experience problems with poor time synchronization, you can increase the window from its default size of 3 permitted codes (one previous code, the current code, the next code) to 17 permitted codes (the 8 previous codes, the current code, and the 8 next codes). This will permit for a time skew of up to 4 minutes between client and server. Do you want to do so? (y/n) n  æ˜¯å¦å…è®¸å‰8æ¬¡å’Œå8æ¬¡çš„åŠ¨æ€å¯†é’¥ä¹Ÿæœ‰æ•ˆï¼Œå¦‚æœå®¢æˆ·ç«¯å’Œæ‰‹æœºç«¯éƒ½æ˜¯åŸºäºç½‘ç»œçš„æ—¶é—´åŒæ­¥ï¼Œé€‰æ‹©næé«˜å®‰å…¨æ€§\nIf the computer that you are logging into isn't hardened against brute-force login attempts, you can enable rate-limiting for the authentication module. By default, this limits attackers to no more than 3 login attempts every 30s. Do you want to enable rate-limiting? (y/n) y  æ˜¯å¦é™åˆ¶30ç§’å†…æœ€å¤š3æ¬¡å°è¯•ï¼Œä¸ºäº†é˜²æ­¢æ¶æ„è¯•é”™ï¼Œé€‰æ‹©y è¿™æ ·æœåŠ¡ç«¯çš„Google Authenticatorå°±é…ç½®å®Œæ¯•ã€‚ä¸‹é¢åšä¸€äº›ç³»ç»Ÿè®¾ç½®ï¼Œä½¿ä¸Šé¢çš„é…ç½®ç”¨ä½œsshã€‚\né…ç½®pam vim /etc/pam.d/sshd auth required pam_google_authenticator.so nullok vim /etc/ssh/sshd_config UsePAM yes PasswordAuthentication no ChallengeResponseAuthentication yes sshd -t systemctl restart sshd  éœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»è®¾ç½®PasswordAuthentication noï¼ˆç¦ç”¨å¯†ç ç™»é™†ï¼Œä½†æ˜¯å¹¶éå¿…é¡»ä½¿ç”¨å…¬é’¥ï¼‰ï¼Œå¦åˆ™äºŒæ¬¡éªŒè¯æ— æ³•ä½¿ç”¨ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\nsshd[2690384]: fatal: PAM: pam_setcred(): Permission denied  æ‰‹æœºè®¾ç½® æ¨èä½¿ç”¨ andotp è¿™ä¸ªAPPï¼Œæ‰«ç æ·»åŠ å³å¯ã€‚\nå¦‚æœæ¢äº†æ‰‹æœºä¹Ÿå¾ˆå®¹æ˜“ï¼Œç™»å½•åˆ°æœåŠ¡å™¨ï¼Œæ‰¾åˆ°~/.google_authenticatoræ–‡ä»¶ï¼Œé‡Œé¢ä¼šæœ‰ä¹‹å‰ä¿å­˜çš„keyï¼Œé‡æ–°åœ¨æ–°æ‰‹æœºè¿›è¡Œæ·»åŠ å³å¯ã€‚\nXshellç™»å½•éªŒè¯ ä¸‹é¢è¿˜æ˜¯æ­£å¸¸sshç™»é™†æœåŠ¡å™¨ï¼Œä¸è¿‡è¾“å…¥å®Œç”¨æˆ·åä»¥ååªèƒ½é€‰æ‹©äº¤äº’é”®ç›˜ï¼Œä¾æ¬¡è¾“å…¥å¯†ç å’ŒOTPéªŒè¯ç å³å¯ã€‚å…³äºç™»å½•çš„ä¸€äº›æŠ¥é”™éƒ½åœ¨/var/log/secureè¿™ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆåœºæ™¯ç™»é™†å¤±è´¥éƒ½å¯ä»¥å…ˆæŸ¥çœ‹ä¸‹å¤±è´¥æ—¥å¿—ï¼Œå¯¹ç—‡ä¸‹è¯ã€‚\næ³¨æ„ä¿æŒæ—¶é—´åŒæ­¥ã€‚ ç›´æ¥ä½¿ç”¨ntpdateå³å¯ï¼Œå›½å†…å¯ä»¥ä½¿ç”¨å›½å®¶æˆæ—¶ä¸­å¿ƒçš„åœ°å€\nntpdate -u 210.72.145.44  åŸºæœ¬ä¸ŠæœåŠ¡å™¨å’Œæ‰‹æœºéƒ½æ˜¯ç”¨çš„ç½‘ç»œæ—¶é—´å°±ä¸å¤ªä¼šæœ‰æ—¶é—´åŒæ­¥çš„é—®é¢˜ã€‚\nrefer:https://blog.csdn.net/Victor2code/\u0026hellip;\n","date":"2020-12-29","permalink":"https://iminto.github.io/post/centos%E9%85%8D%E7%BD%AEgoogleauthenticator%E5%8A%A8%E6%80%81%E5%AF%86%E9%92%A5%E8%BF%9B%E8%A1%8Cssh%E4%BA%8C%E6%AC%A1%E9%AA%8C%E8%AF%81/","tags":["Linux"],"title":"Centosé…ç½®GoogleAuthenticatoråŠ¨æ€å¯†é’¥è¿›è¡ŒsshäºŒæ¬¡éªŒè¯"},{"content":"TUI ConsoleLauncher basically transforms your Android into a terminal window, requiring you to type out commands to start apps and explore your phone\u0026rsquo;s system as opposed to the familiar process of tapping on icons. It\u0026rsquo;s a great way to practice or learn about Linux commands, and it has the added benefit of securing your phone against unwanted access.\nå¸¸ç”¨å‘½ä»¤ï¼š\n-- ä¸å…è®¸åˆ«äººç”¨exitå‘½ä»¤é€€å‡º alias add exit=echo \u0026quot;No\u0026quot; -- å®šåˆ¶åŒ–ç•Œé¢ï¼Œå–æ¶ˆä¸å¿…è¦å…ƒç´  config -set show_session_info false config -set show_storage_info false config -set show_device_name false config -set show_ram false config -set show_network_info false -- ä¼˜åŒ– config -set time_size 20 --è°ƒå¤§æ—¶é—´å­—ä½“ config -set system_wallpaper true --æ˜¾ç¤ºç³»ç»Ÿå£çº¸ config -set fullscreen true config -set enable_music true -- è®°æ—¥å¿—/å¤‡å¿˜å½• note -add æ˜æ—©ä¹ç‚¹åŠ ç­  ä¿®æ”¹é…ç½®åéœ€è¦restartæ‰èƒ½ç”Ÿæ•ˆã€‚\nç»“åˆshellcommandç­‰ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰å‡ºå„ç§å°å·¥å…·ã€‚\n","date":"2020-12-25","permalink":"https://iminto.github.io/post/tui-consolelauncher-%E5%8F%AF%E5%AE%9A%E5%88%B6%E5%8C%96geek%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%A1%8C%E9%9D%A2%E5%90%AF%E5%8A%A8%E5%99%A8/","tags":["é—²æ‰¯æ·¡"],"title":"TUI ConsoleLauncher å¯å®šåˆ¶åŒ–geekå‘½ä»¤è¡Œæ¡Œé¢å¯åŠ¨å™¨"},{"content":"Ambarié‡Œä¸»æœºï¼Œé›†ç¾¤ï¼Œç”¨æˆ·ç­‰ç­‰éƒ½è§†ä¸ºä¸€ç§èµ„æºï¼Œå¯¹å®ƒä»¬çš„å¢åˆ æ”¹æŸ¥å°±æ˜¯å¯¹èµ„æºçš„å¢åˆ æ”¹æŸ¥ã€‚\näº†è§£å®ç°Ambarié‡Œå¢åŠ ä¸€ä¸ªèµ„æºçš„æµç¨‹ï¼Œå°±æ›´æ–¹ä¾¿ä¿®æ”¹Ambariçš„å®ç°ã€‚\n1.æ–°å»ºæ§åˆ¶å™¨å±‚ ambariçš„æ§åˆ¶å™¨å±‚åœ¨serviceåŒ…é‡Œ\npackage org.apache.ambari.server.api.services.dataspace; import io.swagger.annotations.Api; import org.apache.ambari.server.api.resources.ResourceInstance; import org.apache.ambari.server.api.services.BaseService; import org.apache.ambari.server.api.services.Request; import org.apache.ambari.server.controller.spi.Resource; import javax.ws.rs.GET; import javax.ws.rs.Path; import javax.ws.rs.Produces; import javax.ws.rs.core.Context; import javax.ws.rs.core.HttpHeaders; import javax.ws.rs.core.Response; import javax.ws.rs.core.UriInfo; import java.util.Collections; @Path(\u0026quot;/hdfs/\u0026quot;) @Api(value = \u0026quot;Hdfss\u0026quot;, description = \u0026quot;Endpoint for user specific operations\u0026quot;) public class HdfsService extends BaseService { @GET//æŸ¥è¯¢å…¨éƒ¨ @Produces(\u0026quot;text/plain\u0026quot;) public Response getHdfses(String body, @Context HttpHeaders headers, @Context UriInfo ui) { return handleRequest(headers, body, ui, Request.Type.GET, createHdfsResource(null)); } @GET @Path(\u0026quot;{path}\u0026quot;)//æŸ¥è¯¢å•ä¸ª @Produces(\u0026quot;text/plain\u0026quot;) public Response getHdfs(String body, @Context HttpHeaders headers, @Context UriInfo ui) { return handleRequest(headers, body, ui, Request.Type.GET, createHdfsResource(path)); } private ResourceInstance createHdfsResource(String path) { return createResource(Resource.Type.Hdfs, Collections.singletonMap(Resource.Type.Hdfs, path)); } }  ç»§æ‰¿BaseServiceã€‚è¿™é‡Œå®šä¹‰è®¿é—®è·¯å¾„å’Œå‚æ•°ã€‚seriviceçš„æ–¹æ³•å‚æ•°ä¸Šæ˜¯çœ‹ä¸å‡ºVOçš„ç±»å‹çš„ã€‚å¤æ‚çš„æ§åˆ¶å™¨ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªserviceé‡Œè°ƒç”¨å¦å¤–ä¸€ä¸ªservice.\nè®¿é—®å‚æ•°å¯ä»¥å°è£…æˆå¯¹è±¡ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªXXXRequestå¯¹è±¡ï¼Œæ¯”å¦‚\npackage org.apache.ambari.server.controller; public class HdfsRequest { private Integer id; private String path; private Integer size; //getter,setterç•¥ }  è¿™é‡Œçš„xxxRequestæ˜¯ä¸ä¼šåƒspringbootä¸€æ ·è‡ªåŠ¨å°è£…æˆå¯¹è±¡çš„ã€‚\n2.ç»§æ‰¿ResourceProvideï¼Œå®ç°å…·ä½“çš„handleRequestæ–¹æ³• package org.apache.ambari.server.controller.internal; import com.google.common.collect.ImmutableMap; import com.google.common.collect.Sets; import org.apache.ambari.server.controller.AmbariManagementController; import org.apache.ambari.server.controller.HdfsRequest; import org.apache.ambari.server.controller.spi.Predicate; import org.apache.ambari.server.controller.spi.Request; import org.apache.ambari.server.controller.spi.Resource; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.util.HashSet; import java.util.Map; import java.util.Set; public class HdfsResourceProvider extends AbstractControllerResourceProvider{ private static final Logger LOG = LoggerFactory.getLogger(HdfsResourceProvider.class); public static final String HDFS_RESOURCE_CATEGORY=\u0026quot;Hdfses\u0026quot;; public static final String HDFS_ID_PROPERTY_ID =\u0026quot;hdfs_id\u0026quot;; public static final String HDFS_PATH_PROPERTY_ID =\u0026quot;hdfs_path\u0026quot;; public static final String HDFS_SIZE_PROPERTY_ID =\u0026quot;hdfs_size\u0026quot;; public static final String HDFS_RESOURCE_HDFS_ID_PROPERTY_ID =HDFS_RESOURCE_CATEGORY+\u0026quot;/\u0026quot;+HDFS_ID_PROPERTY_ID; public static final String HDFS_RESOURCE_HDFS_PATH_PROPERTY_ID =HDFS_RESOURCE_CATEGORY+\u0026quot;/\u0026quot;+HDFS_PATH_PROPERTY_ID; public static final String HDFS_RESOURCE_HDFS_SIZE_PROPERTY_ID =HDFS_RESOURCE_CATEGORY+\u0026quot;/\u0026quot;+HDFS_SIZE_PROPERTY_ID; private static Map\u0026lt;Resource.Type, String\u0026gt; keyPropertyIds = ImmutableMap.\u0026lt;Resource.Type, String\u0026gt;builder() .put(Resource.Type.Hdfs, HDFS_RESOURCE_HDFS_ID_PROPERTY_ID) .build(); private static Set\u0026lt;String\u0026gt; propertyIds = Sets.newHashSet( HDFS_RESOURCE_HDFS_ID_PROPERTY_ID, HDFS_RESOURCE_HDFS_PATH_PROPERTY_ID, HDFS_RESOURCE_HDFS_SIZE_PROPERTY_ID ); public static void init(){ //æ³¨å…¥æ“ä½œåœ¨æ­¤ } HdfsResourceProvider(AmbariManagementController managementController) { super(Resource.Type.Hdfs, propertyIds, keyPropertyIds, managementController); } @Override protected Set\u0026lt;Resource\u0026gt; getResourcesAuthorized(Request request, Predicate predicate){ Set\u0026lt;String\u0026gt; hdfsIds=getRequestPropertyIds(request,predicate); Set\u0026lt;Resource\u0026gt; resources=new HashSet\u0026lt;\u0026gt;(); //æŸ¥è¯¢æ•°æ®åº“ç•¥ for(int i=0;i\u0026lt;3;i++){ ResourceImpl resource=new ResourceImpl(Resource.Type.Hdfs); setResourceProperty(resource,HDFS_RESOURCE_HDFS_ID_PROPERTY_ID,i,hdfsIds); setResourceProperty(resource,HDFS_RESOURCE_HDFS_PATH_PROPERTY_ID,\u0026quot;path\u0026quot;+i,hdfsIds); setResourceProperty(resource,HDFS_RESOURCE_HDFS_SIZE_PROPERTY_ID,i*100,hdfsIds); resources.add(resource); } return resources; } private HdfsRequest getRequest(Map\u0026lt;String,Object\u0026gt; properties){ if(properties==null){ return new HdfsRequest(); } HdfsRequest hdfsRequest=new HdfsRequest(); if(properties.get(\u0026quot;HDFS_RESOURCE_HDFS_ID_PROPERTY_ID\u0026quot;)!=null){ hdfsRequest.setId(Integer.parseInt(properties.get(\u0026quot;HDFS_RESOURCE_HDFS_ID_PROPERTY_ID\u0026quot;).toString())); } if(properties.get(\u0026quot;HDFS_RESOURCE_HDFS_SIZE_PROPERTY_ID\u0026quot;)!=null){ hdfsRequest.setSize(Integer.parseInt(properties.get(\u0026quot;HDFS_RESOURCE_HDFS_SIZE_PROPERTY_ID\u0026quot;).toString())); } hdfsRequest.setPath(properties.get(\u0026quot;HDFS_RESOURCE_HDFS_ID_PROPERTY_ID\u0026quot;).toString()); return hdfsRequest; } @Override public RequestStatus updateResources(Request request, Predicate predicate){ //æ›´æ–°æ“ä½œç•¥ return getRequestStatus(null); } @Override protected Set\u0026lt;String\u0026gt; getPKPropertyIds() { return new HashSet\u0026lt;\u0026gt;(keyPropertyIds.values()); } }  è¿™é‡Œé¢å®šä¹‰äº†å„ç§å‚æ•°å­—æ®µå’Œå‚æ•°å®Œæ•´æ€§æ ¡éªŒï¼Œå¯¹åº”å‰ç«¯ä¼ å€¼ï¼Œå®ç°CRUDé€»è¾‘ï¼Œè°ƒç”¨daoç­‰ã€‚ResourceProviderå’ŒRequestç±»çš„ä½œç”¨æœ‰äº¤å‰ã€‚\ngetRequest()ç”¨äºä»request Mapé‡Œè·å–å­—ç¬¦ä¸²å‚æ•°ç»„è£…æˆå¯¹è±¡ã€‚\nåŒæ—¶éœ€è¦åœ¨AbstractControllerResourceProvideré‡Œå¢åŠ ä¸€æ¡è®°å½•\ncase AlertTarget: return resourceProviderFactory.getAlertTargetResourceProvider(); case ViewInstance: return resourceProviderFactory.getViewInstanceResourceProvider(); case Hdfs: return new HdfsResourceProvider(managementController); default: throw new IllegalArgumentException(\u0026quot;Unknown type \u0026quot; + type);  3.å®ç°ResourceDefinition package org.apache.ambari.server.api.resources; import org.apache.ambari.server.controller.spi.Resource; import java.util.HashSet; import java.util.Set; public class HdfsResourceDefinition extends BaseResourceDefinition { { } /** * Constructor. * * @param resourceType resource type */ public HdfsResourceDefinition() { super(Resource.Type.Hdfs); } /** * Obtain the plural name of the resource. * * @return the plural name of the resource */ @Override public String getPluralName() { return \u0026quot;hdfses\u0026quot;; } /** * Obtain the singular name of the resource. * * @return the singular name of the resource */ @Override public String getSingularName() { return \u0026quot;hdfs\u0026quot;; } @Override public Set\u0026lt;SubResourceDefinition\u0026gt; getSubResourceDefinitions() { final Set\u0026lt;SubResourceDefinition\u0026gt; subResourceDefinitions = new HashSet\u0026lt;\u0026gt;(); subResourceDefinitions.add(new SubResourceDefinition(Resource.Type.Hdfs)); return subResourceDefinitions; } }  è¿™é‡Œè·Ÿæƒé™åº”è¯¥å°±æœ‰äº†å…³ç³»ã€‚\nä¿®æ”¹ResourceInstanceFactoryImplï¼ŒåŠ å…¥è‡ªå·±å®šä¹‰çš„æ–°ç±»å‹\ncase RemoteCluster: resourceDefinition = new RemoteClusterResourceDefinition(); break; case Hdfs: resourceDefinition = new HdfsResourceDefinition(); break; default: throw new IllegalArgumentException(\u0026quot;Unsupported resource type: \u0026quot; + type); }  spiåŒ…ä¸‹Resourceæ¥å£æ–°å¢ä¸€ä¸ªæšä¸¾\npackage org.apache.ambari.server.controller.spi; public interface Resource { enum InternalType { Cluster, Service, Setting,  4.æ•°æ®åº“ç›¸å…³ ormåŒ…ä¸‹æ·»åŠ å¯¹åº”çš„å®ä½“ç±»å’ŒDaoå®ç°ï¼Œresource/META-INFä¸‹éœ€è¦æ‰‹åŠ¨æ·»åŠ å®ä½“ç±»å¯¹è±¡å…¨åï¼Œæ¯”å¦‚\n\u0026lt;persistence-unit name=\u0026quot;ambari-server\u0026quot; transaction-type=\u0026quot;RESOURCE_LOCAL\u0026quot;\u0026gt; \u0026lt;provider\u0026gt;org.eclipse.persistence.jpa.PersistenceProvider\u0026lt;/provider\u0026gt; \u0026lt;class\u0026gt;org.apache.ambari.server.orm.entities.AlertCurrentEntity\u0026lt;/class\u0026gt; \u0026lt;class\u0026gt;org.apache.ambari.server.orm.entities.AlertDefinitionEntity\u0026lt;/class\u0026gt; \u0026lt;/persistence-unit\u0026gt;  entityä¸¾ä¾‹ï¼š\npackage org.apache.ambari.server.orm.entities; import javax.persistence.*; @Entity @Table(name = \u0026quot;admin_cluster_host\u0026quot;) public class AdminClusterHostEntity { @Id @GeneratedValue(strategy = GenerationType.AUTO) @Column(name = \u0026quot;id\u0026quot;, nullable = false, updatable = false) private Integer id; @Column(name = \u0026quot;host\u0026quot;, length = 255) private String host; @Column(name = \u0026quot;cluster\u0026quot;, length = 255) private String cluster; public Integer getId() { return id; } public void setId(Integer id) { this.id = id; } public String getHost() { return host; } public void setHost(String host) { this.host = host; } public String getCluster() { return cluster; } public void setCluster(String cluster) { this.cluster = cluster; } }  daoä¸¾ä¾‹\npackage org.apache.ambari.server.orm.dao; import com.google.inject.Inject; import com.google.inject.Provider; import com.google.inject.Singleton; import org.apache.ambari.server.orm.RequiresSession; import org.apache.ambari.server.orm.entities.AdminClusterHostEntity; import org.apache.ambari.server.orm.entities.AlertHistoryEntity; import javax.persistence.EntityManager; import javax.persistence.NoResultException; import javax.persistence.TypedQuery; import java.util.Collections; import java.util.List; @Singleton public class AdminClusterDAO { @Inject private Provider\u0026lt;EntityManager\u0026gt; m_entityManagerProvider; @RequiresSession public List\u0026lt;AdminClusterHostEntity\u0026gt; findAll() { TypedQuery\u0026lt;AdminClusterHostEntity\u0026gt; query = m_entityManagerProvider.get().createQuery( \u0026quot;SELECT ac FROM AdminClusterHostEntity ac\u0026quot;, AdminClusterHostEntity.class); try { return query.getResultList(); } catch (NoResultException e) { return Collections.emptyList(); } } }  5.æ³¨å…¥ç›¸å…³ AmbariServerç±»é‡Œä¹Ÿéœ€è¦ç›¸åº”æ³¨å…¥ç±»ä¾èµ–çš„å¯¹è±¡ï¼Œä¸€ç§æ–¹å¼æ˜¯æ‰‹åŠ¨æ³¨å…¥ï¼Œä¾‹å¦‚ï¼š\nermissionResourceProvider.init(injector.getInstance(PermissionDAO.class)); ViewPermissionResourceProvider.init(injector.getInstance(PermissionDAO.class)); PrivilegeResourceProvider.init(injector.getInstance(PrivilegeDAO.class), injector.getInstance(UserDAO.class), injector.getInstance(GroupDAO.class), injector.getInstance(PrincipalDAO.class), injector.getInstance(PermissionDAO.class), injector.getInstance(ResourceDAO.class));  è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯æ³¨è§£æ³¨å…¥ï¼Œå‚è€ƒorg.apache.ambari.server.controller.ControllerModule\nAmbariæ³¨å…¥è¿™å—æ¯”è¾ƒè¿·ï¼Œæ¯”å¦‚daoé‡Œç”¨åˆ°çš„m_entityManagerProviderå¯¹è±¡å°±ä¸éœ€è¦æ‰‹åŠ¨æ³¨å…¥ï¼Œåœ¨å®ƒåŸæœ‰çš„ç±»é‡Œä½¿ç”¨æ–°åŠ çš„daoä¹Ÿä¸éœ€è¦æ‰‹åŠ¨æ³¨å…¥ã€‚ä½†æ˜¯æœ‰äº›è‡ªå·±å†™çš„ResourceProvideré‡Œå°±éœ€è¦æ³¨å…¥ã€‚\n6.postmanæ¨¡æ‹ŸéªŒè¯ è¯·æ±‚\ncurl --location --request GET 'http://10.180.210.146:8080/api/v1/hdfs?fields=Hdfses/*' \\ --header 'Content-Typ: application/x-www-form-urlencoded; charset=UTF-8' \\ --header 'Cookie: AMBARISESSIONID=node0qm8s4v2muk61199wsf0jqgmg1.node0' \\ --header 'X-Requested-By: X-Requested-By' \\ --data-raw ''  è¿”å›\n{ \u0026quot;href\u0026quot; : \u0026quot;http://10.180.210.146:8080/api/v1/hdfs?fields=Hdfses/*\u0026quot;, \u0026quot;items\u0026quot; : [ { \u0026quot;href\u0026quot; : \u0026quot;http://10.180.210.146:8080/api/v1/hdfs/0\u0026quot;, \u0026quot;Hdfses\u0026quot; : { \u0026quot;hdfs_id\u0026quot; : 0, \u0026quot;hdfs_path\u0026quot; : \u0026quot;path0\u0026quot;, \u0026quot;hdfs_size\u0026quot; : 0 } }, { \u0026quot;href\u0026quot; : \u0026quot;http://10.180.210.146:8080/api/v1/hdfs/1\u0026quot;, \u0026quot;Hdfses\u0026quot; : { \u0026quot;hdfs_id\u0026quot; : 1, \u0026quot;hdfs_path\u0026quot; : \u0026quot;path1\u0026quot;, \u0026quot;hdfs_size\u0026quot; : 100 } }, { \u0026quot;href\u0026quot; : \u0026quot;http://10.180.210.146:8080/api/v1/hdfs/2\u0026quot;, \u0026quot;Hdfses\u0026quot; : { \u0026quot;hdfs_id\u0026quot; : 2, \u0026quot;hdfs_path\u0026quot; : \u0026quot;path2\u0026quot;, \u0026quot;hdfs_size\u0026quot; : 200 } } ] }  è¯·æ±‚å¿…é¡»å¸¦ä¸Š?fields=Hdfses/*,è¡¨ç¤ºå±•ç¤ºæ‰€æœ‰å­—æ®µï¼Œå¦åˆ™æŸ¥è¯¢ç»“æœæ˜¯æ˜¾ç¤ºä¸å®Œæ•´çš„ã€‚\n7.è‡ªç”±é£æ ¼Controller ä¹Ÿå¯ä»¥æŠ›å¼€ambariçš„è§„åˆ™ï¼Œè‡ªç”±ä½¿ç”¨javax.wsé£æ ¼ã€‚\nä½†è¿™æ ·å°±æ²¡æ³•ä½¿ç”¨Ambariå†…ç½®çš„æƒé™å’Œè°“è¯é£æ ¼URLæŸ¥è¯¢äº†\n8.å¼‚å¸¸å’Œå‚æ•°æ ¡éªŒ å‚æ•°æ ¡éªŒåœ¨ResourceProvideré‡Œï¼ŒæŠ›å‡ºSystemExceptionå³å¯è¿”å›ç»™é¡µé¢\næƒé™å¼‚å¸¸\nif (!AuthorizationHelper.isAuthorized(resourceType, resourceId, RoleAuthorization.SERVICE_RUN_SERVICE_CHECK)) { throw new AuthorizationException(\u0026quot;The authenticated user is not authorized to execute service checks.\u0026quot;); }  ","date":"2020-10-13","permalink":"https://iminto.github.io/post/ambari%E9%87%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%9E%E7%8E%B0/","tags":["Java"],"title":"Ambarié‡Œè‡ªå®šä¹‰èµ„æºæ¨¡å—çš„å®ç°"},{"content":"æŒ‰æƒ¯ä¾‹ä¸ŠProsody è‡ªå·±çš„æ–‡æ¡£: https://prosody.im/doc/\nå®‰è£… ä½¿ç”¨centos8å®‰è£…\nyum install prosody dnf --enablerepo=PowerTools install lua-filesystem  å…¶å®ƒç‰ˆæœ¬linuxåˆ™æ— éœ€å•ç‹¬å®‰è£…lua-filesystemä¾èµ–ã€‚\né…ç½® ä¸»é…ç½®æ–‡ä»¶ prosody.cfg.lua ä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹ã€‚\nä¸‹é¢å†™äº›å’±åšçš„ä¿®æ”¹ğŸ˜‚\n åœ¨ modules_enabled ä¸­å–æ¶ˆå¯ç”¨ version å’Œ uptime æ¨¡å—ï¼Œé¡ºä¾¿å¯åŠ¨äº›å…¶ä»–çš„æ¨¡å—ï¼Œæ¯”å¦‚offlineã€‚ å¦‚æœéœ€è¦å…è®¸åœ¨å®¢æˆ·ç«¯ä¸Šæ³¨å†Œçš„è¯ï¼ŒæŠŠ allow_registration è®¾ç½®æˆ true ã€‚  å…¶å®ƒé…ç½®ä¿æŒé»˜è®¤å³å¯ã€‚\nå¦å¤–ä¸€ä¸ªé…ç½®æ–‡ä»¶å°±æ˜¯å…·ä½“å’ŒåŸŸåå¯¹åº”çš„é…ç½®æ–‡ä»¶äº†ï¼Œä½äº/etc/prosody/conf.dç›®å½•ä¸‹ æˆ‘çš„é…ç½®æ˜¯ï¼š baidecai.xyz.cfg.lua\nVirtualHost \u0026quot;baidecai.xyz\u0026quot; http_host = \u0026quot;www.baidecai.xyz\u0026quot; -- enabled = false -- Remove this line to enable this host -- Prosody will automatically search for a certificate and key -- in /etc/prosody/certs/ unless a path is manually specified -- in the config file, see https://prosody.im/doc/certificates ssl = { key = \u0026quot;/etc/prosody/cer/baidecai.xyz.key\u0026quot;; certificate = \u0026quot;/etc/prosody/cer/baidecai.xyz.crt\u0026quot;; protocol = \u0026quot;tlsv1_1+\u0026quot;; --- ä¸ºå®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ï¼ˆc2sï¼‰å’ŒæœåŠ¡å™¨åˆ°æœåŠ¡å™¨ï¼ˆs2sï¼‰æ‰“å¼€è®¤è¯ verify = { \u0026quot;peer\u0026quot;, \u0026quot;peer\u0026quot; }; ciphers = \u0026quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH\u0026quot;; dhparam = \u0026quot;/etc/prosody/certs/dh-1024.pem\u0026quot; } disco_items = { { \u0026quot;upload.baidecai.xyz\u0026quot; }, } Component \u0026quot;upload.baidecai.xyz\u0026quot; \u0026quot;http_upload\u0026quot; http_upload_file_size_limit = 1024000 http_upload_expire_after = 60 * 60 * 24 * 7 http_upload_path = \u0026quot;/uploaded/files\u0026quot; http_files_dir = \u0026quot;/uploaded/files\u0026quot;  ä¸ºäº†æ”¯æŒèŠå¤©ä¸­å‘é€æ–‡ä»¶ï¼Œæˆ‘åŠ å…¥äº†http_uploadæ¨¡å—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡å—æ¥è‡ªç¤¾åŒºï¼Œå¹¶ä¸æ˜¯prosodyè‡ªå¸¦çš„ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»ä¸‹è½½æ”¾å…¥prosodyçš„æ’ä»¶ç›®å½•ï¼ˆåœ¨è¿™ä¸ªé—®é¢˜ä¸Šï¼Œæˆ‘æŠ˜è…¾äº†å¥½å‡ å¤©æ‰æå®šï¼Œå®˜æ–¹æ–‡æ¡£æ²¡æœ‰è¯´æ¸…æ¥šï¼‰ï¼Œè¦ä¸ç„¶ä½ çš„xmppå°±æ²¡æ³•å‘æ–‡ä»¶äº†ï¼ŒåŠæ—¶å®¢æˆ·ç«¯æ”¯æŒå‘é€æ“ä½œä¹Ÿä¼šæŠ¥é”™ã€‚\nprosodyçš„æ’ä»¶ç›®å½•ä½ç½®å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹ï¼š\nprosodyctl about  ç¤¾åŒºæ’ä»¶ä¸‹è½½åœ°å€ï¼š https://hg.prosody.im/prosody-modules/file/tip è®°å¾—ç»™http_upload_pathèµ‹äºˆå¯å†™æƒé™ é‡å¯å³å¯ã€‚\næ³¨æ„  ç°åœ¨çš„xmpp clientåŸºæœ¬éƒ½ä¸å†æ”¯æŒéSSLç™»é™†äº†ï¼Œæ‰€ä»¥ä½ å¿…é¡»è¦æœ‰ä¸€ä¸ªè¯ä¹¦ã€‚ä¹Ÿå°±æ˜¯å‰æ–‡é…ç½®ä¸­çš„certificateå’Œkeyæ–‡ä»¶ï¼Œè¿™ä¸ªå¾ˆå¥½ç”³è¯·ï¼Œæ¨èç½‘å€ï¼š https://freessl.cn/ ã€‚ dhparamæ–‡ä»¶ç”ŸæˆæŒ‡ä»¤  openssl dhparam -out dh.pem 1024  å¦‚æœæ²¡å¼€å¯å…è®¸å®¢æˆ·ç«¯æ³¨å†Œçš„è¯ï¼Œç”¨ prosodyctl æ³¨å†Œè´¦æˆ·  prosodyctl adduser \u0026lt;JID\u0026gt;  åˆ°æ­¤ä¸ºæ­¢ï¼Œä½ å·²ç»æ‹¥æœ‰äº†ä¸€ä¸ªå¯ä»¥åŠ å¯†èŠå¤©ï¼Œå¯ä»¥å‘æ–‡ä»¶çš„xmpp serveräº†ã€‚\n","date":"2020-08-26","permalink":"https://iminto.github.io/post/prosody%E6%90%AD%E5%BB%BAxmpp%E6%9C%8D%E5%8A%A1%E5%99%A8/","tags":["Linux","é—²æ‰¯æ·¡"],"title":"Prosodyæ­å»ºxmppæœåŠ¡å™¨"},{"content":"k8s rest apiå¯¹rcã€svcã€ingressã€podã€deploymentç­‰éƒ½æä¾›çš„watchæ¥å£ï¼Œå¯ä»¥å®æ—¶çš„ç›‘å¬åº”ç”¨éƒ¨ç½²çŠ¶æ€ã€‚\nåœ¨æ­¤ä¹‹å‰ç®€å•å…ˆè¯´ä¸€ä¸‹httpé•¿è¿æ¥\nåˆ†å—ä¼ è¾“ç¼–ç ï¼ˆChunked transfer encodingï¼‰ è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼‰ä¸­çš„ä¸€ç§æ•°æ®ä¼ è¾“æœºåˆ¶ï¼Œå…è®¸HTTPç”±åº”ç”¨æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯åº”ç”¨ï¼ˆ é€šå¸¸æ˜¯ç½‘é¡µæµè§ˆå™¨ï¼‰çš„æ•°æ®å¯ä»¥åˆ†æˆå¤šä¸ªéƒ¨åˆ†ã€‚åˆ†å—ä¼ è¾“ç¼–ç åªåœ¨HTTPåè®®1.1ç‰ˆæœ¬ï¼ˆHTTP/1.1ï¼‰ä¸­æä¾›ã€‚ é€šå¸¸ï¼ŒHTTPåº”ç­”æ¶ˆæ¯ä¸­å‘é€çš„æ•°æ®æ˜¯æ•´ä¸ªå‘é€çš„ï¼ŒContent-Lengthæ¶ˆæ¯å¤´å­—æ®µè¡¨ç¤ºæ•°æ®çš„é•¿åº¦ã€‚æ•°æ®çš„é•¿åº¦å¾ˆé‡è¦ï¼Œå› ä¸ºå®¢æˆ·ç«¯éœ€è¦çŸ¥é“å“ªé‡Œæ˜¯åº”ç­”æ¶ˆæ¯çš„ç»“æŸï¼Œä»¥åŠåç»­åº”ç­”æ¶ˆæ¯çš„å¼€å§‹ã€‚ç„¶è€Œï¼Œä½¿ç”¨åˆ†å—ä¼ è¾“ç¼–ç ï¼Œæ•°æ®åˆ†è§£æˆä¸€ç³»åˆ—æ•°æ®å—ï¼Œå¹¶ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªå—å‘é€ï¼Œè¿™æ ·æœåŠ¡å™¨å¯ä»¥å‘é€æ•°æ®è€Œä¸éœ€è¦é¢„å…ˆçŸ¥é“å‘é€å†…å®¹çš„æ€»å¤§å°ã€‚é€šå¸¸æ•°æ®å—çš„å¤§å°æ˜¯ä¸€è‡´çš„ï¼Œä½†ä¹Ÿä¸æ€»æ˜¯è¿™ç§æƒ…å†µã€‚\nTransfer-Encoding æ¶ˆæ¯é¦–éƒ¨æŒ‡æ˜äº†å°† entity å®‰å…¨ä¼ é€’ç»™ç”¨æˆ·æ‰€é‡‡ç”¨çš„ç¼–ç å½¢å¼ã€‚\nTransfer-Encoding æ˜¯ä¸€ä¸ªé€è·³ä¼ è¾“æ¶ˆæ¯é¦–éƒ¨ï¼Œå³ä»…åº”ç”¨äºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ï¼Œè€Œä¸æ˜¯æ‰€è¯·æ±‚çš„èµ„æºæœ¬èº«ã€‚ä¸€ä¸ªå¤šèŠ‚ç‚¹è¿æ¥ä¸­çš„æ¯ä¸€æ®µéƒ½å¯ä»¥åº”ç”¨ä¸åŒçš„Transfer-Encoding å€¼ã€‚å¦‚æœä½ æƒ³è¦å°†å‹ç¼©åçš„æ•°æ®åº”ç”¨äºæ•´ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ç«¯åˆ°ç«¯ä¼ è¾“æ¶ˆæ¯é¦–éƒ¨ Content-Encoding ã€‚\nå½“è¿™ä¸ªæ¶ˆæ¯é¦–éƒ¨å‡ºç°åœ¨ HEAD è¯·æ±‚çš„å“åº”ä¸­ï¼Œè€Œè¿™æ ·çš„å“åº”æ²¡æœ‰æ¶ˆæ¯ä½“ï¼Œé‚£ä¹ˆå®ƒå…¶å®æŒ‡çš„æ˜¯åº”ç”¨åœ¨ç›¸åº”çš„ GET è¯·æ±‚çš„åº”ç­”çš„å€¼ã€‚\næŒ‡ä»¤ chunked æ•°æ®ä»¥ä¸€ç³»åˆ—åˆ†å—çš„å½¢å¼è¿›è¡Œå‘é€ã€‚ Content-Length é¦–éƒ¨åœ¨è¿™ç§æƒ…å†µä¸‹ä¸è¢«å‘é€ã€‚ã€‚åœ¨æ¯ä¸€ä¸ªåˆ†å—çš„å¼€å¤´éœ€è¦æ·»åŠ å½“å‰åˆ†å—çš„é•¿åº¦ï¼Œä»¥åå…­è¿›åˆ¶çš„å½¢å¼è¡¨ç¤ºï¼Œåé¢ç´§è·Ÿç€ \u0026lsquo;\\r\\n\u0026rsquo; ï¼Œä¹‹åæ˜¯åˆ†å—æœ¬èº«ï¼Œåé¢ä¹Ÿæ˜¯'\\r\\n' ã€‚ç»ˆæ­¢å—æ˜¯ä¸€ä¸ªå¸¸è§„çš„åˆ†å—ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶é•¿åº¦ä¸º0ã€‚ç»ˆæ­¢å—åé¢æ˜¯ä¸€ä¸ªæŒ‚è½½ï¼ˆtrailerï¼‰ï¼Œç”±ä¸€ç³»åˆ—ï¼ˆæˆ–è€…ä¸ºç©ºï¼‰çš„å®ä½“æ¶ˆæ¯é¦–éƒ¨æ„æˆã€‚\nåˆ†å—ç¼–ç  åˆ†å—ç¼–ç ä¸»è¦åº”ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼Œå³è¦ä¼ è¾“å¤§é‡çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨è¯·æ±‚åœ¨æ²¡æœ‰è¢«å¤„ç†å®Œä¹‹å‰å“åº”çš„é•¿åº¦æ˜¯æ— æ³•è·å¾—çš„ã€‚ä¾‹å¦‚ï¼Œå½“éœ€è¦ç”¨ä»æ•°æ®åº“ä¸­æŸ¥è¯¢è·å¾—çš„æ•°æ®ç”Ÿæˆä¸€ä¸ªå¤§çš„HTMLè¡¨æ ¼çš„æ—¶å€™ï¼Œæˆ–è€…éœ€è¦ä¼ è¾“å¤§é‡çš„å›¾ç‰‡çš„æ—¶å€™ã€‚ä¸€ä¸ªåˆ†å—å“åº”å½¢å¼å¦‚ä¸‹ï¼š\nHTTP/1.1 200 OK Content-Type: text/plain Transfer-Encoding: chunked 7\\r\\n Mozilla\\r\\n 9\\r\\n Developer\\r\\n 7\\r\\n Network\\r\\n 0\\r\\n \\r\\n  HTTP 1.1å¼•å…¥åˆ†å—ä¼ è¾“ç¼–ç æä¾›äº†ä»¥ä¸‹å‡ ç‚¹å¥½å¤„ï¼š\n HTTPåˆ†å—ä¼ è¾“ç¼–ç å…è®¸æœåŠ¡å™¨ä¸ºåŠ¨æ€ç”Ÿæˆçš„å†…å®¹ç»´æŒHTTPæŒä¹…è¿æ¥ã€‚é€šå¸¸ï¼ŒæŒä¹…é“¾æ¥éœ€è¦æœåŠ¡å™¨åœ¨å¼€å§‹å‘é€æ¶ˆæ¯ä½“å‰å‘é€Content-Lengthæ¶ˆæ¯å¤´å­—æ®µï¼Œä½†æ˜¯å¯¹äºåŠ¨æ€ç”Ÿæˆçš„å†…å®¹æ¥è¯´ï¼Œåœ¨å†…å®¹åˆ›å»ºå®Œä¹‹å‰æ˜¯ä¸å¯çŸ¥çš„ã€‚[åŠ¨æ€å†…å®¹ï¼Œcontent-lengthæ— æ³•é¢„çŸ¥] åˆ†å—ä¼ è¾“ç¼–ç å…è®¸æœåŠ¡å™¨åœ¨æœ€åå‘é€æ¶ˆæ¯å¤´å­—æ®µã€‚å¯¹äºé‚£äº›å¤´å­—æ®µå€¼åœ¨å†…å®¹è¢«ç”Ÿæˆä¹‹å‰æ— æ³•çŸ¥é“çš„æƒ…å½¢éå¸¸é‡è¦ï¼Œä¾‹å¦‚æ¶ˆæ¯çš„å†…å®¹è¦ä½¿ç”¨æ•£åˆ—è¿›è¡Œç­¾åï¼Œæ•£åˆ—çš„ç»“æœé€šè¿‡HTTPæ¶ˆæ¯å¤´å­—æ®µè¿›è¡Œä¼ è¾“ã€‚æ²¡æœ‰åˆ†å—ä¼ è¾“ç¼–ç æ—¶ï¼ŒæœåŠ¡å™¨å¿…é¡»ç¼“å†²å†…å®¹ç›´åˆ°å®Œæˆåè®¡ç®—å¤´å­—æ®µçš„å€¼å¹¶åœ¨å‘é€å†…å®¹å‰å‘é€è¿™äº›å¤´å­—æ®µçš„å€¼ã€‚[æ•£åˆ—ç­¾åï¼Œéœ€ç¼“å†²å®Œæˆæ‰èƒ½è®¡ç®—] HTTPæœåŠ¡å™¨æœ‰æ—¶ä½¿ç”¨å‹ç¼© ï¼ˆgzipæˆ–deflateï¼‰ä»¥ç¼©çŸ­ä¼ è¾“èŠ±è´¹çš„æ—¶é—´ã€‚åˆ†å—ä¼ è¾“ç¼–ç å¯ä»¥ç”¨æ¥åˆ†éš”å‹ç¼©å¯¹è±¡çš„å¤šä¸ªéƒ¨åˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå—ä¸æ˜¯åˆ†åˆ«å‹ç¼©çš„ï¼Œè€Œæ˜¯æ•´ä¸ªè´Ÿè½½è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©çš„è¾“å‡ºä½¿ç”¨æœ¬æ–‡æè¿°çš„æ–¹æ¡ˆè¿›è¡Œåˆ†å—ä¼ è¾“ã€‚åœ¨å‹ç¼©çš„æƒ…å½¢ä¸­ï¼Œåˆ†å—ç¼–ç æœ‰åˆ©äºä¸€è¾¹è¿›è¡Œå‹ç¼©ä¸€è¾¹å‘é€æ•°æ®ï¼Œè€Œä¸æ˜¯å…ˆå®Œæˆå‹ç¼©è¿‡ç¨‹ä»¥å¾—çŸ¥å‹ç¼©åæ•°æ®çš„å¤§å°ã€‚[gzipå‹ç¼©ï¼Œå‹ç¼©ä¸ä¼ è¾“åŒæ—¶è¿›è¡Œ]  ä¸€èˆ¬æƒ…å†µHTTPçš„HeaderåŒ…å«Content-LengthåŸŸæ¥æŒ‡æ˜æŠ¥æ–‡ä½“çš„é•¿åº¦ã€‚æœ‰æ—¶å€™æœåŠ¡ç”ŸæˆHTTPå›åº”æ˜¯æ— æ³•ç¡®å®šæ¶ˆæ¯å¤§å°çš„ï¼Œæ¯”å¦‚å¤§æ–‡ä»¶çš„ä¸‹è½½ï¼Œæˆ–è€…åå°éœ€è¦å¤æ‚çš„é€»è¾‘æ‰èƒ½å…¨éƒ¨å¤„ç†é¡µé¢çš„è¯·æ±‚ï¼Œè¿™æ—¶ç”¨éœ€è¦å®æ—¶ç”Ÿæˆæ¶ˆæ¯é•¿åº¦ï¼ŒæœåŠ¡å™¨ä¸€èˆ¬ä½¿ç”¨chunkedç¼–ç \nåŸç† k8sæä¾›çš„watchåŠŸèƒ½æ˜¯å»ºç«‹åœ¨å¯¹etcdçš„watchä¹‹ä¸Šçš„ï¼Œå½“etcdçš„key-valueå‡ºç°å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥kube-apiserverï¼Œè¿™é‡Œçš„Key-vlaueå…¶å®å°±æ˜¯k8sèµ„æºçš„æŒä¹…åŒ–ã€‚\næ—©æœŸçš„k8sæ¶æ„ä¸­ï¼Œkube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyï¼Œéƒ½æ˜¯ç›´æ¥å»watch etcdçš„ï¼Œè¿™æ ·å°±é€ æˆetcdçš„è¿æ¥æ•°å¤ªå¤§ï¼ˆèŠ‚ç‚¹æˆåƒä¸Šä¸‡æ—¶ï¼‰ï¼Œå¯¹etcdå‹åŠ›å¤ªå¤§ï¼Œæµªè´¹èµ„æºï¼Œå› æ­¤åˆ°äº†åé¢ï¼Œåªæœ‰kube-apiserverå»watch etcdï¼Œè€Œkube-apiserverå¯¹å¤–æä¾›watch apiï¼Œä¹Ÿå°±æ˜¯kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyå»watch kube-apiserverï¼Œè¿™æ ·å¤§å¤§å‡å°äº†etcdçš„å‹åŠ›\nWatch API é€šè¿‡k8s å®˜ç½‘ rest apiçš„æè¿°ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒWatch APIå®é™…ä¸Šä¸€ä¸ªæ ‡å‡†çš„HTTP GETè¯·æ±‚ï¼Œæˆ‘ä»¬ä»¥Podçš„Watch APIä¸ºä¾‹\nHTTP Request GET /api/v1/watch/namespaces/{namespace}/pods Path Parameters Parameter Description namespace object name and auth scope, such as for teams and projects Query Parameters Parameter Description fieldSelector A selector to restrict the list of returned objects by their fields. Defaults to everything. labelSelector A selector to restrict the list of returned objects by their labels. Defaults to everything. pretty If â€˜trueâ€™, then the output is pretty printed. resourceVersion When specified with a watch call, shows changes that occur after that particular version of a resource. Defaults to changes from the beginning of history. When specified for list: - if unset, then the result is returned from remote storage based on quorum-read flag; - if itâ€™s 0, then we simply return what we currently have in cache, no guarantee; - if set to non zero, then the result is at least as fresh as given rv. timeoutSeconds Timeout for the list/watch call. watch Watch for changes to the described resources and return them as a stream of add, update, and remove notifications. Specify resourceVersion. Response Code Description 200 WatchEvent OK  ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºWatchå…¶å®å°±æ˜¯ä¸€ä¸ªGETè¯·æ±‚ï¼Œå’Œä¸€èˆ¬è¯·æ±‚ä¸åŒçš„æ˜¯ï¼Œå®ƒæœ‰ä¸€ä¸ªwatchçš„query parameterï¼Œä¹Ÿå°±æ˜¯kube-apiserveræ¥åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œå½“å‘ç°query parameteré‡Œé¢åŒ…å«watchï¼Œå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªWatch APIï¼Œwatchå‚æ•°é»˜è®¤ä¸ºtrueã€‚\n==è¿”å›å€¼æ˜¯200å’ŒWatchEventã€‚apiserveré¦–å…ˆä¼šè¿”å›ä¸€ä¸ª200çš„çŠ¶æ€ç ï¼Œå»ºç«‹é•¿è¿æ¥ï¼Œç„¶åä¸æ–­çš„è¿”å›watch event==\næºç  åŸç†éƒ½è®²å®Œäº†ï¼Œç°åœ¨åˆ°æºç äº†ï¼Œå¾ˆç®€å•ã€‚\nOkHttpClient client = makeSSLClient(); Request request = new Request.Builder() .url(\u0026quot;https://10.1.1.11:6443/api/v1/watch/namespaces/default/pods\u0026quot;) .addHeader(\u0026quot;Authorization\u0026quot;,\u0026quot;Bearer \u0026quot;+\u0026quot;eyJhbGciOiBnlQ\u0026quot;) .get() .build(); client.newCall(request).enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { log.info(\u0026quot;Watch connection failed. reason: {}\u0026quot;, e.getMessage()); } @Override public void onResponse(Call call, Response response) throws IOException { if (!response.isSuccessful()) { log.info(\u0026quot;!response.isSuccessful() {}\u0026quot;, response.code()); } try { BufferedSource source = response.body().source(); while (!source.exhausted()) { String message = source.readUtf8LineStrict(); log.info(message); } } catch (Exception e) { log.info(\u0026quot;Watch terminated unexpectedly. reason: {}\u0026quot;, e.getMessage()); } } });  å‰©ä¸‹çš„å°±å¾…è‡ªå·±å®Œå–„äº†ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼š\n k8sæä¾›çš„restful APIåœ¨æ­¤å¤„å¹¶ä¸æ˜¯ç½‘ä¸Šå¸¸è¯´çš„HTTP2åè®®ï¼Œå®ƒå°±æ˜¯HTTP 1.1 é•¿è¿æ¥ è¦æ³¨æ„http connectionçš„è¶…æ—¶ï¼Œè¿™é‡Œæ˜¯é•¿è¿æ¥ï¼Œè¶…æ—¶åº”è¯¥æ˜¯-1  å¦‚æœæ˜¯Java k8s clientï¼Œå¯ä»¥ä½¿ç”¨fabric8çš„watchæœºåˆ¶ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š\nKubernetesClient client = new DefaultKubernetesClient(config);//ä½¿ç”¨é»˜è®¤çš„å°±è¶³å¤Ÿäº† //ç”±äº4.10.2ç‰ˆæœ¬æœ‰ä¸ªå½±å“eventsä½¿ç”¨çš„å›å½’bugï¼Œæš‚æ—¶å›é€€åˆ°4.9.2ç‰ˆæœ¬ã€‚è¯¦æƒ…è§å®˜ç½‘issue#2328 //4.10.3å·²ä¿®å¤ client.v1().events().inAnyNamespace().watch(new Watcher\u0026lt;Event\u0026gt;() { @Override public void eventReceived(Action action, Event resource) { log.info(\u0026quot;event {} resource:{}\u0026quot; , action.name(),resource.toString()); redisService.lSet(\u0026quot;k8sevent\u0026quot;,resource,3600*24*5); } @Override public void onClose(KubernetesClientException cause) { log.info(\u0026quot;Watcher close due to {}\u0026quot; , cause); } });  å…¶æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨çš„restful APIã€‚\n","date":"2020-08-11","permalink":"https://iminto.github.io/post/%E5%9F%BA%E4%BA%8Erestfulapi%E5%AE%9E%E7%8E%B0k8s%E7%9A%84%E7%9B%91%E5%90%AC%E6%9C%BA%E5%88%B6/","tags":["k8s"],"title":"åŸºäºrestfulAPIå®ç°k8sçš„ç›‘å¬æœºåˆ¶"},{"content":"helm3é›†æˆminioæ­å»ºç§æœ‰ä»“åº“ æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä»æœ¬åœ°çš„ç›®å½•ç»“æ„ä¸­çš„chartå»è¿›è¡Œéƒ¨ç½²ï¼Œå¦‚æœè¦é›†ä¸­ç®¡ç†chart,å°±éœ€è¦æ¶‰åŠåˆ°repositoryçš„é—®é¢˜å¯ä»¥é€šè¿‡minioå»ºç«‹ä¸€ä¸ªç§æœ‰çš„å­˜æ”¾ä»“åº“ã€‚\nminioå®‰è£… å®‰è£…è¿‡ç¨‹ç•¥å»ï¼Œç›´æ¥ä¸‹è½½æ‰§è¡Œæ–‡ä»¶å³å¯\n.\\minio.exe server g:/tmp/  é…ç½®mc\nmc config host add minio http://192.168.1.51 BKIKJAA5BMMU2RHO6IBB V7f1CwQqAcwo80UEIJEjc5gVQUSSx5ohQ9GSrr12  ä»“åº“åˆ›å»º helm create helm-chart helm package ./helm-chart --debug #æ„å»ºç´¢å¼• helm repo index ./  æ¥ä¸‹æ¥æ˜¯å¤åˆ¶ç”Ÿæˆçš„index.yamlåˆ°minioä¸­\n.\\mc.exe policy set download minio/data .\\mc.exe cp G:\\data\\project\\helm\\index.yaml minio/data/  åˆ°è¿™ä¸€æ­¥åŸºæœ¬å°±å¿«å¥½äº†ï¼Œç„¶å\nhelm repo add mi http://10.180.204.129:9000/data/ helm repo list  æœ€ç»ˆå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼Œè¯´æ˜æ·»åŠ ä»“åº“æˆåŠŸï¼š\nPS G:\\data\\project\\helm\u0026gt; helm repo list NAME URL stable https://kubernetes-charts.storage.googleapis.com/ mi http://10.180.204.129:9000/data/ PS G:\\data\\project\\helm\u0026gt;  æœç´¢ä¸‹\nPS G:\\tmp\\data\u0026gt; helm search repo mi/helm-chart NAME CHART VERSION APP VERSION DESCRIPTION mi/helm-chart 0.2.0 1.16.4 A Helm chart for Kubernetes  ä¹Ÿèƒ½æœåˆ°æ–°åŠ çš„Chartï¼Œå®Œå·¥ã€‚\næ³¨æ„ 1.minioè™½ç„¶æ˜¯ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡æœåŠ¡å™¨ï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒç›´æ¥åœ¨OSæ–‡ä»¶ç³»ç»Ÿä¸‹çš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç›´æ¥åœ¨æ–‡ä»¶å¤¹ä¸Šçš„æ“ä½œä¼šåŒæ­¥åˆ°minioçš„æ•°æ®åº“ä¸­ã€‚æ­¤å‰ä¸€ç›´é¡¾è™‘minioè¿™ç§æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦é€‚åˆç”¨æ¥åšrepoï¼Œå…¶å®æ˜¯å¤šè™‘çš„ã€‚\n2.å®˜ç½‘ https://helm.sh/docs/topics/chart_repository/ çš„helmä»“åº“æ ¼å¼å¦‚ä¸‹ï¼Œå…¸å‹çš„tgz+index.yamlæ ¼å¼\ncharts/ | |- index.yaml | |- alpine-0.1.2.tgz | |- alpine-0.1.2.tgz.prov  ç„¶è€Œï¼Œhelmå®‰è£…æ˜¯æ”¯æŒæ–‡ä»¶å¤¹æ ¼å¼çš„åŒ…è·¯å¾„ï¼Œæ‰€ä»¥æœ‰äº›åº”ç”¨å•†åº—å¦‚rancherå†…ç½®äº†ä¸€äº›ä»“åº“æ˜¯git+æ–‡ä»¶å¤¹æ ¼å¼çš„ç»„ç»‡ç»“æ„ï¼Œè¿™ä¸æ˜¯æ ‡å‡†çš„helmä»“åº“ï¼Œä½†æ˜¯ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œåªæ˜¯ä¸èƒ½è¢«helm repo addè€Œå·²ã€‚è¿™æ ·çš„ä»“åº“éœ€è¦ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶å¤¹åˆ°ä¸´æ—¶ç›®å½•å†è°ƒç”¨helmå®‰è£…ã€‚\n3.å¦‚æœä½ å‘å¸ƒäº†ä¸¤ä¸ªç‰ˆæœ¬çš„chartåŒ…ï¼Œä¹Ÿupdateäº†ï¼Œä½†æ˜¯ä»“åº“é»˜è®¤åªèƒ½æœåˆ°é«˜ç‰ˆæœ¬çš„ã€‚éœ€è¦è¿™ä¹ˆåš\nPS G:\\tmp\\data\u0026gt; helm search repo mi/helm-chart --versions NAME CHART VERSION APP VERSION DESCRIPTION mi/helm-chart 0.2.0 1.16.4 A Helm chart for Kubernetes mi/helm-chart 0.1.0 1.16.0 A Helm chart for Kubernetes  å®‰è£…\nhelm install mi/helm-chart --version 0.1.0  ","date":"2020-07-03","permalink":"https://iminto.github.io/post/helm%E9%9B%86%E6%88%90minio%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/","tags":["k8s"],"title":"Helmé›†æˆminioæ­å»ºç§æœ‰ä»“åº“"},{"content":"åœ¨åç«¯é¡¹ç›®ä¸­ï¼Œéš¾å…é‡åˆ°éœ€è¦å†™æ¥å£æ–‡æ¡£æ–¹ä¾¿ç¬¬ä¸‰æ–¹è°ƒç”¨çš„åœºæ™¯ï¼Œä¸€èˆ¬ä¸šç•Œæœ€å¸¸ç”¨çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨swaggerã€‚Javaé¡¹ç›®ä¸­ï¼Œä¸€èˆ¬é‡‡ç”¨springfoxé¡¹ç›®ï¼Œå®ƒé›†æˆäº†swaggerå’Œswagger-uiï¼Œä¸éœ€è¦å•ç‹¬éƒ¨ç½²é¡¹ç›®ï¼Œå¯è®©æ–‡æ¡£éšç€é¡¹ç›®ä¸€èµ·å‘å¸ƒã€‚\nä½†æ˜¯å¼€æºé¡¹ç›®å¾€å¾€æ˜¯å¼€æºä¸€æ—¶çƒ­ï¼Œäº‹åæ‹‚è¡£å»ï¼Œç¼ºå°‘ç»´æŠ¤ã€‚è¿™ä¸ªé¡¹ç›®å·²ç»ä¸¤å¹´å¤šæ²¡æœ‰ç»´æŠ¤äº†ï¼Œå¾ˆå¤šäººåœ¨issueåé¦ˆè¿‡bugï¼Œä½œè€…ä¸€å¹´å‰è¡¨ç¤ºè‡ªå·±æ¯”è¾ƒå¿™ï¼Œæ²¡ç©ºç»´æŠ¤ã€‚\nspringfoxæœ€æ–°çš„ç‰ˆæœ¬æ˜¯2.9.2ï¼Œä¸æ”¯æŒspring5ï¼ˆè™½ç„¶æœ‰ä¸ªå¿«ç…§ç‰ˆæ”¯æŒspring5ï¼Œä½†ä¸€ç›´æ²¡å‘å¸ƒï¼Œæ•´åˆä¹Ÿæœ‰ç‚¹éº»çƒ¦ï¼‰ã€‚spring5æ¯”è¾ƒå¤§çš„ä¸€ä¸ªæ”¹å˜å°±æ˜¯å¢åŠ äº†webfluxï¼Œå› æ­¤æ—§ç‰ˆspringfoxæ— æ³•å…¼å®¹spring5çš„ã€‚\nå…¶å®ç”¨å¿«ç…§ç‰ˆï¼Œç¨ä½œä¿®æ”¹ä¹Ÿèƒ½è®©springfoxæ”¯æŒwebfluxï¼Œä½†æ˜¯æˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢è¿™ç§åšæ³•ã€‚ä¸€ä¸ªæ˜¯å¢åŠ äº†æ‰“åŒ…ä½“ç§¯å’Œè¿è¡Œå†…å­˜å ç”¨ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯swaggerçš„ä½¿ç”¨æ±¡æŸ“äº†Javaæºç ï¼Œå¾ˆæ˜¯ä¸ç¾è§‚ï¼Œå¼ºè¿«ç—‡ä¸èƒ½å¿ã€‚\n@RestController @RequestMapping(\u0026quot;/dataspace/api/v1/hive\u0026quot;) @Api(value = \u0026quot;hive\u0026quot;, description = \u0026quot;hiveèµ„æºç®¡ç†\u0026quot;) public class HiveManagerController { @Autowired HiveManagerService hiveManagerService; @RequestMapping(value = \u0026quot;/list\u0026quot;, method = {RequestMethod.POST}) @ApiOperation(value = \u0026quot;èµ„æºåˆ—è¡¨\u0026quot;, notes = \u0026quot;\u0026quot;) public PageResult\u0026lt;HiveVO\u0026gt; showPublic(@ApiParam(value = \u0026quot;hiveæŸ¥è¯¢å¯¹è±¡\u0026quot;) @RequestBody PageReqParam\u0026lt;HiveReq\u0026gt; hiveReq) { PageResult\u0026lt;HiveVO\u0026gt; result = new PageResult\u0026lt;\u0026gt;(); if (hiveReq.getReqParam() == null) { result.setCode(-1); result.setMsg(\u0026quot;å‚æ•°ä¸å®Œæ•´\u0026quot;); return result; } if (hiveReq.getPageSize() \u0026gt; 50 || hiveReq.getPageSize() \u0026lt; 0) { result.setCode(-1); result.setMsg(\u0026quot;é¡µç éæ³•\u0026quot;); return result; } result = hiveManagerService.getList(hiveReq); return result; }  æºç ä¸­æ··å…¥äº†å„ç§ApiParamã€Apiã€ApiOperationæ³¨è§£ã€‚\nå†åŠ ä¸Šæˆ‘ç°åœ¨ä½¿ç”¨çš„springcloudå¥—ä»¶ï¼Œéœ€è¦åœ¨gatewayçš„feignæ¥å£ä¸ŠåŠ æ³¨é‡Šï¼Œè¿™æ ·çš„è¯ï¼Œæ— è®ºæ˜¯springfoxï¼Œè¿˜æ˜¯å¾ˆå¤šç¬¬ä¸‰æ–¹çš„api docå·¥å…·éƒ½å¾ˆéš¾èƒœä»»ã€‚\näºæ˜¯ï¼Œæˆ‘æƒ³åˆ°äº†å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯javadocã€‚ç„¶è€Œjavadocè‡ªå¸¦çš„æ³¨è§£å¾ˆæœ‰é™ï¼Œä¸èƒ½æ»¡è¶³ç¬¬ä¸‰æ–¹å¯¹æ–‡æ¡£çš„éœ€æ±‚ï¼Œæ¯”å¦‚\n/** * æ ¹æ®èŠ‚ç‚¹ååˆ é™¤ä¸»æœº * @method DELETE * @path host/delHostByNodeName * @param nodeName èŠ‚ç‚¹å * @param cluster é›†ç¾¤å * @return JSON */ @DeleteMapping(\u0026quot;/delHostByNodeName\u0026quot;) public String delHostByNodeName(@RequestParam(\u0026quot;nodeName\u0026quot;) String nodeName,@RequestParam(\u0026quot;cluster\u0026quot;) String cluster);  javadocå¹¶ä¸è®¤è¯†methodå’Œpathè¿™ä¸¤ä¸ªæ ‡ç­¾ï¼Œç”Ÿæˆçš„æ–‡æ¡£è¿˜æ˜¯ç¼ºå°‘ä¸€äº›å¿…é¡»è¦çš„ä¿¡æ¯ã€‚\nè¿™ä¸ªä¸éš¾ï¼Œæ‰©å±•ä¸‹tagletå³å¯ã€‚\nå…ˆå¼•å…¥mavenä¾èµ–\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;jdk.tools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jdk.tools\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;system\u0026lt;/scope\u0026gt; \u0026lt;systemPath\u0026gt;${JAVA_HOME}/lib/tools.jar\u0026lt;/systemPath\u0026gt; \u0026lt;/dependency\u0026gt;  æ‰©å±•tagletä»£ç \npackage com.github.cloud.ali.common.tool; import com.sun.javadoc.Tag; import com.sun.tools.doclets.Taglet; import java.util.Map; public class MethodTaglet implements Taglet { private String NAME = \u0026quot;HTTPè¯·æ±‚ç±»å‹\u0026quot;; private String HEADER = \u0026quot;HTTPè¯·æ±‚ç±»å‹:\u0026quot;; @Override public boolean inField() { return false; } @Override public boolean inConstructor() { return false; } @Override public boolean inMethod() { return true; } @Override public boolean inOverview() { return true; } @Override public boolean inPackage() { return true; } @Override public boolean inType() { return true; } @Override public boolean isInlineTag() { return false; } public static void register(Map tagletMap) { MethodTaglet tag = new MethodTaglet(); Taglet t = (Taglet) tagletMap.get(tag.getName()); if (t != null) { tagletMap.remove(tag.getName()); } tagletMap.put(tag.getName(), tag); } @Override public String getName() { return NAME; } @Override public String toString(Tag tag) { return \u0026quot;\u0026lt;DT\u0026gt;\u0026lt;B\u0026gt;\u0026quot; + HEADER + \u0026quot;\u0026lt;/B\u0026gt;\u0026lt;DD\u0026gt;\u0026quot; + \u0026quot;\u0026lt;table cellpadding=2 cellspacing=0\u0026gt;\u0026lt;tr\u0026gt;\u0026lt;td bgcolor=\\\u0026quot;yellow\\\u0026quot;\u0026gt;\u0026quot; + tag.text() + \u0026quot;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt;\u0026lt;/table\u0026gt;\u0026lt;/DD\u0026gt;\\n\u0026quot;; } @Override public String toString(Tag[] tags) { if (tags.length == 0) { return null; } String result = \u0026quot;\\n\u0026lt;DT\u0026gt;\u0026lt;B\u0026gt;\u0026quot; + HEADER + \u0026quot;\u0026lt;/B\u0026gt;\u0026lt;DD\u0026gt;\u0026quot;; result += \u0026quot;\u0026lt;table cellpadding=2 cellspacing=0\u0026gt;\u0026lt;tr\u0026gt;\u0026lt;td bgcolor=\\\u0026quot;yellow\\\u0026quot;\u0026gt;\u0026quot;; for (int i = 0; i \u0026lt; tags.length; i++) { if (i \u0026gt; 0) { result += \u0026quot;, \u0026quot;; } result += tags[i].text(); } return result + \u0026quot;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt;\u0026lt;/table\u0026gt;\u0026lt;/DD\u0026gt;\\n\u0026quot;; } }  åŒç†ï¼Œpathæ³¨è§£ä¹Ÿæ˜¯ç±»ä¼¼çš„å®ç°ã€‚ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š\njavadoc -protected -splitindex -use -author -version -encoding utf-8 -charset utf-8 -d /usr/jackma/doc -windowtitle \u0026quot;ali æ–‡æ¡£\u0026quot; $(ls /usr/jackma/ali/ali-common/src/main/java/com/github/cloud/ali/common/model/*.java |tr \u0026quot;\\n\u0026quot; \u0026quot; \u0026quot;) $(ls /usr/jackma/ali/ali-gateway/src/main/java/com/github/cloud/ali/feign/*.java |tr \u0026quot;\\n\u0026quot; \u0026quot; \u0026quot;) -tag methodğŸ…°ï¸\u0026quot;HTTPè¯·æ±‚æ–¹æ³•:\u0026quot; -tag pathğŸ…°ï¸\u0026quot;è¯·æ±‚è·¯å¾„:\u0026quot; -tagletpath /usr/jackma/ali/ali-common/src/main/java/com/github/cloud/ali/common/tool/MethodTaglet.java -tagletpath /usr/jackma/ali/ali-common/src/main/java/com/github/cloud/ali/common/tool/PathTaglet.java -taglet com.github.cloud.ali.common.tool.MethodTaglet -taglet com.github.cloud.ali.common.tool.PathTaglet  æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\nè¿˜å¯ä»¥è¿›ä¸€æ­¥ï¼ŒåŠ ä¸Šæ•°æ®ç±»å‹çš„æ³¨è§£ï¼Œè¿™æ ·å°±æ›´å®Œå–„äº†ã€‚\nè™½ç„¶ç¦»swagger-uiè¿˜æœ‰ç‚¹å·®è·ï¼Œä½†æ˜¯è¿˜æ˜¯æ¯”åŸç‰ˆjavadocå¥½å¤šäº†ã€‚æœ€å¤§çš„ä¼˜ç‚¹æ˜¯æ²¡æœ‰ä»»ä½•é™åˆ¶å’Œå¯¹æºç çš„æ±¡æŸ“ã€‚\nä¸å¾—ä¸è¯´ï¼ŒJavaçš„æ‰©å±•æ€§ä¸æ˜¯ç›–çš„ã€‚\n","date":"2020-05-12","permalink":"https://iminto.github.io/post/%E4%B8%80%E7%A7%8Dswagger-ui%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%E4%B8%8D%E5%BC%95%E5%85%A5%E4%BB%BB%E4%BD%95%E6%BA%90%E7%A0%81%E6%B1%A1%E6%9F%93/","tags":["Java"],"title":"ä¸€ç§swagger Uiçš„æ›¿ä»£æ–¹æ¡ˆä¸å¼•å…¥ä»»ä½•æºç æ±¡æŸ“"},{"content":"â€‹ è¿™ä¸ªé—®é¢˜çº ç»“æˆ‘å¿«ä¸€å¹´äº†ã€‚æŸæ¬¡manjaroå‡çº§åï¼Œæˆ‘çš„manjaroåœ¨ç³»ç»Ÿè‡ªå¸¦åº”ç”¨ä¸Šå¦‚konsole,kate,Yakuakeä¸Šéƒ½ä¸èƒ½åˆ‡æ¢è¾“å…¥æ³•ï¼ˆç›®æµ‹ç³»ç»Ÿè‡ªå¸¦çš„è½¯ä»¶éƒ½ä¸èƒ½ï¼‰ï¼Œé¼ æ ‡æ”¾é”®ç›˜å›¾æ ‡ä¸Šæç¤ºâ€œæ— è¾“å…¥çª—å£â€ã€‚ä½†æ˜¯æµè§ˆå™¨å’Œå…¶ä»–è½¯ä»¶æ˜¯å¯ä»¥çš„ã€‚è¿™ä¸ªé—®é¢˜ä¸æ˜¯å¤ªå½±å“ä½¿ç”¨ï¼Œå°±å¿äº†å¾ˆä¹…ï¼Œå¤§ä¸äº†å…¶ä»–åœ°æ–¹å†™å¥½äº†å†å¤åˆ¶åˆ°kateé‡Œï¼Œä½†æ˜¯å°±å¥½åƒè¡£æœä¸Šè½æ²¾äº†ä¸€å¨é»„æ³¥ï¼Œå§‹ç»ˆæ„Ÿè§‰ä¸çˆ½ï¼Œæ¯éš”ä¸€ä¸¤ä¸ªæœˆå°±è¦å°è¯•è§£å†³ä¸€æ¬¡ï¼Œå§‹ç»ˆæ— æœã€‚\nå°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸‹é¢å‡ ç§ï¼š\n ä¿®æ”¹/etc/profile ä¿®æ”¹.xprofile ä¿®æ”¹/etc/environment æ›´æ¢å…¶ä»–ä¸­æ–‡è¾“å…¥æ³• ç”¨fcitx-diagnoseè¯Šæ–­é…ç½®  é…ç½®æ–‡ä»¶è‚¯å®šæ˜¯æ­£ç¡®çš„ï¼ŒæŒ‰ç…§ç½‘ä¸Šè¯´çš„ Linuxä¸‹è¾“å…¥ä¸­æ–‡çš„é…ç½®ä¹Ÿæ£€æŸ¥äº†å¾ˆå¤šï¼Œä½œä¸ºä¸€ä¸ªæœ‰å…­ä¸ƒå¹´ç»éªŒçš„ Linuxè€å¸æœºï¼Œæ€ä¹ˆå¯èƒ½ç¿»è½¦å‘¢ã€‚æœäº†å¾ˆå¤šæ–‡ç« ï¼Œæ­»é©¬å½“ä½œæ´»é©¬åŒ»ï¼Œä¸€ç›´æ— è§£ã€‚\nfcitx-diagnoseè¯Šæ–­ç»“æœå¦‚ä¸‹ï¼Œç„¶è€Œç¡®è®¤é…ç½®äº†ï¼Œå¯ä¸ºä»€ä¹ˆå°±æ˜¯ä¸è®¤è¯†ä¸€ç›´æ²¡ç†è§£ã€‚\n\u0026quot; è€Œä¸æ˜¯ \u0026quot;fcitx\u0026quot;. è¯·æ£€æŸ¥æ‚¨æ˜¯å¦åœ¨æŸä¸ªåˆå§‹åŒ–æ–‡ä»¶ä¸­é”™è¯¯çš„è®¾ç½®äº†å®ƒçš„å€¼.** **æ‚¨å¯èƒ½ä¼šåœ¨ qt4 ç¨‹åºä¸­ä½¿ç”¨ fcitx æ—¶é‡åˆ°é—®é¢˜.** **è¯·ä½¿ç”¨æ‚¨å‘è¡Œç‰ˆæä¾›çš„å·¥å…·å°†ç¯å¢ƒå˜é‡ QT_IM_MODULE è®¾ä¸º \u0026quot;fcitx\u0026quot; æˆ–è€…å°† `export QT_IM_MODULE=fcitx` æ·»åŠ åˆ°æ‚¨çš„ `~/.xprofile` ä¸­. å‚è§ [è¾“å…¥æ³•ç›¸å…³çš„ç¯å¢ƒå˜é‡: QT_IM_MODULE](http://fcitx-im.org/wiki/Input_method_related_environment_variables/zh-cn#QT_IM_MODULE).** gtk - `${GTK_IM_MODULE}`: \u0026quot; è€Œä¸æ˜¯ \u0026quot;fcitx\u0026quot;. è¯·æ£€æŸ¥æ‚¨æ˜¯å¦åœ¨æŸä¸ªåˆå§‹åŒ–æ–‡ä»¶ä¸­é”™è¯¯çš„è®¾ç½®äº†å®ƒçš„å€¼.** **æ‚¨å¯èƒ½ä¼šåœ¨ gtk ç¨‹åºä¸­ä½¿ç”¨ fcitx æ—¶é‡åˆ°é—®é¢˜.** **è¯·ä½¿ç”¨æ‚¨å‘è¡Œç‰ˆæä¾›çš„å·¥å…·å°†ç¯å¢ƒå˜é‡ GTK_IM_MODULE è®¾ä¸º \u0026quot;fcitx\u0026quot; æˆ–è€…å°† `export GTK_IM_MODULE=fcitx` æ·»åŠ åˆ°æ‚¨çš„ `~/.xprofile` ä¸­. å‚è§ [è¾“å…¥æ³•ç›¸å…³çš„ç¯å¢ƒå˜é‡: GTK_IM_MODULE](http://fcitx-im.org/wiki/Input_method_related_environment_variables/zh-cn#GTK_IM_MODULE).**  ç›´åˆ°ä»Šå¤©ï¼Œå¶å°”æœåˆ°äº†è¿™ç¯‡æ–‡ç« ï¼Œå‡ºç°çš„é—®é¢˜å’Œæˆ‘é‡åˆ°çš„ä¸€æ¨¡ä¸€æ ·ã€‚åŸæ¥æ˜¯æˆ‘çš„.xprofileé‡Œç¯å¢ƒå˜é‡ XMODIFIERSã€QT_IM_MODULEã€GTK_IM_MODULE å€¼çš„æœ«å°¾æœ‰ä¸€ä¸ªå›è½¦ç¬¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾ç½®è¿™äº›ç¯å¢ƒå˜é‡çš„é‚£ä¸ªæ–‡ä»¶é”™è¯¯åœ°ä½¿ç”¨äº† DOS / Windows çš„æ¢è¡Œç¬¦ã€‚\nè§£å†³æ–¹æ¡ˆå°±å¾ˆç®€å•äº†ï¼Œåœ¨ Vim ä¸­æ‰“å¼€å¹¶æ‰§è¡Œ :set ff=unixï¼Œç„¶åä¿å­˜å¹¶é€€å‡º :wqã€‚\né‡æ–°æ³¨é”€ï¼Œè§£å†³äº†ã€‚\nç„¶åæƒ³èµ·æ¥ï¼Œå¿«ä¸€å¹´å‰æ›´æ–°ç³»ç»Ÿï¼Œç»“æœæŒ‚äº†ã€‚è¿™æ˜¯å”¯ä¸€ä¸€æ¬¡æ›´æ–° manjaroæ»šæŒ‚äº†ï¼ˆè¿™æ˜¯manjaroè½¯ä»¶æºçš„ä¸€æ¬¡bug å¯¼è‡´ï¼‰ï¼Œä¿®å¤ç³»ç»Ÿåç”¨äº†ç™¾åº¦å¤åˆ¶æ¥çš„ä»£ç ï¼Œç«Ÿç„¶ç–å¿½äº†ã€‚\nè¦æ˜¯æ²¡é‚£ç¯‡æ–‡ç« ï¼ŒçœŸä¸çŸ¥ä½•å¹´ä½•æœˆèƒ½è§£å†³ã€‚æ”¾ç‹—ä¸€æœï¼Œè¿˜æœ‰è®¸è®¸å¤šå¤šå—å®³è€…é‡åˆ°è¿™ç§æƒ…å†µè‡³ä»Šæ²¡æœ‰è§£å†³ï¼Œç”šè‡³åœ¨manjaroå®˜ç½‘æé—®ä¹Ÿæ— è§£ã€‚æ‰€ä»¥è®°å½•ä¸‹ï¼Œå¸Œæœ›æ›´å¤šäººèƒ½çœ‹åˆ°ã€‚\n","date":"2020-03-07","permalink":"https://iminto.github.io/post/kde%E6%A1%8C%E9%9D%A2%E4%B8%8B%E9%83%A8%E5%88%86%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E8%BE%93%E5%85%A5%E4%B8%AD%E6%96%87/","tags":["linux"],"title":"Kdeæ¡Œé¢ä¸‹è‡ªå¸¦åº”ç”¨æ— æ³•è¾“å…¥ä¸­æ–‡"},{"content":"1.å®‰è£…k8s å®‰è£…K8Sçš„æ­¥éª¤ç•¥å»ï¼Œä½¿ç”¨k3så®‰è£…ä¼šæ›´å¿«æ·æ–¹ä¾¿ï¼Œæ–¹ä¾¿æµ‹è¯•ç¯å¢ƒã€‚\nå¦‚æœä½¿ç”¨k3sä¼šæœ‰ä¸ªå‘ï¼Œk3sé»˜è®¤ä½¿ç”¨containerè€Œä¸æ˜¯dockerä½œä¸ºå®¹å™¨ï¼Œä¼šå¯¼è‡´è¿è¡Œæ—¶å‡ºç°ä¸€äº›é—®é¢˜ï¼Œåé¢ä¼šè¯¦ç»†åˆ†æã€‚\nå®‰è£…k3såï¼Œéœ€è¦æŒ‰ç…§å¦‚ä¸‹ä¿®æ”¹ /etc/systemd/system/k3s.service\nExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/local/bin/k3s \\ server --docker \\ #æ·»åŠ  --docker å‚æ•°  2.springbooté•œåƒå‡†å¤‡ pom.xml\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;UTF-8\u0026quot;?\u0026gt; \u0026lt;project xmlns=\u0026quot;http://maven.apache.org/POM/4.0.0\u0026quot; xmlns:xsi=\u0026quot;http://www.w3.org/2001/XMLSchema-instance\u0026quot; xsi:schemaLocation=\u0026quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026quot;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.2.5.RELEASE\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;!-- lookup parent from repository --\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.github.iminto\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;bcdemo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;bcdemo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Demo project for Spring Boot\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt;  BcdemoApplication.java å¯åŠ¨å™¨ä»£ç ç•¥ã€‚\nsrc\\main\\java\\com\\github\\iminto\\bcdemo\\controller\\HomeController.java\npackage com.github.iminto.bcdemo.controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; @RestController public class HomeController { @RequestMapping(\u0026quot;/\u0026quot;) public String home() { return \u0026quot;Hello Docker World\u0026quot;; } }  src\\main\\resources\\application.yaml\nserver: port: 9010  mvnæ‰“åŒ…ã€‚\nDockerfileæ–‡ä»¶å¦‚ä¸‹ï¼š\nFROM openjdk:8-jdk-alpine ENV TZ=Asia/Shanghai RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026amp;\u0026amp; echo $TZ \u0026gt; /etc/timezone COPY bcdemo.jar /opt/app.jar COPY run.sh /opt/run.sh EXPOSE 9010 ENTRYPOINT [\u0026quot;/bin/sh\u0026quot;, \u0026quot;/opt/run.sh\u0026quot;]  run.sh\n#!/bin/bash # do other things here java -jar /opt/app.jar 2\u0026gt;\u0026amp;1  éœ€è¦æ³¨æ„ï¼Œdockerå¿…é¡»è¦æœ‰ä¸€ä¸ªå‰å°è¿›ç¨‹ï¼Œä¸ç„¶è¿è¡Œåä¼šé©¬ä¸Šé€€å‡ºï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤\n#è¿™ä¹ˆå†™æ˜¯é”™çš„ java -jar /opt/app.jar 2\u0026gt;\u0026amp;1 \u0026amp;  dockeré•œåƒæ„å»º\ndocker build . -t bcdemo:1.0  æµ‹è¯•dockeré•œåƒæ˜¯å¦æ­£ç¡®æ—¶ï¼Œéœ€è¦ç”¨ctrl+p+qç»ˆæ­¢æ§åˆ¶å°æ—¥å¿—æ‰“å°ï¼Œä¸è¦ç”¨ctrl+cã€‚\n3.k8séƒ¨ç½² ç¼–å†™yamlæ–‡ä»¶\napiVersion: v1 kind: Deployment metadata: name: k8s-springboot-demo labels: app: k8s-springboot-demo spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: app: k8s-springboot-demo template: metadata: labels: app: k8s-springboot-demo spec: containers: - name: k8s-springboot-demo image: bcdemo:1.0 ports: - containerPort: 9010 protocol: TCP livenessProbe: httpGet: path: / port: 9010 initialDelaySeconds: 30 timeoutSeconds: 30 imagePullPolicy: IfNotPresent tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule --- apiVersion: v1 kind: Service metadata: name: k8s-springboot-demo namespace: default labels: app: k8s-springboot-demo spec: ports: - port: 9010 targetPort: 9010 selector: app: k8s-springboot-demo type: NodePort  éƒ¨ç½²\n#éƒ¨ç½² kubectl apply -f sp.yaml #æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ kubectl get po,svc,deploy -o wide #åˆ é™¤Deployment kubectl delete -f sp.yaml #åˆ é™¤èŠ‚ç‚¹ kubectl delete pod k8s-springboot-demo-fc778b44-f4p49 #æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†è¿è¡ŒçŠ¶æ€ï¼Œå¯ç”¨äºæ’é”™ kubectl describe pod k8s-springboot-demo-fc778b44-f4p49  æœ€ç»ˆéƒ¨ç½²ç»“æœå¦‚ä¸‹ï¼š\n[root@chenwork2 project]# kubectl get po,svc,deploy -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/k8s-springboot-demo-fc778b44-zfjnx 1/1 Running 0 16h 10.42.0.11 chenwork2 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/k8s-springboot-demo NodePort 10.43.35.126 \u0026lt;none\u0026gt; 9010:31622/TCP 16h app=k8s-springboot-demo service/kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 51d \u0026lt;none\u0026gt; NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR deployment.extensions/k8s-springboot-demo 1/1 1 1 16h k8s-springboot-demo bcdemo:1.0 app=k8s-springboot-demo  éªŒè¯ï¼š\n[root@chenwork2 project]# curl -i -X GET chenwork2:31622/ HTTP/1.1 200 Content-Type: text/plain;charset=UTF-8 Content-Length: 18 Date: Fri, 06 Mar 2020 01:55:40 GMT Hello Docker World  è¿™æ ·çš„ç«¯å£ï¼Œåªèƒ½åœ¨é›†ç¾¤å†…è®¿é—®ï¼Œé›†ç¾¤å¤–æ˜¯æ— æ³•è®¿é—®çš„ã€‚\n4.k3sçš„é—®é¢˜ å¦‚æœpodä¸€ç›´æ˜¯ ContainerCreating çŠ¶æ€ï¼Œé‚£å°±æ˜¯podæ²¡æœ‰åˆ›å»ºæˆåŠŸï¼Œç”¨describeå‘½ä»¤çœ‹ä¸€ä¸‹ï¼Œæœ€åå‡ è¡Œä¸€èˆ¬ä¼šçœ‹åˆ°å¦‚ä¸‹æŠ¥é”™\nWarning FailedCreatePodSandBox 91s (x29 over 21m) kubelet, host123 Failed create pod sandbox: rpc error: code = Unknown desc = failed to get sandbox image \u0026quot;k8s.gcr.io/pause:3.1\u0026quot;: failed to pull image \u0026quot;k8s.gcr.io/pause:3.1\u0026quot;: failed to pull and unpack image \u0026quot;k8s.gcr.io/pause:3.1\u0026quot;: failed to resolve reference \u0026quot;k8s.gcr.io/pause:3.1\u0026quot;: failed to do request: Head https://k8s.gcr.io/v2/pause/manifests/3.1: dial tcp 108.177.97.82:443: i/o timeout  åŸå› å·²ç»éå¸¸æ¸…æ¥šäº†ï¼Œfailed to pull image \u0026ldquo;k8s.gcr.io/pause:3.1\u0026rdquo;ï¼Œé•œåƒæ‹‰ä¸åˆ°ã€‚\nè§£å†³æ–¹æ³•ï¼š\ndocker pull mirrorgooglecontainers/pause:3.1 #å…¶å®ç›´æ¥æŠŠrancher/pauseé•œåƒå‘½åæˆk8s.gcr.io/pauseå³å¯ docker tag mirrorgooglecontainers/pause:3.1 k8s.gcr.io/pause:3.1  é‡å¯k3sï¼Œä½ ä¼šå‘ç°podè¿˜æ˜¯å¯åŠ¨ä¸èµ·æ¥ï¼Œè¿™å°±æ˜¯å‰é¢è¯´çš„åŸå› ï¼šk3sé»˜è®¤ä½¿ç”¨containerè€Œä¸æ˜¯dockerä½œä¸ºå®¹å™¨\nä½ æœ‰äº†pauseé•œåƒï¼Œä½†æ˜¯k3sä¸è®¤dockeré•œåƒï¼Œè€Œæ˜¯è®¤containerå®¹å™¨ï¼Œæ‰€ä»¥éœ€è¦æŠŠk3sæ”¹æˆdockerè¿è¡Œæ—¶ã€‚\næˆ–è€…å¦‚ä¸‹æ“ä½œï¼š\nctr --version #éœ€è¦é¢„å…ˆå¯¼å‡ºpauseé•œåƒ ctr images import pause-amd64-3.1.tar #çœ‹çœ‹æœ‰æ²¡æœ‰åŠ è½½è¿›æ¥ ctr images list #å¦‚æœåŠ è½½äº†ï¼Œä½†æ˜¯åå­—ä¸åŒ¹é…ï¼Œéœ€è¦æ‰“æ ‡ç­¾ ctr images tag gcr.io/google_containers/pause-amd64:3.1 k8s.gcr.io/pause:3.1  5.LoadBalanceræœåŠ¡æš´éœ²ç»™å¤–éƒ¨è®¿é—® K8S Service æš´éœ²æœåŠ¡ç±»å‹æœ‰ä¸‰ç§ï¼šClusterIPã€NodePortã€LoadBalancerï¼Œä¸‰ç§ç±»å‹åˆ†åˆ«æœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚\n  å¯¹å†…æœåŠ¡å‘ç°ï¼Œå¯ä»¥ä½¿ç”¨ ClusterIP æ–¹å¼å¯¹å†…æš´éœ²æœåŠ¡ï¼Œå› ä¸ºå­˜åœ¨ Service é‡æ–°åˆ›å»º IP ä¼šæ›´æ”¹çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸å»ºè®®ç›´æ¥ä½¿ç”¨åˆ†é…çš„ ClusterIP æ–¹å¼æ¥å†…éƒ¨è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨ K8S DNS æ–¹å¼è§£æï¼ŒDNS å‘½åè§„åˆ™ä¸ºï¼š\u0026lt;svc_name\u0026gt;.\u0026lt;namespace_name\u0026gt;.svc.cluster.localï¼ŒæŒ‰ç…§è¯¥æ–¹å¼å¯ä»¥ç›´æ¥åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®å¯¹åº”æœåŠ¡ã€‚\n  å¯¹å¤–æœåŠ¡æš´éœ²ï¼Œå¯ä»¥é‡‡ç”¨ NodePortã€LoadBalancer æ–¹å¼å¯¹å¤–æš´éœ²æœåŠ¡ï¼ŒNodePort æ–¹å¼ä½¿ç”¨é›†ç¾¤å›ºå®š IPï¼Œä½†æ˜¯ç«¯å£å·æ˜¯æŒ‡å®šèŒƒå›´å†…éšæœºé€‰æ‹©çš„ï¼Œæ¯æ¬¡æ›´æ–° Service è¯¥ Port å°±ä¼šæ›´æ”¹ï¼Œä¸å¤ªæ–¹ä¾¿ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šå›ºå®šçš„ NodePortï¼Œä½†æ˜¯éœ€è¦è‡ªå·±ç»´æŠ¤ Port åˆ—è¡¨ï¼Œä¹Ÿä¸æ–¹ä¾¿ã€‚LoadBalancer æ–¹å¼ä½¿ç”¨é›†ç¾¤å›ºå®š IP å’Œ NodePortï¼Œä¼šé¢å¤–ç”³è¯·ç”³è¯·ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥è½¬å‘åˆ°å¯¹åº”æœåŠ¡ï¼Œä½†æ˜¯éœ€è¦åº•å±‚å¹³å°æ”¯æ’‘ã€‚å¦‚æœä½¿ç”¨ Aliyunã€GCE ç­‰äº‘å¹³å°å•†ï¼Œå¯ä»¥ä½¿ç”¨è¯¥ç§æ–¹å¼ï¼Œä»–ä»¬åº•å±‚ä¼šæä¾› LoadBalancer æ”¯æŒï¼Œç›´æ¥ä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚\n  ä»¥ä¸Šæ–¹å¼æˆ–å¤šæˆ–å°‘éƒ½ä¼šå­˜åœ¨ä¸€å®šçš„å±€é™æ€§ï¼Œæ‰€ä»¥å»ºè®®å¦‚æœåœ¨å…¬æœ‰äº‘ä¸Šè¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ LoadBalancerã€ Ingress æ–¹å¼å¯¹å¤–æä¾›æœåŠ¡ï¼Œç§æœ‰äº‘çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ Ingress é€šè¿‡åŸŸåè§£ææ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚\nä¸‹é¢ä½¿ç”¨LoadBalanceræ–¹å¼ã€‚\nyamlæ–‡ä»¶ä¿®æ”¹ ä¿®æ”¹k8s-springboot-demo.yaml\napiVersion: v1 kind: Service metadata: name: k8s-springboot-demo namespace: default labels: app: k8s-springboot-demo spec: ports: - port: 8080 targetPort: 8080 selector: app: k8s-springboot-demo type: LoadBalancer  serviceçš„typeä¿®æ”¹ä¸ºLoadBalancerï¼Œç„¶å\nkubectl apply -f k8s-springboot-demo.yaml  å‘½ä»¤ä¿®æ”¹ ç”¨å‘½ä»¤ä¿®æ”¹çš„æ–¹å¼æ›´æ–¹ä¾¿ã€‚\n[root@chenwork2 project]# kubectl delete svc k8s-springboot-demo service \u0026quot;k8s-springboot-demo\u0026quot; deleted [root@chenwork2 project]# kubectl get po,svc,deploy NAME READY STATUS RESTARTS AGE pod/k8s-springboot-demo-fc778b44-zfjnx 1/1 Running 0 16h NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 51d NAME READY UP-TO-DATE AVAILABLE AGE deployment.extensions/k8s-springboot-demo 1/1 1 1 16h [root@chenwork2 project]# kubectl expose deploy k8s-springboot-demo --type=LoadBalancer service/k8s-springboot-demo exposed [root@chenwork2 project]# kubectl get po,svc,deploy NAME READY STATUS RESTARTS AGE pod/k8s-springboot-demo-fc778b44-zfjnx 1/1 Running 0 16h pod/svclb-k8s-springboot-demo-crfvw 1/1 Running 0 4s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/k8s-springboot-demo LoadBalancer 10.43.112.54 10.180.249.73 9010:32219/TCP 4s service/kubernetes ClusterIP 10.43.0.1 \u0026lt;none\u0026gt; 443/TCP 51d NAME READY UP-TO-DATE AVAILABLE AGE deployment.extensions/k8s-springboot-demo 1/1 1 1 16h  è¿™æ ·å°±èƒ½åœ¨é›†ç¾¤å¤–ï¼Œç›´æ¥ç”¨æµè§ˆå™¨è®¿é—®äº†ã€‚\nä¹Ÿå¯ä»¥ä½¿ç”¨ ClusterIP+kubectl proxy æ–¹å¼ï¼Œä½†ä¸æ¨èã€‚\n6.å®¹å™¨éƒ¨ç½²yamlä¸­ä¼ é€’å‚æ•° å¯ä»¥å‘å®¹å™¨ä¼ é€’å‚æ•°åˆ°è„šæœ¬æ‰§è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œè€Œä¸”è¿™é‡Œå˜æˆè„šæœ¬æ¥å¯åŠ¨ï¼Œè¿™æ ·åç»­æ„å»ºé•œåƒåŸºæœ¬ä¸éœ€è¦æ”¹ Dockerfile äº†\n#!/bin/bash # do other things here java -jar $JAVA_OPTS /opt/project/app.jar $1 2\u0026gt;\u0026amp;1  ä¸Šè¾¹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°±æ³¨å…¥ $JAVA_OPTS ç¯å¢ƒå˜é‡ï¼Œæ¥ä¼˜åŒ– JVM å‚æ•°ï¼Œè¿˜å¯ä»¥ä¼ é€’ä¸€ä¸ªå˜é‡ï¼Œè¿™ä¸ªå˜é‡å¤§å®¶åº”è¯¥å°±çŒœåˆ°äº†ï¼Œå°±æ˜¯æœåŠ¡å¯åŠ¨åŠ è½½å“ªä¸ªé…ç½®æ–‡ä»¶å‚æ•°ï¼Œä¾‹å¦‚ï¼š\u0026ndash;spring.profiles.active=prod é‚£ä¹ˆï¼Œåœ¨ Deployment ä¸­å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼é…ç½®äº†ï¼š\nspec: containers: - name: project-name image: registry.docker.com/project/app:v1.0.0 args: [\u0026quot;--spring.profiles.active=prod\u0026quot;] env: - name: JAVA_OPTS value: \u0026quot;-XX:PermSize=512M -XX:MaxPermSize=512M -Xms1024M -Xmx1024M...\u0026quot;  7.å‚è€ƒ Spring Boot é¡¹ç›®è½¬å®¹å™¨åŒ– K8S éƒ¨ç½²å®ç”¨ç»éªŒåˆ†äº«\nK8s é›†ç¾¤ä½¿ç”¨ ConfigMap ä¼˜é›…åŠ è½½ Spring Boot é…ç½®æ–‡ä»¶\n[Spring Bootåº”ç”¨å®¹å™¨åŒ–åŠKuberneteséƒ¨ç½²](http://fly-luck.github.io/2018/11/10/Spring Boot App on Kubernetes/)\nåŸºäºKuberneteså’ŒSpringbootæ„å»ºå¾®æœåŠ¡\nDocker / Kuberneteséƒ¨ç½²Java / SpringBooté¡¹ç›®\nåœ¨Kubernetesä¸­éƒ¨ç½²spring bootåº”ç”¨\n","date":"2020-03-06","permalink":"https://iminto.github.io/post/k8s%E9%83%A8%E7%BD%B2springboot/","tags":["k8s","Java"],"title":"K8séƒ¨ç½²springboot"},{"content":"rancher æ˜¯ä¸€ä¸ªä¸ºDevOpså›¢é˜Ÿæä¾›çš„å®Œæ•´çš„Kubernetesä¸å®¹å™¨ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚rancheræœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯å®‰è£…éƒ¨ç½²æ–¹ä¾¿ï¼Œæå¤§åœ°ç®€åŒ–äº†K8Sçš„å®‰è£…é…ç½®ã€‚åœ¨å®˜ç½‘ä¸Šï¼Œæ¨èçš„æ˜¯ä½¿ç”¨dockeræ–¹å¼å®‰è£…rancherï¼Œè¿™ç§æ–¹å¼éšè—äº†å¤§é‡çš„ç»†èŠ‚ã€‚åœ¨ç½‘ä¸Šæœäº†ä¸‹ç°æœ‰çš„èµ„æ–™ï¼Œå‡ ä¹éƒ½æ˜¯ç…§æŠ„å®˜æ–¹æ–‡æ¡£ï¼Œæ›´æ²¡æœ‰åœ¨windowsä¸Šå®‰è£…rancherçš„å…ˆä¾‹ã€‚\nrancheræ˜¯ç”¨golangå†™çš„ï¼Œè·¨å¹³å°é—®é¢˜ä¸å¤§ï¼Œä½†ä¹Ÿéœ€è¦ä¸€äº›ä¿®æ”¹ã€‚æ­£å¥½æœ€è¿‘è¦å¯¹rancheråšäºŒæ¬¡å¼€å‘ï¼Œäºæ˜¯è®°å½•ä¸‹äº†åœ¨windowsä¸Šç¼–è¯‘å®‰è£…rancherçš„æ­¥éª¤ã€‚\n1.ä¿®æ”¹æºç  rancherè¦åœ¨windowsä¸Šç¼–è¯‘é€šè¿‡å¹¶è¿è¡Œï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹æºç \nmain.go\nfunc run(cfg app.Config) error { logrus.Infof(\u0026quot;Rancher version %s is starting\u0026quot;, VERSION) logrus.Infof(\u0026quot;Rancher arguments %+v\u0026quot;, cfg) dump.GoroutineDumpOn(syscall.SIGUSR1, syscall.SIGILL) ctx := signals.SetupSignalHandler(context.Background())  æ”¹ä¸ºå¦‚ä¸‹ï¼Œæ­¤å¤„ä¿®æ”¹åŸºæœ¬ä¸ä¼šæœ‰å‰¯ä½œç”¨\nfunc run(cfg app.Config) error { logrus.Infof(\u0026quot;Rancher version %s is starting\u0026quot;, VERSION) logrus.Infof(\u0026quot;Rancher arguments %+v\u0026quot;, cfg) dump.GoroutineDumpOn(syscall.SIGILL, syscall.SIGILL) ctx := signals.SetupSignalHandler(context.Background())  ç„¶åå±è”½ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ä¸­ç›¸å…³syscallçš„å¤„ç†ï¼šï¼ˆè¿™å‡ å¤„ä¿®æ”¹å¯èƒ½ä¼šå¯¼è‡´K8Sç›¸å…³çš„åŠŸèƒ½å¸¦æ¥å½±å“ï¼Œä½†å½±å“æœªçŸ¥.å»ºè®®ä½¿ç”¨æ¡ä»¶ç¼–è¯‘æ–¹å¼ï¼‰\npkg/controllers/user/helm/common/common.go\nfunc JailCommand(cmd *exec.Cmd, jailPath string) (*exec.Cmd, error) { if os.Getenv(\u0026quot;CATTLE_DEV_MODE\u0026quot;) != \u0026quot;\u0026quot; { return cmd, nil } else { //cred, err := jailer.GetUserCred() //if err != nil { // return nil, errors.WithMessage(err, \u0026quot;get user cred error\u0026quot;) //} // //cmd.SysProcAttr = \u0026amp;syscall.SysProcAttr{} //cmd.SysProcAttr.Credential = cred //cmd.SysProcAttr.Chroot = jailPath //cmd.Env = jailer.WhitelistEnvvars(cmd.Env) return cmd, nil } }  pkg/controllers/management/node/utils.go ä¿®æ”¹åŒç†\nfunc buildCommand(nodeDir string, node *v3.Node, cmdArgs []string) (*exec.Cmd, error) { // In dev_mode, don't need jail or reference to jail in command if os.Getenv(\u0026quot;CATTLE_DEV_MODE\u0026quot;) != \u0026quot;\u0026quot; { env := initEnviron(nodeDir) command := exec.Command(nodeCmd, cmdArgs...) command.Env = env return command, nil } //cred, err := jailer.GetUserCred() //if err != nil { // return nil, errors.WithMessage(err, \u0026quot;get user cred error\u0026quot;) //} command := exec.Command(nodeCmd, cmdArgs...) //command.SysProcAttr = \u0026amp;syscall.SysProcAttr{} //command.SysProcAttr.Credential = cred //command.SysProcAttr.Chroot = path.Join(jailer.BaseJailPath, node.Namespace) envvars := []string{ nodeDirEnvKey + nodeDir, \u0026quot;PATH=/usr/bin:/var/lib/rancher/management-state/bin\u0026quot;, } command.Env = jailer.WhitelistEnvvars(envvars) return command, nil }  å±è”½jailerçš„å¤„ç†\npkg/jailer/jailer.go æ³¨é‡Šæ‰è¿™ä¸ªæ–¹æ³•\n// GetUserCred looks up the user and provides it in syscall.Credential //func GetUserCred() (*syscall.Credential, error) { // //}  ä¿®æ”¹ä¸€ä¸ªä¾èµ–åº“é‡Œçš„æ–‡ä»¶ ï¼ˆæ¯”è¾ƒæ­£è§„çš„æ–¹å¼æ˜¯åœ¨go modä¸­ä½¿ç”¨replaceè¯­æ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ç¬¬ä¸‰æ–¹packageï¼‰\nvendor/github.com/rancher/kontainer-engine/service/service.go\n#446è¡Œå¼€å§‹æ³¨é‡Šè¿™æ®µä»£ç  //if os.Getenv(\u0026quot;CATTLE_DEV_MODE\u0026quot;) == \u0026quot;\u0026quot; { // cred, err := getUserCred() // if err != nil { // return \u0026quot;\u0026quot;, errors.WithMessage(err, \u0026quot;get user cred error\u0026quot;) // } // // cmd.SysProcAttr = \u0026amp;syscall.SysProcAttr{} // cmd.SysProcAttr.Credential = cred // cmd.SysProcAttr.Chroot = \u0026quot;/opt/jail/driver-jail\u0026quot; // cmd.Env = whitelistEnvvars([]string{\u0026quot;PATH=/usr/bin\u0026quot;}) //}  628è¡Œæ³¨é‡Šæ‰è¿™ä¸ªæ–¹æ³•\n// getUserCred looks up the user and provides it in syscall.Credential //func getUserCred() (*syscall.Credential, error) {  ç„¶åç¼–è¯‘å³å¯ç”Ÿæˆexeæ–‡ä»¶ã€‚\n2.è¿è¡Œ å¦‚æœç¬”è®°æœ¬å†…å­˜åœ¨8Gä»¥ä¸Šï¼Œå¯ä»¥å®‰è£…windowsç‰ˆæœ¬k8sæˆ–è€…minikube\nç”±äºæˆ‘æœ¬æœºé…ç½®å¤ªä½ï¼Œæ‰€ä»¥ä½¿ç”¨äº†linuxæœåŠ¡å™¨ä¸Šçš„é…ç½®ã€‚\n#æ¯æ¬¡è¿è¡Œä¸€å®šè¦æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œæˆ–è€…åœ¨ç¯å¢ƒå˜é‡é‡Œé…ç½®åŠ ä¸‹ä¹Ÿå¯ä¸€åŠ³æ°¸é€¸ set CATTLE_DEV_MODE=true go build -mod=vendor #ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ rancher.exe è¿è¡Œæ–‡ä»¶éœ€è¦k8s åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…k8s ç„¶åå°†é…ç½®æ–‡ä»¶k3s.yamlä¸‹è½½åˆ°æœ¬åœ°windowsä¸Šï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„ipä¸ºk8sæ‰€åœ¨æœåŠ¡å™¨ä¸Šçš„ip #ä¿®æ”¹å®Œæˆåæ‰§è¡Œä¸‹é¢æŒ‡ä»¤ å…¶ä¸­ï¼šg:\\data\\k3s.yamlä¸ºé…ç½®æ–‡ä»¶æ‰€åœ¨æœ¬åœ°è·¯å¾„ rancher.exe --k8s-mode=external --kubeconfig g:\\data\\k3s.yaml --no-cacerts=true  k3s.yamlæ˜¯LinuxæœåŠ¡å™¨ä¸Šçš„K8Sé…ç½®æ–‡ä»¶ã€‚ä¸è¦ä½¿ç”¨æœåŠ¡å™¨ä¸Šå·²ç»è¢«rancherä½¿ç”¨è¿‡çš„k8sï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªå´­æ–°çš„K8Sç¯å¢ƒã€‚\næœåŠ¡å™¨ä¸Šå®‰è£…k8så¯ä»¥å‚è€ƒè¿™é‡Œï¼šhttps://k3s.io/\n#è¿™ä¸€æ­¥å¯èƒ½éœ€è¦ç¿»å¢™ curl -sfL https://get.k3s.io | sh - #Check for Ready node, takes maybe 30 seconds k3s kubectl get node  æ–°å¢ä¸€ä¸ªç”¨æˆ·è¯•ä¸€ä¸‹ï¼Œå¯ä»¥æ–°å¢æˆåŠŸ\n3.æ¡ä»¶ç¼–è¯‘ æ¡ä»¶ç¼–è¯‘ä¸éœ€è¦åœ¨åŸæœ‰æ–‡ä»¶å†…å®¹ä¸Šåšä¿®æ”¹ï¼Œç¼–è¯‘å‡ºçš„æ–‡ä»¶å¯ä»¥ä¿è¯åœ¨linuxä¸Šæ˜¯å®Œæ•´çš„ã€‚\nä»¥ä¿®æ”¹pkg/controllers/user/helm/common/common.go ä¸ºä¾‹ï¼Œå°†åŸæ–‡ä»¶é‡å‘½åæœªcommon_linux.goï¼Œç„¶åæ–°å»ºä¸€ä¸ªcommon_windows_amd64.goï¼Œé‡Œé¢æ˜¯windowsç‰ˆæœ¬çš„æºç ã€‚\nç„¶åç¼–è¯‘å³å¯ã€‚\nçœ‹èµ·æ¥æ¡ä»¶ç¼–è¯‘å¯¹æºæ–‡ä»¶åšäº†é‡å‘½åæ“ä½œï¼Œä½†æ˜¯ä¿è¯äº†linuxä¸Šä»£ç çš„å®Œæ•´ï¼Œä¸ä¼šè®©windowsä¸Šçš„ä¿®æ”¹å¯¼è‡´linuxä¸Šäº§ç”Ÿéšæ‚£ã€‚\ngolangæ¡ä»¶ç¼–è¯‘çš„æºé‡Œå¯ä»¥å‚è€ƒæ­¤å¤„ï¼šhttps://www.jianshu.com/p/4bb03e67e7ae\n4.é—®é¢˜ 1.æœªæµ‹è¯•æ›´å¤šé«˜çº§åŠŸèƒ½ï¼Œè¿˜æœªçŸ¥ã€‚\n","date":"2020-02-28","permalink":"https://iminto.github.io/post/windows%E4%B8%8A%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8Crancher/","tags":["k8s"],"title":"Windowsä¸Šç¼–è¯‘å®‰è£…è¿è¡Œrancher"},{"content":"ä»Šå¤©ç¾¤é‡Œæœ‰ä½360çš„å®‰å…¨å¤§ä½¬ï¼Œå‘äº†ä¸ªé“¾æ¥http://93.175.29.89:8008/ï¼Œè¯´çˆ¬è¿™ä¸ªç½‘å€çš„æ—¶å€™ï¼ŒIOä¼šä¸€ç›´å¡åœ¨é‚£ï¼Œä¸€ç›´æ²¡æœ‰è¿”å›å“åº”ã€‚ é‚£ä¸ªç½‘å€æ˜¯ä»–æ„é€ çš„ä¸€ä¸ªç‰¹æ®Šè¯·æ±‚ï¼Œè¾“å‡ºä¸€ä¸ªè§†é¢‘æµï¼Œä½†æ˜¯æœåŠ¡å™¨ç«¯ä¸è¿”å›Content-Lengthï¼Œä¹Ÿä¸è¾“å‡ºçœŸå®æ•°æ®ï¼Œå°±æ˜¯è¾“å‡ºä¸åˆ°1024å­—èŠ‚çš„æµåå°±ä¸€ç›´åœåœ¨é‚£ä¹Ÿä¸closeï¼Œæµè§ˆå™¨æ‰“å¼€çš„æ•ˆæœå°±æ˜¯çœ‹åˆ°äº†è§†é¢‘çš„å‰å‡ å¸§ï¼Œç„¶åä¸€ç›´å¡åœ¨å“ªè½¬åœˆã€‚\nè¿™ä¹ˆè¯´æ¥ï¼Œæ„Ÿè§‰ä¸æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œè®¾ç½®ä¸‹ReadTimeoutä¸å°±å¥½äº†ä¹ˆï¼Œå¤§ä½¬è¯´ä»–ä¹Ÿè®¾ç½®äº†ï¼Œä½†æ˜¯æ— æ•ˆï¼Œä»–ä½¿ç”¨çš„pythonä»£ç å®ç°ï¼Œåˆšå¼€å§‹æˆ‘è§‰å¾—æ˜¯ä»–ä»£ç çš„é—®é¢˜ï¼Œæˆ–è€…é‚£ä¸ªAPIåº“å®ç°çš„é—®é¢˜ï¼Œå°±ç”¨Javaä¹Ÿå®ç°äº†ä¸€æŠŠ\npackage sms.bai.util; import com.squareup.okhttp.Headers; import com.squareup.okhttp.OkHttpClient; import com.squareup.okhttp.Request; import com.squareup.okhttp.Response; import java.io.IOException; import java.util.concurrent.*; public class Req { public static void reqUrl() throws IOException { OkHttpClient client = new OkHttpClient(); client.setConnectTimeout(5,TimeUnit.SECONDS); client.setReadTimeout(5,TimeUnit.SECONDS); Request request = new Request.Builder() .url(\u0026quot;http://93.175.29.89:8008/\u0026quot;) .build(); Response response = client.newCall(request).execute(); if (!response.isSuccessful()) { throw new IOException(\u0026quot;æœåŠ¡å™¨ç«¯é”™è¯¯: \u0026quot; + response); } Headers responseHeaders = response.headers(); for (int i = 0; i \u0026lt; responseHeaders.size(); i++) { System.out.println(responseHeaders.name(i) + \u0026quot;: \u0026quot; + responseHeaders.value(i)); } System.out.println(response.body().string()); } public static void main(String[] args) throws IOException { reqUrl(); } }  æœç„¶å¦‚å…¶æ‰€è¨€ï¼Œæ— è®ºè®¾ç½®ConnectTimeoutè¿˜æ˜¯ReadTimeoutéƒ½æ˜¯æ— æ•ˆçš„ï¼Œä»£ç ä¸€ç›´åœç•™åœ¨è¾“å‡ºé‚£é‡Œï¼Œä¸è¾“å‡ºä»»ä½•bodyï¼ˆæµè§ˆå™¨é‡Œè¿˜èƒ½å‹‰å¼ºçœ‹åˆ°ç”»é¢ï¼‰ï¼Œç¨‹åºä¹Ÿä¸stop\nContent-Type: multipart/x-mixed-replace;boundary=---nessy2jpegboundary OkHttp-Sent-Millis: 1582028133591 OkHttp-Received-Millis: 1582028133875  è¿™é‡Œç”¨çš„æ˜¯OkHttpåº“ ,æ¢å…¶å®ƒåº“æˆ–è€…ç”¨Javaè‡ªå¸¦çš„HttpUrlConnectionç†è®ºä¸Šæ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚\nç”¨ffmpegæ¥çœ‹çœ‹è¿™ä¸ªè¯·æ±‚\n[kk@kk ~]$ ffmpeg -i http://93.175.29.89:8008/ -f mp4 out.mp4 ffmpeg version n4.2.2 Copyright (c) 2000-2019 the FFmpeg developers built with gcc 9.2.0 (GCC) libavutil 56. 31.100 / 56. 31.100 libavcodec 58. 54.100 / 58. 54.100 libavformat 58. 29.100 / 58. 29.100 libavdevice 58. 8.100 / 58. 8.100 libavfilter 7. 57.100 / 7. 57.100 libswscale 5. 5.100 / 5. 5.100 libswresample 3. 5.100 / 3. 5.100 libpostproc 55. 5.100 / 55. 5.100 Input #0, mpjpeg, from 'http://93.175.29.89:8008/': Duration: N/A, bitrate: N/A Stream #0:0: Video: mjpeg (Baseline), yuvj420p(pc, bt470bg/unknown/unknown), 640x480 [SAR 1:1 DAR 4:3], 25 tbr, 25 tbn, 25 tbc Stream mapping: Stream #0:0 -\u0026gt; #0:0 (mjpeg (native) -\u0026gt; h264 (libx264)) Press [q] to stop, [?] for help [libx264 @ 0x562ad6812cc0] using SAR=1/1 [libx264 @ 0x562ad6812cc0] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX FMA3 BMI2 AVX2 [libx264 @ 0x562ad6812cc0] profile High, level 3.0, 4:2:0, 8-bit [libx264 @ 0x562ad6812cc0] 264 - core 159 r2991 1771b55 - H.264/MPEG-4 AVC codec - Copyleft 2003-2019 - http://www.videolan.org/x264.html - options: cabac=1 ref=3 deblock=1:0:0 analyse=0x3:0x113 me=hex subme=7 psy=1 psy_rd=1.00:0.00 mixed_ref=1 me_range=16 chroma_me=1 trellis=1 8x8dct=1 cqm=0 deadzone=21,11 fast_pskip=1 chroma_qp_offset=-2 threads=12 lookahead_threads=2 sliced_threads=0 nr=0 decimate=1 interlaced=0 bluray_compat=0 constrained_intra=0 bframes=3 b_pyramid=2 b_adapt=1 b_bias=0 direct=1 weightb=1 open_gop=0 weightp=2 keyint=250 keyint_min=25 scenecut=40 intra_refresh=0 rc_lookahead=40 rc=crf mbtree=1 crf=23.0 qcomp=0.60 qpmin=0 qpmax=69 qpstep=4 ip_ratio=1.40 aq=1:1.00 Output #0, mp4, to 'out.mp4': Metadata: encoder : Lavf58.29.100 Stream #0:0: Video: h264 (libx264) (avc1 / 0x31637661), yuvj420p(pc), 640x480 [SAR 1:1 DAR 4:3], q=-1--1, 25 fps, 12800 tbn, 25 tbc Metadata: encoder : Lavc58.54.100 libx264 Side data: cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: -1 frame= 83 fps=1.1 q=-1.0 Lsize= 336kB time=00:00:03.20 bitrate= 859.8kbits/s speed=0.0436x  ffmpeg èƒ½è¯†åˆ«å‡ºæ˜¯ä¸€ä¸ªè§†é¢‘æµï¼Œä½†æ˜¯ä¼šä¸€ç›´å¡åœ¨frame=xxè¿™é‡Œï¼Œä¸€ç›´è¯»å–å¸§è€Œä¸åœæ­¢ã€‚å¼ºè¡Œç»ˆæ­¢åèƒ½è¾“å‡ºä¸€ä¸ªæ—¶é•¿æœ‰å‡ ç§’çš„è§†é¢‘\nçœ‹æ¥ä¾é HttpUrlConnectionä¸­çš„SocketTimeoutExceptionæ˜¯æ— è§£äº†ï¼Œåªèƒ½åœ¨å¤–é¢å¥—ä¸€å±‚äº†ã€‚mainæ–¹æ³•æ”¹æˆå¦‚ä¸‹\n public static void main(String[] args) throws Exception { final ExecutorService exec = Executors.newFixedThreadPool(1); Callable\u0026lt;String\u0026gt; call = new Callable\u0026lt;String\u0026gt;() { public String call() throws Exception { //å¼€å§‹æ‰§è¡Œè€—æ—¶æ“ä½œ reqUrl(); return \u0026quot;çº¿ç¨‹æ‰§è¡Œå®Œæˆ.\u0026quot;; } }; Future\u0026lt;String\u0026gt; future = null; try { future = exec.submit(call); String obj = future.get(1000 * 10, TimeUnit.MILLISECONDS); //ä»»åŠ¡å¤„ç†è¶…æ—¶æ—¶é—´è®¾ä¸º 10 ç§’ System.out.println(\u0026quot;ä»»åŠ¡æˆåŠŸè¿”å›:\u0026quot; + obj); } catch (TimeoutException ex) { System.out.println(\u0026quot;å¤„ç†è¶…æ—¶å•¦....\u0026quot;); ex.printStackTrace(); future.cancel(true); } catch (Exception e) { System.out.println(\u0026quot;å¤„ç†å¤±è´¥.\u0026quot;); e.printStackTrace(); }finally { // å…³é—­çº¿ç¨‹æ±  System.out.println(\u0026quot;å…³é—­çº¿ç¨‹æ± \u0026quot;); exec.shutdown(); } }  è¿™ä¸‹èƒ½å¾—åˆ°æœŸæœ›çš„ç»“æœäº†\nContent-Type: multipart/x-mixed-replace;boundary=---nessy2jpegboundary OkHttp-Sent-Millis: 1582028854911 OkHttp-Received-Millis: 1582028855178 å¤„ç†è¶…æ—¶å•¦.... java.util.concurrent.TimeoutException at java.util.concurrent.FutureTask.get(FutureTask.java:205) at sms.bai.util.Req.main(Req.java:47) å…³é—­çº¿ç¨‹æ±  Process finished with exit code 0  é‚£è¿™ä¸ªHttpUrlConnectioné‡Œçš„è¶…æ—¶åˆ°åº•æ˜¯å•¥æ„æ€å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ— æ•ˆå‘¢ï¼Ÿçœ‹ä¸€ä¸‹æ–‡æ¡£ã€‚ ConnectTimeout , java æ˜¯è¿™æ ·è§£é‡Šçš„ï¼š\n Sets a specified timeout value, in milliseconds, to be used when opening a communications link to the resource referenced by this URLConnection. If the timeout expires before the connection can be established, a java.net.SocketTimeoutException is raised. A timeout of zero is interpreted as an infinite timeout.\nSome non-standard implmentation of this method may ignore the specified timeout. To see the connect timeout set, please call getConnectTimeout().\n æ„æ€æ˜¯ç”¨æ¥å»ºç«‹è¿æ¥çš„æ—¶é—´ã€‚å¦‚æœåˆ°äº†æŒ‡å®šçš„æ—¶é—´ï¼Œè¿˜æ²¡å»ºç«‹è¿æ¥ï¼Œåˆ™æŠ¥å¼‚å¸¸ã€‚ è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚\nReadTimeout , Java æ˜¯è¿™æ ·è§£é‡Šçš„ï¼š\n Sets the read timeout to a specified timeout, in milliseconds. A non-zero value specifies the timeout when reading from Input stream when a connection is established to a resource. If the timeout expires before there is data available for read, a java.net.SocketTimeoutException is raised. A timeout of zero is interpreted as an infinite timeout.\nSome non-standard implementation of this method ignores the specified timeout. To see the read timeout set, please call getReadTimeout().\n æ„æ€æ˜¯å·²ç»å»ºç«‹è¿æ¥ï¼Œå¹¶å¼€å§‹è¯»å–æœåŠ¡ç«¯èµ„æºã€‚å¦‚æœåˆ°äº†æŒ‡å®šçš„æ—¶é—´ï¼Œæ²¡æœ‰å¯èƒ½çš„æ•°æ®è¢«å®¢æˆ·ç«¯è¯»å–ï¼Œåˆ™æŠ¥å¼‚å¸¸ã€‚\nä¹Ÿå°±æ˜¯è¯´setReadTimeout not mean read complete, it mean when wait for 10s, when there\u0026rsquo;re no more data read in, will throw a timeoutexceptionã€‚\næ‰€ä»¥é’ˆå¯¹è¿™ç§ç‰¹æ®Šçš„æœåŠ¡å™¨æ„é€ çš„å¼‚å¸¸æµï¼Œæ˜¯æ²¡æ³•ç”¨SocketTimeoutExceptionæ¥è§£å†³è¶…æ—¶çš„ï¼Œåªèƒ½åœ¨å¤–é¢å†è®¾ç½®ä¸€å±‚ï¼Œé€šè¿‡çº¿ç¨‹çš„è¶…æ—¶æ¥æ§åˆ¶ã€‚\nå¦å¤–æä¸€å¥ï¼Œpythonæ˜¯é€šè¿‡è®¾ç½®geventè¶…æ—¶æ¥è§£å†³çš„ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ã€‚\ntipsï¼š360å¤§ä½¬è®¤ä¸ºï¼Œè¿™ç§ç‰¹æ®ŠURLï¼Œä¸å¤±ä¸ºä¸€ç§ç»™çˆ¬è™«æŒ–å‘çš„åšæ³•ã€‚\n","date":"2020-02-18","permalink":"https://iminto.github.io/post/httpurlconnection%E9%87%8Csetreadtimeout%E8%B6%85%E6%97%B6%E6%97%A0%E6%95%88/","tags":["Java"],"title":"HttpURLConnectioné‡ŒsetReadTimeoutè¶…æ—¶æ— æ•ˆ"},{"content":"k8sæ¯ä¸ªç‰ˆæœ¬çœ‹èµ·æ¥å…¼å®¹æ€§ä¸æ˜¯å¤ªå¥½ï¼Œå¾ˆå¤šç½‘ä¸Šçš„ä¾‹å­è·‘èµ·æ¥å¾€å¾€éƒ½æœ‰é—®é¢˜ã€‚\nç›®å‰ç”¨çš„ç‰ˆæœ¬\nroot@de001:/develop# kubectl version Client Version: version.Info{Major:\u0026quot;1\u0026quot;, Minor:\u0026quot;17\u0026quot;, GitVersion:\u0026quot;v1.17.2+k3s1\u0026quot;, GitCommit:\u0026quot;cdab19b09a84389ffbf57bebd33871c60b1d6b28\u0026quot;, GitTreeState:\u0026quot;clean\u0026quot;, BuildDate:\u0026quot;2020-01-27T18:09:26Z\u0026quot;, GoVersion:\u0026quot;go1.13.6\u0026quot;, Compiler:\u0026quot;gc\u0026quot;, Platform:\u0026quot;linux/amd64\u0026quot;} Server Version: version.Info{Major:\u0026quot;1\u0026quot;, Minor:\u0026quot;17\u0026quot;, GitVersion:\u0026quot;v1.17.2+k3s1\u0026quot;, GitCommit:\u0026quot;cdab19b09a84389ffbf57bebd33871c60b1d6b28\u0026quot;, GitTreeState:\u0026quot;clean\u0026quot;, BuildDate:\u0026quot;2020-01-27T18:09:26Z\u0026quot;, GoVersion:\u0026quot;go1.13.6\u0026quot;, Compiler:\u0026quot;gc\u0026quot;, Platform:\u0026quot;linux/amd64\u0026quot;}  1.ç¼–å†™Specæ–‡æ¡£ apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: # name must match the spec fields below, and be in the form: \u0026lt;plural\u0026gt;.\u0026lt;group\u0026gt; name: crontabs.chenwen.com spec: # group name to use for REST API: /apis/\u0026lt;group\u0026gt;/\u0026lt;version\u0026gt; group: chenwen.com # list of versions supported by this CustomResourceDefinition versions: - name: v2 # Each version can be enabled/disabled by Served flag. served: true # One and only one version must be marked as the storage version. storage: true # A schema is required # The conversion section is introduced in Kubernetes 1.13+ with a default value of # None conversion (strategy sub-field set to None). conversion: # None conversion assumes the same schema for all versions and only sets the apiVersion # field of custom resources to the proper value strategy: None # either Namespaced or Cluster scope: Namespaced names: # plural name to be used in the URL: /apis/\u0026lt;group\u0026gt;/\u0026lt;version\u0026gt;/\u0026lt;plural\u0026gt; plural: crontabs # singular name to be used as an alias on the CLI and for display singular: crontab # kind is normally the CamelCased singular type. Your resource manifests use this. kind: Crontab listKind: CrontabList # shortNames allow shorter string to match your resource on the CLI shortNames: - ct  2.å¯¼å…¥K8S ln -s /etc/rancher/k3s/k3s.yaml ~/.kube/config kubectl apply -f crontab_crd.yml kubectl get crd  å¯ä»¥çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„crdäº†ã€‚\næŸ¥çœ‹è¿™ä¸ªCRD\nroot@de001:/develop# kubectl describe crontabs.chenwen.com Name: my-test-crontab Namespace: default Labels: \u0026lt;none\u0026gt; Annotations: kubectl.kubernetes.io/last-applied-configuration: {\u0026quot;apiVersion\u0026quot;:\u0026quot;chenwen.com/v2\u0026quot;,\u0026quot;kind\u0026quot;:\u0026quot;Crontab\u0026quot;,\u0026quot;metadata\u0026quot;:{\u0026quot;annotations\u0026quot;:{},\u0026quot;name\u0026quot;:\u0026quot;my-test-crontab\u0026quot;,\u0026quot;namespace\u0026quot;:\u0026quot;default\u0026quot;},\u0026quot;spec\u0026quot;:{\u0026quot;cron... API Version: chenwen.com/v2 Kind: Crontab Metadata: Creation Timestamp: 2020-02-05T06:09:10Z Generation: 1 Resource Version: 19965 Self Link: /apis/chenwen.com/v2/namespaces/default/crontabs/my-test-crontab UID: 27beca8a-0ddb-4861-8643-90bb2f850b0d Spec: Cron Spec: * * * * */10 Image: my-test-image Replicas: 2 Events: \u0026lt;none\u0026gt; root@de001:/develop#  rancherå¯åŠ¨çš„æ—¶å€™ä¹Ÿä¼šç»™K8Sæ³¨å†Œä¸€äº›CRD\nä¸å¤ªæ¸…æ¥šè¿™æ ·åˆ›å»ºçš„CRDé‡Œç”¨rancherçš„APIæ˜¯å¦èƒ½çœ‹åˆ°ï¼ˆrancherç¯å¢ƒæœªæ­å»ºå¥½æµ‹è¯• ï¼‰\næ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡\napiVersion: chenwen.com/v2 kind: Crontab metadata: name: my-test-crontab spec: cronSpec: \u0026quot;* * * * */10\u0026quot; image: my-test-image replicas: 2  å¯¼å…¥\nkubectl apply -f test_crd.yml kubectl get ct #åˆ é™¤è‡ªå®šä¹‰å¯¹è±¡ kubectl delete ct my-test-crontab #åˆ é™¤CRD kubectl delete crd crontabs.chenwen.com  è¿è¡Œç»“æœï¼š\nroot@de001:/develop# kubectl get crd|grep cron crontabs.chenwen.com 2020-02-05T06:08:53Z root@de001:/develop# kubectl get ct NAME AGE my-test-crontab 75s root@de001:/develop#  3.ä»£ç ç”Ÿæˆ å…ˆåœ¨gopathä¸‹å»ºç«‹å¦‚ä¸‹ç›®å½•\ngo â””â”€â”€ src â””â”€â”€ github.com â””â”€â”€ examplechen â””â”€â”€ go.mod â””â”€â”€ hack â””â”€â”€ pkg â””â”€â”€ apis â””â”€â”€ chenwen.com â””â”€â”€ v1 â”œâ”€â”€ doc.go â””â”€â”€ types.go â””â”€â”€ pkg â””â”€â”€ bin  ç„¶åå®‰è£…https://github.com/kubernetes/code-generator é¡¹ç›®çš„ä»£ç åˆ°gopathä¸‹ã€‚\ndoc.goæ–‡ä»¶å†…å®¹\n// FileName: doc.go // Distributed under terms of the GPL license. // +k8s:deepcopy-gen=package // Package v1 is the v1 version of the API. // +groupName=chenwen.com package v1  ä¸Šè¿°ä»£ç ä¸­çš„ä¸¤è¡Œæ³¨é‡Šï¼Œéƒ½æ˜¯ä»£ç ç”Ÿæˆå·¥å…·ä¼šç”¨åˆ°çš„ï¼Œä¸€ä¸ªæ˜¯å£°æ˜ä¸ºæ•´ä¸ªv1åŒ…ä¸‹çš„ç±»å‹å®šä¹‰ç”ŸæˆDeepCopyæ–¹æ³•ï¼Œå¦ä¸€ä¸ªå£°æ˜äº†è¿™ä¸ªåŒ…å¯¹åº”çš„APIçš„ç»„åï¼Œå’ŒCRDä¸­çš„ç»„åä¸€è‡´\nâ€œ// +k8s:deepcopy-gen=packageâ€ï¼šä¸ºè¿™ä¸ªpackageä¸­çš„æ‰€æœ‰typeç”Ÿæˆdeepcopyä»£ç ã€‚\nâ€œ// +groupName=crd.lijiaocn.comâ€ï¼šè®¾ç½®è¿™ä¸ªpackageå¯¹åº”çš„api groupã€‚\ntypes.goæ–‡ä»¶å†…å®¹\npackage v1 import ( metav1 \u0026quot;k8s.io/apimachinery/pkg/apis/meta/v1\u0026quot; ) // +genclient // +genclient:noStatus // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object // CronTab is a top-level type. A client is created for it. // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object type Crontab struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` // +optional metav1.ObjectMeta `json:\u0026quot;metadata,omitempty\u0026quot;` // Username unique username of the consumer. Username string `json:\u0026quot;username,omitempty\u0026quot;` // CustomID existing unique ID for the consumer - useful for mapping // Kong with users in your existing database CustomID string `json:\u0026quot;custom_id,omitempty\u0026quot;` // Spec is the custom resource spec Spec CrontabSpec `json:\u0026quot;spec\u0026quot;` } // the spec for a MyResource resource type CrontabSpec struct { Min int `json:\u0026quot;min\u0026quot;` } // +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object type CrontabList struct { metav1.TypeMeta `json:\u0026quot;,inline\u0026quot;` metav1.ListMeta `json:\u0026quot;metadata\u0026quot;` Items []Crontab `json:\u0026quot;items\u0026quot;` } // Configuration contains a plugin configuration // +k8s:deepcopy-gen=false type Configuration map[string]interface{}  â€œ// +genclientâ€ï¼šä¸ºè¯¥typeç”Ÿæˆclientä»£ç ã€‚\nâ€œ// +genclient:noStatusâ€ï¼šä¸ºè¯¥typeç”Ÿæˆçš„clientä»£ç ï¼Œä¸åŒ…å«UpdateStatusæ–¹æ³•ã€‚\nâ€œ// +genclient:nonNamespacedâ€ï¼šå¦‚æœæ˜¯é›†ç¾¤èµ„æºï¼Œè®¾ç½®ä¸ºä¸å¸¦namespaceã€‚\nè¿˜æ”¯æŒåœ¨æ³¨é‡Šä¸­ä½¿ç”¨ä»¥ä¸‹tagï¼š\n// +genclient:noVerbs // +genclient:onlyVerbs=create,delete // +genclient:skipVerbs=get,list,create,update,patch,delete,deleteCollection,watch // +genclient:method=Create,verb=create,result=k8s.io/apimachinery/pkg/apis/meta/v1.Status  ==CrontabSpecç»“æ„ä½“çš„å­—æ®µä¸éœ€è¦å’Œyamlæ–‡ä»¶é‡Œçš„Spec éƒ¨åˆ†ä¸€ä¸€å¯¹åº”==ã€‚\nåŒçº§ç›®å½•ç¼–å†™register.go (è¿™ä¸ªæ–‡ä»¶éå¿…é¡»ï¼Œæ­¤æ–‡ä»¶çš„ä½œç”¨æ˜¯é€šè¿‡addKnownTypesæ–¹æ³•ä½¿å¾—clientå¯ä»¥çŸ¥é“Crontabç±»å‹çš„APIå¯¹è±¡)\npackage v1 import ( metav1 \u0026quot;k8s.io/apimachinery/pkg/apis/meta/v1\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/runtime\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/runtime/schema\u0026quot; examplecom \u0026quot;github.com/examplechen/pkg/apis/chenwen.com\u0026quot; ) // SchemeGroupVersion is group version used to register these objects var SchemeGroupVersion = schema.GroupVersion{Group: examplecom.GroupName, Version: \u0026quot;v1\u0026quot;} // Resource takes an unqualified resource and returns a Group qualified GroupResource func Resource(resource string) schema.GroupResource { return SchemeGroupVersion.WithResource(resource).GroupResource() } var ( // localSchemeBuilder and AddToScheme will stay in k8s.io/kubernetes. SchemeBuilder runtime.SchemeBuilder localSchemeBuilder = \u0026amp;SchemeBuilder AddToScheme = localSchemeBuilder.AddToScheme ) func init() { // We only register manually written functions here. The registration of the // generated functions takes place in the generated files. The separation // makes the code compile even when the generated files are missing. localSchemeBuilder.Register(addKnownTypes) } // Adds the list of known types to api.Scheme. func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026amp;Crontab{}, \u0026amp;CrontabList{}, ) metav1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil }  go.modæ–‡ä»¶å†…å®¹\nmodule github.com/examplechen go 1.13  ç”Ÿæˆä»£ç åªéœ€è¦ä»¥ä¸Šä¸‰ä¸ªæ–‡ä»¶å’Œå…¶å¯¹åº”çš„ç›®å½•ç»“æ„\nç”Ÿæˆä»£ç \n[koudai@koudai-pc v1]$ /develop/go/src/k8s.io/code-generator/generate-groups.sh all github.com/examplechen/pkg/client/crontab github.com/examplechen/pkg/apis chenwen.com:v1 Generating deepcopy funcs Generating clientset for chenwen.com:v1 at github.com/examplechen/pkg/client/crontab/clientset Generating listers for chenwen.com:v1 at github.com/examplechen/pkg/client/crontab/listers Generating informers for chenwen.com:v1 at github.com/examplechen/pkg/client/crontab/informers  å°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯generate-groups.shå¿…é¡»æ˜¯==ç»å¯¹è·¯å¾„==ï¼Œä¸èƒ½æ˜¯è¿›å…¥åˆ°code-generatorç›®å½•ä¸‹æ‰§è¡Œç›¸å¯¹è·¯å¾„ï¼Œä¸ç„¶ä¼šæŠ¥æ‰¾ä¸åˆ°åŒ…çš„æŠ¥é”™ã€‚\nå¦å¤–ï¼Œéœ€è¦è¿›å…¥åˆ°examplechenç›®å½•æ‰§è¡Œï¼Œä¸ç„¶ä¼šæŠ¥è«åå…¶å¦™å¦‚ä¸‹çš„é”™è¯¯\nGenerating deepcopy funcs F0210 17:31:46.418659 16605 deepcopy.go:885] Hit an unsupported type invalid type for invalid type, from github.com/examplechen/pkg/apis/chenwen.com/v1.Crontab  ç”Ÿæˆåçš„ç›®å½•æ ‘å¦‚ä¸‹ï¼š\n[koudai@koudai-pc examplechen]$ tree . â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ hack â”‚Â â””â”€â”€ boilerplate.go.txt â””â”€â”€ pkg â”œâ”€â”€ apis â”‚Â â””â”€â”€ chenwen.com â”‚Â â”œâ”€â”€ register.go â”‚Â â””â”€â”€ v1 â”‚Â â”œâ”€â”€ doc.go â”‚Â â”œâ”€â”€ types.go â”‚Â â””â”€â”€ zz_generated.deepcopy.go â””â”€â”€ client â””â”€â”€ crontab â”œâ”€â”€ clientset â”‚Â â””â”€â”€ versioned â”‚Â â”œâ”€â”€ clientset.go â”‚Â â”œâ”€â”€ doc.go â”‚Â â”œâ”€â”€ fake â”‚Â â”‚Â â”œâ”€â”€ clientset_generated.go â”‚Â â”‚Â â”œâ”€â”€ doc.go â”‚Â â”‚Â â””â”€â”€ register.go â”‚Â â”œâ”€â”€ scheme â”‚Â â”‚Â â”œâ”€â”€ doc.go â”‚Â â”‚Â â””â”€â”€ register.go â”‚Â â””â”€â”€ typed â”‚Â â””â”€â”€ chenwen.com â”‚Â â””â”€â”€ v1 â”‚Â â”œâ”€â”€ chenwen.com_client.go â”‚Â â”œâ”€â”€ crontab.go â”‚Â â”œâ”€â”€ doc.go â”‚Â â”œâ”€â”€ fake â”‚Â â”‚Â â”œâ”€â”€ doc.go â”‚Â â”‚Â â”œâ”€â”€ fake_chenwen.com_client.go â”‚Â â”‚Â â””â”€â”€ fake_crontab.go â”‚Â â””â”€â”€ generated_expansion.go â”œâ”€â”€ informers â”‚Â â””â”€â”€ externalversions â”‚Â â”œâ”€â”€ chenwen.com â”‚Â â”‚Â â”œâ”€â”€ interface.go â”‚Â â”‚Â â””â”€â”€ v1 â”‚Â â”‚Â â”œâ”€â”€ crontab.go â”‚Â â”‚Â â””â”€â”€ interface.go â”‚Â â”œâ”€â”€ factory.go â”‚Â â”œâ”€â”€ generic.go â”‚Â â””â”€â”€ internalinterfaces â”‚Â â””â”€â”€ factory_interfaces.go â””â”€â”€ listers â””â”€â”€ chenwen.com â””â”€â”€ v1 â”œâ”€â”€ crontab.go â””â”€â”€ expansion_generated.go 23 directories, 29 files  4.ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç  examplechen ä¸‹æ–°å»ºmain.goç”¨æ¥æµ‹è¯•\npackage main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;github.com/golang/glog\u0026quot; metav1 \u0026quot;k8s.io/apimachinery/pkg/apis/meta/v1\u0026quot; \u0026quot;k8s.io/client-go/tools/clientcmd\u0026quot; \u0026quot;k8s.io/client-go/rest\u0026quot; examplecomclientset \u0026quot;github.com/examplechen/pkg/client/crontab/clientset/versioned\u0026quot; ) var ( kuberconfig = flag.String(\u0026quot;kubeconfig\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;Path to a kubeconfig. Only required if out-of-cluster.\u0026quot;) master = flag.String(\u0026quot;master\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.\u0026quot;) ) func main() { flag.Parse() cfg, err := buildConfig(\u0026quot;https://127.0.0.1:6443\u0026quot;, \u0026quot;/root/.kube/config\u0026quot;) if err != nil { fmt.Printf(\u0026quot;%v\\n\u0026quot;, err) return } exampleClient, err := examplecomclientset.NewForConfig(cfg) if err != nil { glog.Fatalf(\u0026quot;Error building example clientset: %v\u0026quot;, err) } list, err := exampleClient.ChenwenV1().Crontabs(\u0026quot;default\u0026quot;).List(metav1.ListOptions{}) if err != nil { glog.Fatalf(\u0026quot;Error listing all databases: %v\u0026quot;, err) } for _, db := range list.Items { fmt.Printf(\u0026quot;database %s with user %q\\n\u0026quot;, db.Name, db.Spec.Min) } } func buildConfig(master, kubeconfig string) (*rest.Config, error) { if master != \u0026quot;\u0026quot; || kubeconfig != \u0026quot;\u0026quot; { return clientcmd.BuildConfigFromFlags(master, kubeconfig) } return rest.InClusterConfig() }  ç¼–è¯‘é€šè¿‡ï¼Œä½†è¿è¡ŒæŠ¥é”™ã€‚\nF0210 14:19:32.477583 1845 main.go:39] Error listing all databases: the server could not find the requested resource (get crontabs.chenwen.com)  ç»æ£€æŸ¥ï¼Œæ˜¯ç‰ˆæœ¬å·ä¸ä¸€è‡´é€ æˆï¼Œå°†ymlæ–‡ä»¶é‡Œçš„ç‰ˆæœ¬å·v2æ¢æˆv1ï¼Œå¦ä¸€ä¸ªymlæ–‡ä»¶åŒç†\nspec: # group name to use for REST API: /apis/\u0026lt;group\u0026gt;/\u0026lt;version\u0026gt; group: chenwen.com # list of versions supported by this CustomResourceDefinition versions: - name: v1 # æŠŠv2æ¢æˆv1ï¼Œéœ€è¦å’ŒAPIå¯¹åº”  é‡æ–°ç¼–è¯‘ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼Œç¬¦åˆé¢„æœŸ\n#go build #./examplechenold -kubeconfig=$HOME/.kube/config database my-test-crontab with user '\\x00' database my-test-crontab2 with user '\\x00'  5.è¿›ä¸€æ­¥äº†è§£API å†å†™ä¸ªç¨å¾®å¤æ‚ç‚¹çš„ä¾‹å­\nåœ¨ é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºcontroller.goæ–‡ä»¶\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;time\u0026quot; \u0026quot;github.com/golang/glog\u0026quot; corev1 \u0026quot;k8s.io/api/core/v1\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/api/errors\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/util/runtime\u0026quot; utilruntime \u0026quot;k8s.io/apimachinery/pkg/util/runtime\u0026quot; \u0026quot;k8s.io/apimachinery/pkg/util/wait\u0026quot; \u0026quot;k8s.io/client-go/kubernetes\u0026quot; \u0026quot;k8s.io/client-go/kubernetes/scheme\u0026quot; typedcorev1 \u0026quot;k8s.io/client-go/kubernetes/typed/core/v1\u0026quot; \u0026quot;k8s.io/client-go/tools/cache\u0026quot; \u0026quot;k8s.io/client-go/tools/record\u0026quot; \u0026quot;k8s.io/client-go/util/workqueue\u0026quot; bolingcavalryv1 \u0026quot;github.com/examplechen/pkg/apis/chenwen.com/v1\u0026quot; clientset \u0026quot;github.com/examplechen/pkg/client/crontab/clientset/versioned\u0026quot; cronscheme \u0026quot;github.com/examplechen/pkg/client/crontab/clientset/versioned/scheme\u0026quot; informers \u0026quot;github.com/examplechen/pkg/client/crontab/informers/externalversions/chenwen.com/v1\u0026quot; listers \u0026quot;github.com/examplechen/pkg/client/crontab/listers/chenwen.com/v1\u0026quot; ) const controllerAgentName = \u0026quot;student-controller\u0026quot; const ( SuccessSynced = \u0026quot;Synced\u0026quot; MessageResourceSynced = \u0026quot;Student synced successfully\u0026quot; ) // Controller is the controller implementation for Student resources type Controller struct { // kubeclientset is a standard kubernetes clientset kubeclientset kubernetes.Interface // cronclientset is a clientset for our own API group cronclientset clientset.Interface cronsLister listers.CrontabLister cronsSynced cache.InformerSynced workqueue workqueue.RateLimitingInterface recorder record.EventRecorder } // NewController returns a new student controller func NewController( kubeclientset kubernetes.Interface, cronclientset clientset.Interface, cronInformer informers.CrontabInformer) *Controller { utilruntime.Must(cronscheme.AddToScheme(scheme.Scheme)) glog.V(4).Info(\u0026quot;Creating event broadcaster\u0026quot;) eventBroadcaster := record.NewBroadcaster() eventBroadcaster.StartLogging(glog.Infof) eventBroadcaster.StartRecordingToSink(\u0026amp;typedcorev1.EventSinkImpl{Interface: kubeclientset.CoreV1().Events(\u0026quot;\u0026quot;)}) recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource{Component: controllerAgentName}) controller := \u0026amp;Controller{ kubeclientset: kubeclientset, cronclientset: cronclientset, cronsLister: cronInformer.Lister(), cronsSynced: cronInformer.Informer().HasSynced, workqueue: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026quot;Students\u0026quot;), recorder: recorder, } glog.Info(\u0026quot;Setting up event handlers\u0026quot;) // Set up an event handler for when Student resources change cronInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: controller.enqueueStudent, UpdateFunc: func(old, new interface{}) { oldStudent := old.(*bolingcavalryv1.Crontab) newStudent := new.(*bolingcavalryv1.Crontab) if oldStudent.ResourceVersion == newStudent.ResourceVersion { //ç‰ˆæœ¬ä¸€è‡´ï¼Œå°±è¡¨ç¤ºæ²¡æœ‰å®é™…æ›´æ–°çš„æ“ä½œï¼Œç«‹å³è¿”å› return } controller.enqueueStudent(new) }, DeleteFunc: controller.enqueueStudentForDelete, }) return controller } //åœ¨æ­¤å¤„å¼€å§‹controllerçš„ä¸šåŠ¡ func (c *Controller) Run(threadiness int, stopCh \u0026lt;-chan struct{}) error { defer runtime.HandleCrash() defer c.workqueue.ShutDown() glog.Info(\u0026quot;å¼€å§‹controllerä¸šåŠ¡ï¼Œå¼€å§‹ä¸€æ¬¡ç¼“å­˜æ•°æ®åŒæ­¥\u0026quot;) if ok := cache.WaitForCacheSync(stopCh, c.cronsSynced); !ok { return fmt.Errorf(\u0026quot;failed to wait for caches to sync\u0026quot;) } glog.Info(\u0026quot;workerå¯åŠ¨\u0026quot;) for i := 0; i \u0026lt; threadiness; i++ { go wait.Until(c.runWorker, time.Second, stopCh) } glog.Info(\u0026quot;workerå·²ç»å¯åŠ¨\u0026quot;) \u0026lt;-stopCh glog.Info(\u0026quot;workerå·²ç»ç»“æŸ\u0026quot;) return nil } func (c *Controller) runWorker() { for c.processNextWorkItem() { } } // å–æ•°æ®å¤„ç† func (c *Controller) processNextWorkItem() bool { obj, shutdown := c.workqueue.Get() if shutdown { return false } // We wrap this block in a func so we can defer c.workqueue.Done. err := func(obj interface{}) error { defer c.workqueue.Done(obj) var key string var ok bool if key, ok = obj.(string); !ok { c.workqueue.Forget(obj) runtime.HandleError(fmt.Errorf(\u0026quot;expected string in workqueue but got %#v\u0026quot;, obj)) return nil } // åœ¨syncHandlerä¸­å¤„ç†ä¸šåŠ¡ if err := c.syncHandler(key); err != nil { return fmt.Errorf(\u0026quot;error syncing '%s': %s\u0026quot;, key, err.Error()) } c.workqueue.Forget(obj) glog.Infof(\u0026quot;Successfully synced '%s'\u0026quot;, key) return nil }(obj) if err != nil { runtime.HandleError(err) return true } return true } // å¤„ç† func (c *Controller) syncHandler(key string) error { // Convert the namespace/name string into a distinct namespace and name namespace, name, err := cache.SplitMetaNamespaceKey(key) if err != nil { runtime.HandleError(fmt.Errorf(\u0026quot;invalid resource key: %s\u0026quot;, key)) return nil } // ä»ç¼“å­˜ä¸­å–å¯¹è±¡ student, err := c.cronsLister.Crontabs(namespace).Get(name) if err != nil { // å¦‚æœCronå¯¹è±¡è¢«åˆ é™¤äº†ï¼Œå°±ä¼šèµ°åˆ°è¿™é‡Œï¼Œæ‰€ä»¥åº”è¯¥åœ¨è¿™é‡ŒåŠ å…¥æ‰§è¡Œ if errors.IsNotFound(err) { glog.Infof(\u0026quot;Studentå¯¹è±¡è¢«åˆ é™¤ï¼Œè¯·åœ¨è¿™é‡Œæ‰§è¡Œå®é™…çš„åˆ é™¤ä¸šåŠ¡: %s/%s ...\u0026quot;, namespace, name) return nil } runtime.HandleError(fmt.Errorf(\u0026quot;failed to list student by: %s/%s\u0026quot;, namespace, name)) return err } glog.Infof(\u0026quot;è¿™é‡Œæ˜¯cronå¯¹è±¡çš„æœŸæœ›çŠ¶æ€: %#v ...\u0026quot;, student) glog.Infof(\u0026quot;å®é™…çŠ¶æ€æ˜¯ä»ä¸šåŠ¡å±‚é¢å¾—åˆ°çš„ï¼Œæ­¤å¤„åº”è¯¥å»çš„å®é™…çŠ¶æ€ï¼Œä¸æœŸæœ›çŠ¶æ€åšå¯¹æ¯”ï¼Œå¹¶æ ¹æ®å·®å¼‚åšå‡ºå“åº”(æ–°å¢æˆ–è€…åˆ é™¤)\u0026quot;) c.recorder.Event(student, corev1.EventTypeNormal, SuccessSynced, MessageResourceSynced) return nil } // æ•°æ®å…ˆæ”¾å…¥ç¼“å­˜ï¼Œå†å…¥é˜Ÿåˆ— func (c *Controller) enqueueStudent(obj interface{}) { var key string var err error // å°†å¯¹è±¡æ”¾å…¥ç¼“å­˜ if key, err = cache.MetaNamespaceKeyFunc(obj); err != nil { runtime.HandleError(err) return } // å°†keyæ”¾å…¥é˜Ÿåˆ— c.workqueue.AddRateLimited(key) } // åˆ é™¤æ“ä½œ func (c *Controller) enqueueStudentForDelete(obj interface{}) { var key string var err error // ä»ç¼“å­˜ä¸­åˆ é™¤æŒ‡å®šå¯¹è±¡ key, err = cache.DeletionHandlingMetaNamespaceKeyFunc(obj) if err != nil { runtime.HandleError(err) return } //å†å°†keyæ”¾å…¥é˜Ÿåˆ— c.workqueue.AddRateLimited(key) }  ç„¶åæ˜¯ main.go\npackage main import ( \u0026quot;flag\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;time\u0026quot; \u0026quot;github.com/golang/glog\u0026quot; \u0026quot;k8s.io/client-go/tools/clientcmd\u0026quot; \u0026quot;k8s.io/client-go/kubernetes\u0026quot; informers \u0026quot;github.com/examplechen/pkg/client/crontab/informers/externalversions\u0026quot; \u0026quot;github.com/examplechen/pkg/signals\u0026quot; examplecomclientset \u0026quot;github.com/examplechen/pkg/client/crontab/clientset/versioned\u0026quot; ) var ( kubeconfig string master string ) func main() { flag.Parse() // å¤„ç†ä¿¡å·é‡ stopCh := signals.SetupSignalHandler() cfg, err := clientcmd.BuildConfigFromFlags(master, kubeconfig) if err != nil { fmt.Printf(\u0026quot;%v\\n\u0026quot;, err) return } kubeClient, err := kubernetes.NewForConfig(cfg) if err != nil { glog.Fatalf(\u0026quot;Error building kubernetes clientset: %s\u0026quot;, err.Error()) } exampleClient, err := examplecomclientset.NewForConfig(cfg) if err != nil { glog.Fatalf(\u0026quot;Error building example clientset: %v\u0026quot;, err) } studentInformerFactory := informers.NewSharedInformerFactory(exampleClient, time.Second*30) //å¾—åˆ°controller controller := NewController(kubeClient, exampleClient, studentInformerFactory.Chenwen().V1().Crontabs()) //å¯åŠ¨informer go studentInformerFactory.Start(stopCh) //controllerå¼€å§‹å¤„ç†æ¶ˆæ¯ if err = controller.Run(2, stopCh); err != nil { glog.Fatalf(\u0026quot;Error running controller: %s\u0026quot;, err.Error()) } } func init() { flag.StringVar(\u0026amp;kubeconfig, \u0026quot;kubeconfig\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;Path to a kubeconfig. Only required if out-of-cluster.\u0026quot;) flag.StringVar(\u0026amp;master, \u0026quot;master\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.\u0026quot;) }  ç¼–è¯‘è¿è¡Œ\nroot@de001:/develop# ./examplechen -kubeconfig=$HOME/.kube/config I0210 17:40:22.161175 18552 controller.go:72] Setting up event handlers I0210 17:40:22.161769 18552 controller.go:96] å¼€å§‹controllerä¸šåŠ¡ï¼Œå¼€å§‹ä¸€æ¬¡ç¼“å­˜æ•°æ®åŒæ­¥ I0210 17:40:22.262540 18552 controller.go:101] workerå¯åŠ¨ I0210 17:40:22.262616 18552 controller.go:106] workerå·²ç»å¯åŠ¨ I0210 17:40:22.262693 18552 controller.go:181] è¿™é‡Œæ˜¯studentå¯¹è±¡çš„æœŸæœ›çŠ¶æ€: \u0026amp;v1.Crontab{TypeMeta:v1.TypeMeta{Kind:\u0026quot;Crontab\u0026quot;, APIVersion:\u0026quot;chenwen.com/v1\u0026quot;}, ObjectMeta:v1.ObjectMeta{Name:\u0026quot;my-test-crontab2\u0026quot;, GenerateName:\u0026quot;\u0026quot;, Namespace:\u0026quot;default\u0026quot;, SelfLink:\u0026quot;/apis/chenwen.com/v1/namespaces/default/crontabs/my-test-crontab2\u0026quot;, UID:\u0026quot;ab5e00e6-88e4-4b7e-b587-f5797baec3eb\u0026quot;, ResourceVersion:\u0026quot;29576\u0026quot;, Generation:1, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63716923534, loc:(*time.Location)(0x1e56c60)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string{\u0026quot;kubectl.kubernetes.io/last-applied-configuration\u0026quot;:\u0026quot;{\\\u0026quot;apiVersion\\\u0026quot;:\\\u0026quot;chenwen.com/v1\\\u0026quot;,\\\u0026quot;kind\\\u0026quot;:\\\u0026quot;Crontab\\\u0026quot;,\\\u0026quot;metadata\\\u0026quot;:{\\\u0026quot;annotations\\\u0026quot;:{},\\\u0026quot;name\\\u0026quot;:\\\u0026quot;my-test-crontab2\\\u0026quot;,\\\u0026quot;namespace\\\u0026quot;:\\\u0026quot;default\\\u0026quot;},\\\u0026quot;spec\\\u0026quot;:{\\\u0026quot;cronSpec\\\u0026quot;:\\\u0026quot;* * * * */10\\\u0026quot;,\\\u0026quot;image\\\u0026quot;:\\\u0026quot;my-test-image\\\u0026quot;,\\\u0026quot;replicas\\\u0026quot;:2}}\\n\u0026quot;}, OwnerReferences:[]v1.OwnerReference(nil), Finalizers:[]string(nil), ClusterName:\u0026quot;\u0026quot;, ManagedFields:[]v1.ManagedFieldsEntry(nil)}, Username:\u0026quot;\u0026quot;, CustomID:\u0026quot;\u0026quot;, Spec:v1.CrontabSpec{Min:0}} ... I0210 17:40:22.262988 18552 controller.go:182] å®é™…çŠ¶æ€æ˜¯ä»ä¸šåŠ¡å±‚é¢å¾—åˆ°çš„ï¼Œæ­¤å¤„åº”è¯¥å»çš„å®é™…çŠ¶æ€ï¼Œä¸æœŸæœ›çŠ¶æ€åšå¯¹æ¯”ï¼Œå¹¶æ ¹æ®å·®å¼‚åšå‡ºå“åº”(æ–°å¢æˆ–è€…åˆ é™¤) I0210 17:40:22.263039 18552 controller.go:145] Successfully synced 'default/my-test-crontab2' I0210 17:40:22.263063 18552 controller.go:181] è¿™é‡Œæ˜¯studentå¯¹è±¡çš„æœŸæœ›çŠ¶æ€: \u0026amp;v1.Crontab{TypeMeta:v1.TypeMeta{Kind:\u0026quot;Crontab\u0026quot;, APIVersion:\u0026quot;chenwen.com/v1\u0026quot;}, ObjectMeta:v1.ObjectMeta{Name:\u0026quot;my-test-crontab\u0026quot;, GenerateName:\u0026quot;\u0026quot;, Namespace:\u0026quot;default\u0026quot;, SelfLink:\u0026quot;/apis/chenwen.com/v1/namespaces/default/crontabs/my-test-crontab\u0026quot;, UID:\u0026quot;72036436-451a-4ec5-9851-bc27342faa5f\u0026quot;, ResourceVersion:\u0026quot;29532\u0026quot;, Generation:1, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63716923360, loc:(*time.Location)(0x1e56c60)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string{\u0026quot;kubectl.kubernetes.io/last-applied-configuration\u0026quot;:\u0026quot;{\\\u0026quot;apiVersion\\\u0026quot;:\\\u0026quot;chenwen.com/v1\\\u0026quot;,\\\u0026quot;kind\\\u0026quot;:\\\u0026quot;Crontab\\\u0026quot;,\\\u0026quot;metadata\\\u0026quot;:{\\\u0026quot;annotations\\\u0026quot;:{},\\\u0026quot;name\\\u0026quot;:\\\u0026quot;my-test-crontab\\\u0026quot;,\\\u0026quot;namespace\\\u0026quot;:\\\u0026quot;default\\\u0026quot;},\\\u0026quot;spec\\\u0026quot;:{\\\u0026quot;cronSpec\\\u0026quot;:\\\u0026quot;* * * * */10\\\u0026quot;,\\\u0026quot;image\\\u0026quot;:\\\u0026quot;my-test-image\\\u0026quot;,\\\u0026quot;replicas\\\u0026quot;:2}}\\n\u0026quot;}, OwnerReferences:[]v1.OwnerReference(nil), Finalizers:[]string(nil), ClusterName:\u0026quot;\u0026quot;, ManagedFields:[]v1.ManagedFieldsEntry(nil)}, Username:\u0026quot;\u0026quot;, CustomID:\u0026quot;\u0026quot;, Spec:v1.CrontabSpec{Min:0}} ... I0210 17:40:22.263157 18552 controller.go:182] å®é™…çŠ¶æ€æ˜¯ä»ä¸šåŠ¡å±‚é¢å¾—åˆ°çš„ï¼Œæ­¤å¤„åº”è¯¥å»çš„å®é™…çŠ¶æ€ï¼Œä¸æœŸæœ›çŠ¶æ€åšå¯¹æ¯”ï¼Œå¹¶æ ¹æ®å·®å¼‚åšå‡ºå“åº”(æ–°å¢æˆ–è€…åˆ é™¤) I0210 17:40:22.263185 18552 controller.go:145] Successfully synced 'default/my-test-crontab' I0210 17:40:22.265730 18552 event.go:278] Event(v1.ObjectReference{Kind:\u0026quot;Crontab\u0026quot;, Namespace:\u0026quot;default\u0026quot;, Name:\u0026quot;my-test-crontab\u0026quot;, UID:\u0026quot;72036436-451a-4ec5-9851-bc27342faa5f\u0026quot;, APIVersion:\u0026quot;chenwen.com/v1\u0026quot;, ResourceVersion:\u0026quot;29532\u0026quot;, FieldPath:\u0026quot;\u0026quot;}): type: 'Normal' reason: 'Synced' Student synced successfully I0210 17:40:22.265885 18552 event.go:278] Event(v1.ObjectReference{Kind:\u0026quot;Crontab\u0026quot;, Namespace:\u0026quot;default\u0026quot;, Name:\u0026quot;my-test-crontab2\u0026quot;, UID:\u0026quot;ab5e00e6-88e4-4b7e-b587-f5797baec3eb\u0026quot;, APIVersion:\u0026quot;chenwen.com/v1\u0026quot;, ResourceVersion:\u0026quot;29576\u0026quot;, FieldPath:\u0026quot;\u0026quot;}): type: 'Normal' reason: 'Synced' Student synced successfully I0210 17:41:00.324824 18552 controller.go:181] è¿™é‡Œæ˜¯studentå¯¹è±¡çš„æœŸæœ›çŠ¶æ€: \u0026amp;v1.Crontab{TypeMeta:v1.TypeMeta{Kind:\u0026quot;\u0026quot;, APIVersion:\u0026quot;\u0026quot;}, ObjectMeta:v1.ObjectMeta{Name:\u0026quot;my-test-crontab2\u0026quot;, GenerateName:\u0026quot;\u0026quot;, Namespace:\u0026quot;default\u0026quot;, SelfLink:\u0026quot;/apis/chenwen.com/v1/namespaces/default/crontabs/my-test-crontab2\u0026quot;, UID:\u0026quot;ab5e00e6-88e4-4b7e-b587-f5797baec3eb\u0026quot;, ResourceVersion:\u0026quot;29811\u0026quot;, Generation:2, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63716923534, loc:(*time.Location)(0x1e56c60)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string{\u0026quot;kubectl.kubernetes.io/last-applied-configuration\u0026quot;:\u0026quot;{\\\u0026quot;apiVersion\\\u0026quot;:\\\u0026quot;chenwen.com/v1\\\u0026quot;,\\\u0026quot;kind\\\u0026quot;:\\\u0026quot;Crontab\\\u0026quot;,\\\u0026quot;metadata\\\u0026quot;:{\\\u0026quot;annotations\\\u0026quot;:{},\\\u0026quot;name\\\u0026quot;:\\\u0026quot;my-test-crontab2\\\u0026quot;,\\\u0026quot;namespace\\\u0026quot;:\\\u0026quot;default\\\u0026quot;},\\\u0026quot;spec\\\u0026quot;:{\\\u0026quot;cronSpec\\\u0026quot;:\\\u0026quot;* 5 * * */10\\\u0026quot;,\\\u0026quot;image\\\u0026quot;:\\\u0026quot;my-test-image\\\u0026quot;,\\\u0026quot;replicas\\\u0026quot;:2}}\\n\u0026quot;}, OwnerReferences:[]v1.OwnerReference(nil), Finalizers:[]string(nil), ClusterName:\u0026quot;\u0026quot;, ManagedFields:[]v1.ManagedFieldsEntry(nil)}, Username:\u0026quot;\u0026quot;, CustomID:\u0026quot;\u0026quot;, Spec:v1.CrontabSpec{Min:0}} ...  6.éªŒè¯controller æ–°å¼€ä¸€ä¸ªçª—å£è¿æ¥åˆ°k8sç¯å¢ƒï¼Œæ–°å»ºä¸€ä¸ªåä¸ºtest2_crd.ymlçš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹\napiVersion: chenwen.com/v1 kind: Crontab metadata: name: my-test-crontab2 spec: cronSpec: \u0026quot;* 5 * * */10\u0026quot; image: my-test-image replicas: 2  æ‰§è¡Œå‘½ä»¤\nkubectl apply -f test2_crd.yml  è¿”å›controlleræ‰€åœ¨çš„æ§åˆ¶å°çª—å£ï¼Œå‘ç°æ–°è¾“å‡ºäº†å¦‚ä¸‹å†…å®¹ï¼Œå¯è§æ–°å¢Crontabå¯¹è±¡çš„äº‹ä»¶å·²ç»è¢«controllerç›‘å¬å¹¶å¤„ç†ï¼š\nI0210 17:41:00.324974 18552 controller.go:182] å®é™…çŠ¶æ€æ˜¯ä»ä¸šåŠ¡å±‚é¢å¾—åˆ°çš„ï¼Œæ­¤å¤„åº”è¯¥å»çš„å®é™…çŠ¶æ€ï¼Œä¸æœŸæœ›çŠ¶æ€åšå¯¹æ¯”ï¼Œå¹¶æ ¹æ®å·®å¼‚åšå‡ºå“åº”(æ–°å¢æˆ–è€…åˆ é™¤) I0210 17:41:00.325006 18552 controller.go:145] Successfully synced 'default/my-test-crontab2' I0210 17:41:00.332401 18552 event.go:278] Event(v1.ObjectReference{Kind:\u0026quot;Crontab\u0026quot;, Namespace:\u0026quot;default\u0026quot;, Name:\u0026quot;my-test-crontab2\u0026quot;, UID:\u0026quot;ab5e00e6-88e4-4b7e-b587-f5797baec3eb\u0026quot;, APIVersion:\u0026quot;chenwen.com/v1\u0026quot;, ResourceVersion:\u0026quot;29811\u0026quot;, FieldPath:\u0026quot;\u0026quot;}): type: 'Normal' reason: 'Synced' Student synced successfully  æ¥ä¸‹æ¥æ‚¨ä¹Ÿå¯ä»¥å°è¯•ä¿®æ”¹å’Œåˆ é™¤å·²æœ‰çš„Crontabå¯¹è±¡ï¼Œè§‚å¯Ÿcontrolleræ§åˆ¶å°çš„è¾“å‡ºï¼Œç¡®å®šæ˜¯å¦å·²ç»ç›‘å¬åˆ°æ‰€æœ‰Crontabå˜åŒ–çš„äº‹ä»¶.\n7.æ€»ç»“ ä¸‰æ­¥èµ°ï¼š\n åˆ›å»ºCRDï¼ˆCustom Resource Definitionï¼‰ï¼Œä»¤k8sæ˜ç™½æˆ‘ä»¬è‡ªå®šä¹‰çš„APIå¯¹è±¡ï¼› ç¼–å†™ä»£ç ï¼Œå°†CRDçš„æƒ…å†µå†™å…¥å¯¹åº”çš„ä»£ç ä¸­ï¼Œç„¶åé€šè¿‡è‡ªåŠ¨ä»£ç ç”Ÿæˆå·¥å…·ï¼Œå°†controllerä¹‹å¤–çš„informerï¼Œclientç­‰å†…å®¹è¾ƒä¸ºå›ºå®šçš„ä»£ç é€šè¿‡å·¥å…·ç”Ÿæˆï¼› ç¼–å†™controllerï¼Œåœ¨é‡Œé¢åˆ¤æ–­å®é™…æƒ…å†µæ˜¯å¦è¾¾åˆ°äº†APIå¯¹è±¡çš„å£°æ˜æƒ…å†µï¼Œå¦‚æœæœªè¾¾åˆ°ï¼Œå°±è¦è¿›è¡Œå®é™…ä¸šåŠ¡å¤„ç†ï¼Œè€Œè¿™ä¹Ÿæ˜¯controllerçš„é€šç”¨åšæ³•ï¼›  å®é™…è¦è‡ªå·±åŠ¨æ‰‹å†™çš„æ–‡ä»¶ä¸å¤šï¼Œå°±3-4ä¸ªï¼Œä½†æ˜¯ç†è§£èµ·æ¥æ¯”è¾ƒéš¾ã€‚\n8.refer https://blog.csdn.net/weixin_41806245/article/details/94451734\nhttps://blog.csdn.net/aixiaoyang168/article/details/81875907\nhttps://github.com/kubernetes/sample-controller/blob/master/README.md\nhttps://blog.openshift.com/kubernetes-deep-dive-code-generation-customresources/\nhttps://www.jianshu.com/p/4910da4c8285\nhttps://blog.csdn.net/boling_cavalry/article/details/88924194\n","date":"2020-02-11","permalink":"https://iminto.github.io/post/k8s%E7%AE%A1%E7%90%86crd%E5%92%8Ck8sapi%E7%BC%96%E7%A8%8B/","tags":["k8s"],"title":"K8sç®¡ç†crdå’ŒK8SAPIç¼–ç¨‹"},{"content":"hadoop 3.1.2 å•æœºæ¨¡å¼å®‰è£…é…ç½® ç°åœ¨æå¤§æ•°æ®è®°å½•ä¸€ä¸‹ï¼Œæ–¹ä¾¿æŸ¥é˜…ã€‚\n1.å®‰è£…é…ç½®jdkå’Œä¸‹è½½hadoopç•¥ã€‚ hadoop ä¸‹è½½åœ°å€ï¼šhttp://mirror.bit.edu.cn/apache/hadoop/common/ ä½¿ç”¨äº†è¾ƒæ–°ä¸”ä¿å®ˆçš„3.1.2ç‰ˆæœ¬\n2.é…ç½®ä¿®æ”¹ ç¯å¢ƒå˜é‡ä¿®æ”¹\nexport HADOOP_HOME=/soft/hadoop export PATH=$PATH:$HADOOP_HOME/bin  é…ç½®etc/hadoop/hadoop-env.sh\nexport JAVA_HOME=/soft/java export HADOOP_HOME=/soft/hadoop  é…ç½®etc/hadoop/core-site.xml\n\u0026lt;configuration\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;hadoop.tmp.dir\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;file:///develop/data/hadoop\u0026lt;/value\u0026gt; \u0026lt;description\u0026gt;Abase for other temporary directories.\u0026lt;/description\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;fs.defaultFS\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;hdfs://192.168.0.104:8888\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/configuration\u0026gt;  é…ç½®etc/hadoop/hdfs-site.xml\n\u0026lt;configuration\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;dfs.replication\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;1\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;dfs.namenode.name.dir\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;file:///develop/data/hadoop/dfs/name\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;dfs.datanode.data.dir\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;file:///develop/data/hadoop/dfs/data\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;property\u0026gt; \u0026lt;name\u0026gt;dfs.datanode.du.reserved\u0026lt;/name\u0026gt; \u0026lt;value\u0026gt;1073741824\u0026lt;/value\u0026gt; \u0026lt;description\u0026gt;Reserved space in bytes per volume..\u0026lt;/description\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/configuration\u0026gt;  3.é…ç½®å…å¯†ç SSHç™»å½• ssh-keygen -t rsa cat ~/ssh/id_rsa.pub\u0026gt;\u0026gt;~/ssh/authorized_keys #ssh localhost æµ‹è¯•æ˜¯å¦æˆåŠŸ  4.å¯åŠ¨æµ‹è¯• #æ ¼å¼åŒ– hdfs namenode -format #å¯åŠ¨hdfs ./sbin/start-dfs.sh #åœæ­¢hdfs ./sbin/stop-dfs.sh #éªŒè¯æ˜¯å¦æˆåŠŸ http://localhost:9870/  è‡³æ­¤ï¼Œhadoopçš„å•æœºæ¨¡å¼åŸºæœ¬å®‰è£…ç»“æŸã€‚\nç®€å•çš„éªŒè¯hadoopå‘½ä»¤ï¼š\nhadoop fs -mkdir /test  åœ¨æµè§ˆå™¨ä¸­åº”è¯¥å¯ä»¥çœ‹åˆ°æ–°å»ºçš„ç›®å½•äº†ã€‚\næ³¨æ„ï¼š 1.ç½‘ä¸Šçš„æ•™ç¨‹å¾ˆå¤šæ˜¯2.xè€ç‰ˆæœ¬ï¼Œ3.1.0ç‰ˆæœ¬åï¼Œhdfsçš„web 50070ç«¯å£ -\u0026gt; 9870ç«¯å£äº† ã€‚\n2.å¦‚æœwebHDFSå‡ºé”™ï¼Œæç¤º\u0026quot;Failed to retrieve data from /webhdfs/v1/?op=LISTSTATUS:Server Errorâ€œï¼Œä¹Ÿæ— æ³•é€è¿‡Webç•Œé¢ä¸Šä¼ æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯JDKç‰ˆæœ¬è¿‡é«˜å¼•èµ·çš„ï¼Œç›®å‰hadoopè¿˜åªæ”¯æŒJDK8ç‰ˆæœ¬ã€‚å¦‚æœæ˜¯JDK9ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥ç¼–è¾‘hadoop-env.sh\nexport HADOOP_OPTS=\u0026quot;--add-modules java.activation\u0026quot;  3.ä¸Šä¼ æ–‡ä»¶/åˆ›å»ºç›®å½•æŠ¥é”™ Permission Deniedï¼Œä¿®æ”¹hdfs-site.xmlï¼Œè®¾å®šdfs.permissions=falseã€‚æŒ‰ç…§æœ¬æ–‡çš„æœ€æ–°é…ç½®å°±ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚\n","date":"2019-08-25","permalink":"https://iminto.github.io/post/hadoop3.1.2%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/","tags":["Java"],"title":"hadoop 3.1.2 å•æœºæ¨¡å¼å®‰è£…é…ç½®"},{"content":"äº’è”ç½‘ä½æ½®ï¼Œè€æ˜¯ä¼šçœ‹åˆ°åˆ«äººå‘é¢è¯•ç»éªŒï¼Œçœ‹åˆ°å¾ˆå¤šäººè°ˆä¹è§‚é”ï¼Œè°ˆCASï¼Œä½†æ˜¯éƒ½æ²¡æœ‰è¯´æ¸…æ¥šã€‚å¿ä¸ä½å¨å¨å‡ å¥ã€‚\né‚£ä»€ä¹ˆæ˜¯ä¹è§‚é”å‘¢ï¼Œæ¯”è¾ƒä¹¦é¢çš„å®šä¹‰æ˜¯ â€œå®ƒå‡è®¾å¤šç”¨æˆ·å¹¶å‘çš„äº‹åŠ¡åœ¨å¤„ç†æ—¶ä¸ä¼šå½¼æ­¤äº’ç›¸å½±å“ï¼Œå„äº‹åŠ¡èƒ½å¤Ÿåœ¨ä¸äº§ç”Ÿé”çš„æƒ…å†µä¸‹å¤„ç†å„è‡ªå½±å“çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚åœ¨æäº¤æ•°æ®æ›´æ–°ä¹‹å‰ï¼Œæ¯ä¸ªäº‹åŠ¡ä¼šå…ˆæ£€æŸ¥åœ¨è¯¥äº‹åŠ¡è¯»å–æ•°æ®åï¼Œæœ‰æ²¡æœ‰å…¶ä»–äº‹åŠ¡åˆä¿®æ”¹äº†è¯¥æ•°æ®ã€‚å¦‚æœå…¶ä»–äº‹åŠ¡æœ‰æ›´æ–°çš„è¯ï¼Œæ­£åœ¨æäº¤çš„äº‹åŠ¡ä¼šè¿›è¡Œå›æ»šã€‚â€ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­åˆ™æŒ‡å¯¹äºæ•°æ®å†²çªä¿æŒä¸€ç§ä¹è§‚æ€åº¦ï¼Œæ“ä½œæ•°æ®æ—¶ä¸ä¼šå¯¹æ“ä½œçš„æ•°æ®è¿›è¡ŒåŠ é”ï¼ˆè¿™ä½¿å¾—å¤šä¸ªä»»åŠ¡å¯ä»¥å¹¶è¡Œçš„å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼‰ï¼Œåªæœ‰åˆ°æ•°æ®æäº¤çš„æ—¶å€™æ‰é€šè¿‡ä¸€ç§æœºåˆ¶æ¥éªŒè¯æ•°æ®æ˜¯å¦å­˜åœ¨å†²çªã€‚åœ¨Javaä¸­ï¼Œæ˜¯é€šè¿‡CASæ¥å®ç°ä¹è§‚é”çš„ã€‚\nCASæ˜¯è‹±æ–‡å•è¯Compare And Swapçš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯æ¯”è¾ƒå¹¶æ›¿æ¢ã€‚CASæœºåˆ¶å½“ä¸­ä½¿ç”¨äº†3ä¸ªåŸºæœ¬æ“ä½œæ•°ï¼šå†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bã€‚\næ›´æ–°ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œåªæœ‰å½“å˜é‡çš„é¢„æœŸå€¼Aå’Œå†…å­˜åœ°å€Vå½“ä¸­çš„å®é™…å€¼ç›¸åŒæ—¶ï¼Œæ‰ä¼šå°†å†…å­˜åœ°å€Vå¯¹åº”çš„å€¼ä¿®æ”¹ä¸ºBã€‚\nCASæ¯”è¾ƒéš¾äºç†è§£çš„åœ°æ–¹å°±åœ¨äºVã€Aã€Bè¿™ä¸‰ä¸ªå˜é‡åˆ°åº•ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Œå¾ˆå®¹æ˜“æ··æ·†ï¼Œä¹Ÿä¸å®¹æ˜“è®²æ¸…æ¥šã€‚å•çº¯çœ‹ä¹¦ä¸Šçš„æ–‡ç« ä¼šè§‰å¾—æ™¦æ¶©ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸ªä¾‹å­ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\n1.åœ¨å†…å­˜åœ°å€Vå½“ä¸­ï¼Œå­˜å‚¨ç€å€¼ä¸º10çš„å˜é‡\n2.æ­¤æ—¶çº¿ç¨‹1æƒ³è¦æŠŠå˜é‡çš„å€¼å¢åŠ 1ã€‚å¯¹çº¿ç¨‹1æ¥è¯´ï¼Œæ—§çš„é¢„æœŸå€¼A=10ï¼Œè¦ä¿®æ”¹çš„æ–°å€¼B=11ã€‚\n3.åœ¨çº¿ç¨‹1è¦æäº¤æ›´æ–°ä¹‹å‰ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹2æŠ¢å…ˆä¸€æ­¥ï¼ŒæŠŠå†…å­˜åœ°å€Vä¸­çš„å˜é‡å€¼ç‡å…ˆæ›´æ–°æˆäº†11ã€‚\n4.çº¿ç¨‹1å¼€å§‹æäº¤æ›´æ–°ï¼Œé¦–å…ˆè¿›è¡ŒAå’Œåœ°å€Vçš„å®é™…å€¼æ¯”è¾ƒï¼ˆCompareï¼‰ï¼Œå‘ç°Aä¸ç­‰äºVçš„å®é™…å€¼ï¼Œæäº¤å¤±è´¥ã€‚\n5.çº¿ç¨‹1é‡æ–°è·å–å†…å­˜åœ°å€Vçš„å½“å‰å€¼ï¼Œå¹¶é‡æ–°è®¡ç®—æƒ³è¦ä¿®æ”¹çš„æ–°å€¼ã€‚æ­¤æ—¶å¯¹çº¿ç¨‹1æ¥è¯´ï¼ŒA=11ï¼ŒB=12ã€‚è¿™ä¸ªé‡æ–°å°è¯•çš„è¿‡ç¨‹è¢«ç§°ä¸ºè‡ªæ—‹ã€‚\n6.è¿™ä¸€æ¬¡æ¯”è¾ƒå¹¸è¿ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜åœ°å€Vçš„å€¼ã€‚çº¿ç¨‹1è¿›è¡ŒCompareï¼Œå‘ç°Aå’Œåœ°å€Vçš„å®é™…å€¼æ˜¯ç›¸ç­‰çš„ï¼Œçº¿ç¨‹1è¿›è¡ŒSwapï¼ŒæŠŠåœ°å€Vçš„å€¼æ›¿æ¢ä¸ºBï¼Œä¹Ÿå°±æ˜¯12ã€‚åœ¨è¿™ä¸€æ­¥ï¼ŒCompareå’ŒSwapè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„(ç”±æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¿è¯)ï¼Œæ¯”è¾ƒå¹¶æ›´æ–°çš„è¿‡ç¨‹æ˜¯ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­çš„ã€‚\nåˆ°è¿™é‡Œï¼Œå…¶å®åŸºæœ¬è¯´è¯·äº†CASçš„è¿‡ç¨‹ï¼Œä½†æ˜¯CASçš„APIï¼Œè¿˜æ˜¯ä¸å¤Ÿæ¸…æ™°ï¼Œå¾ˆå¤šäººèƒ½å¤Ÿè¿›è¡Œåˆ°è¿™é‡Œï¼Œä½†å¦‚æœè®©ä»–å®é™…ä½¿ç”¨CASçš„APIæ—¶åˆ™åˆæ²¡è¾™äº†ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤ºCASçš„APIå®é™…ç”¨ä¾‹ã€‚\n/** * ä½¿ç”¨CASæ¥è·å–å•ä¾‹ */ public class CasSingleton { private static final AtomicReference\u0026lt;CasSingleton\u0026gt; INSTANCE=new AtomicReference\u0026lt;\u0026gt;(); private CasSingleton(){} public static CasSingleton getInstance(){ for(;;){ CasSingleton singleton=INSTANCE.get(); if(null!=singleton){ return singleton; } singleton=new CasSingleton(); if(INSTANCE.compareAndSet(null,singleton)){ return singleton; } } } public static void main(String[] args) { CasSingleton singleton=getInstance(); CasSingleton singleton1=getInstance(); System.out.println(singleton); System.out.println(singleton1); } }  è¿™é‡Œä½¿ç”¨CASæ¥å®ç°å•ä¾‹ï¼Œæˆ‘ä»¬å¯¹ç…§ç€compareAndSetçš„APIæ¥çœ‹çœ‹\n/** * Atomically sets the value to {@code newValue} * if the current value {@code == expectedValue}, * with memory effects as specified by {@link VarHandle#compareAndSet}. * * @param expectedValue the expected value * @param newValue the new value * @return {@code true} if successful. False return indicates that * the actual value was not equal to the expected value. */ public final boolean compareAndSet(V expectedValue, V newValue) { return VALUE.compareAndSet(this, expectedValue, newValue); }  ä¸Šé¢CASå®ç°å•ä¾‹çš„ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°nullå°±æ˜¯Aï¼Œç¬¬äºŒä¸ªå‚æ•°singletonå°±æ˜¯Bï¼Œè°ƒç”¨è€…INSTANCEå°±æ˜¯Vã€‚åœ¨è°ƒç”¨compareAndSetçš„åŒæ—¶ï¼Œå·²ç»å®Œæˆäº†æ›´æ–°çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”è¿”å›äº†æ›´æ–°ä¸å¦çš„ç»“æœã€‚è¿™æ ·å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼ˆè™½ç„¶CASèƒ½å®ç°å•ä¾‹ï¼Œä½†åœ¨è¿™ä¸ªåœºæ™¯ä¸‹å¹¶ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œä¸ºä»€ä¹ˆï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸‹ï¼‰ã€‚\nç°åœ¨å†æ¥çœ‹çœ‹AtomicIntegerçš„æºç ï¼Œèƒ½ç†è§£++iè¿™å—çš„å®ç°äº†å—ï¼Ÿ\npublic final int incrementAndGet() { for (;;) { int current = get(); int next = current + 1; if (compareAndSet(current, next)) return next; } }  è‡³äºä»€ä¹ˆABAé—®é¢˜å’ŒCPUåº•å±‚å®ç°ï¼Œåˆ™ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚\n","date":"2019-07-16","permalink":"https://iminto.github.io/post/%E8%AE%B2%E6%B8%85%E6%A5%9Acas%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/","tags":["Java"],"title":"è®²æ¸…æ¥šCASçš„é‚£ç‚¹äº‹"},{"content":"nettyå®ç°httpæœåŠ¡å™¨keep-aliveæ— æ•ˆçš„é—®é¢˜æ’æŸ¥ ä»Šå¤©åœ¨ç”¨nettyå®ç°ä¸€ä¸ªhttpæœåŠ¡å™¨çš„æ—¶å€™ï¼Œå‘ç°keep-aliveå¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œå…·ä½“è¡¨ç°æ˜¯åœ¨requestå’Œresponseçš„headeré‡Œéƒ½èƒ½çœ‹åˆ°keep-aliveçš„æ ‡å¿—ï¼š\nrequest: Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3 Accept-Encoding: gzip, deflate, br Accept-Language: zh-CN,zh;q=0.9,en;q=0.8 Cache-Control: max-age=0 Connection: keep-alive response: HTTP/1.1 200 OK content-type: text/html;charset=UTF-8 content-length: 0 connection: keep-alive  å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ï¼Œéƒ½æ˜¯keep-aliveçš„ï¼Œä½†æ˜¯è¯·æ±‚ä¸¤æ¬¡ï¼ŒæœåŠ¡å™¨ç«¯æ—¥å¿—å¦‚ä¸‹ï¼š\nä¸ƒæœˆ 06, 2019 9:51:27 ä¸‹åˆ io.netty.handler.logging.LoggingHandler channelRead ä¿¡æ¯: [id: 0xade39344, L:/0:0:0:0:0:0:0:0:8080] READ: [id: 0x26d40041, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:33130] ä¸ƒæœˆ 06, 2019 9:51:27 ä¸‹åˆ io.netty.handler.logging.LoggingHandler channelReadComplete ä¿¡æ¯: [id: 0xade39344, L:/0:0:0:0:0:0:0:0:8080] READ COMPLETE keepAlive=true channel id=26d40041 http uri: /a.txt?name=chen\u0026amp;f=123;key=456 name=chen f=123 key=456 ä¸ƒæœˆ 06, 2019 9:51:29 ä¸‹åˆ io.netty.handler.logging.LoggingHandler channelRead ä¿¡æ¯: [id: 0xade39344, L:/0:0:0:0:0:0:0:0:8080] READ: [id: 0x600995e6, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:33156] ä¸ƒæœˆ 06, 2019 9:51:29 ä¸‹åˆ io.netty.handler.logging.LoggingHandler channelReadComplete ä¿¡æ¯: [id: 0xade39344, L:/0:0:0:0:0:0:0:0:8080] READ COMPLETE keepAlive=true channel id=600995e6 http uri: /a.txt?name=chen\u0026amp;f=123;key=456 name=chen f=123 key=456  å®¢æˆ·ç«¯ä¸¤æ¬¡è¿æ¥çš„socketç«¯å£ä¸€æ¬¡æ˜¯33130,ç¬¬äºŒæ¬¡æ˜¯33156ï¼Œchannel idä¹Ÿä¸ä¸€æ ·ï¼Œè¯æ˜ç¡®å®æ˜¯ä¸¤ä¸ªè¿æ¥ï¼Œkeep-aliveå¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚\nå…¶ä¸­ï¼Œchannel idæ¥è‡ªè¿™é‡Œ\n@Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { // System.out.println(\u0026quot;channel id=\u0026quot;+ctx.channel().id()); }  ä¸ºä»€ä¹ˆå‘¢ï¼Œçœ‹ä¸‹ä»£ç ä¸­Serverå’ŒServerHandleä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nserverBootstrap.channel(NioServerSocketChannel.class) .group(boss, work) .handler(new LoggingHandler(LogLevel.INFO)) // handleråœ¨åˆå§‹åŒ–æ—¶å°±ä¼šæ‰§è¡Œï¼Œå¯ä»¥è®¾ç½®æ‰“å°æ—¥å¿—çº§åˆ« .childHandler(new ChannelInitializer\u0026lt;SocketChannel\u0026gt;() { @Override protected void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast(\u0026quot;http-coder\u0026quot;,new HttpServerCodec()); ch.pipeline().addLast(\u0026quot;aggregator\u0026quot;,new HttpObjectAggregator(1024*1024)); //åœ¨å¤„ç† POSTæ¶ˆæ¯ä½“æ—¶éœ€è¦åŠ ä¸Š ch.pipeline().addLast(new HttpServerHandler()); } }) .option(ChannelOption.SO_BACKLOG, 1024) .childOption(ChannelOption.SO_KEEPALIVE, true) .childOption(ChannelOption.TCP_NODELAY, true); //handleä»£ç  httpResponse.headers().set(HttpHeaderNames.CONTENT_TYPE, \u0026quot;text/html;charset=UTF-8\u0026quot;); httpResponse.headers().setInt(HttpHeaderNames.CONTENT_LENGTH, httpResponse.content().readableBytes()); if (keepAlive) { httpResponse.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE); ctx.writeAndFlush(httpResponse); } else { ctx.writeAndFlush(httpResponse).addListener(ChannelFutureListener.CLOSE); }  ä»£ç å¾ˆæ˜æ˜¾ï¼Œå¦‚æœè¯·æ±‚æ˜¯ keep-aliveçš„ï¼Œé‚£ä¹ˆå“åº”å¤´ä¹ŸåŠ ä¸Škeep-aliveæ ‡å¿—ï¼Œä»è€Œå®ç°äº†é•¿è¿æ¥ã€‚çœ‹äº†åŠå¤©ä»£ç æ²¡çœ‹å‡ºç«¯å€ªæ¥ï¼Œçªç„¶æ³¨æ„åˆ°äº†åœ¨æµè§ˆå™¨ä¸­ï¼ŒF12çœ‹åˆ°äº†/favicon.icoçš„è¯·æ±‚ä¸€ç›´æ˜¯pendingçš„ï¼Œä¹Ÿå°±æ˜¯é˜»å¡åœ¨äº†è¿™é‡Œï¼Œä»£ç é‡Œæ˜¯è¿™ä¹ˆå†™çš„\n//å»é™¤æµè§ˆå™¨\u0026quot;/favicon.ico\u0026quot;çš„å¹²æ‰° if (uri.equals(FAVICON_ICO)) { return ; }  è¿™æ®µä»£ç æ¥è‡ªæˆ‘å‚è€ƒçš„åˆ«äººçš„ä»£ç ï¼Œæœ¬æ„æ˜¯è¦å¿½ç•¥ /favicon.icoè¿™ç§æ— æ•ˆçš„è¯·æ±‚ï¼Œä½†æ˜¯ç”±äºç›´æ¥returnäº†ï¼Œå¯¼è‡´å½“å‰è¿æ¥è¢«é˜»å¡äº†ï¼Œå¦‚æœè¿™æ—¶åˆ·æ–°ï¼Œå°±ä¼šå¯¼è‡´æ–°å¼€ä¸€ä¸ªè¿æ¥æ¥å¤„ç†è¯·æ±‚ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼Œåªéœ€è¦æ³¨é‡Šæ‰è¿™æ®µä»£ç ï¼Œå¯¹äº/favicon.icoè¯·æ±‚ï¼Œç›´æ¥è¿”å›ç©ºçš„200çŠ¶æ€ç å°±å¥½äº†ã€‚\nç°åœ¨å†æ¥çœ‹ä¸‹è¯·æ±‚æ—¥å¿—ï¼š\nä¿¡æ¯: [id: 0xee8bc5e1, L:/0:0:0:0:0:0:0:0:8080] READ: [id: 0x734e2ebb, L:/0:0:0:0:0:0:0:1:8080 - R:/0:0:0:0:0:0:0:1:37386] ä¸ƒæœˆ 06, 2019 10:03:48 ä¸‹åˆ io.netty.handler.logging.LoggingHandler channelReadComplete ä¿¡æ¯: [id: 0xee8bc5e1, L:/0:0:0:0:0:0:0:0:8080] READ COMPLETE keepAlive=true channel id=734e2ebb http uri: /a.txt?name=chen\u0026amp;f=123;key=456 name=chen f=123 key=456 keepAlive=true channel id=734e2ebb http uri: /favicon.ico keepAlive=true channel id=734e2ebb http uri: /a.txt?name=chen\u0026amp;f=123;key=456 name=chen f=123 key=456 keepAlive=true channel id=734e2ebb http uri: /favicon.ico  æ— è®ºåˆ·æ–°å¤šå°‘æ¬¡ï¼ŒæœåŠ¡å™¨ç«¯æ—¥å¿—é‡Œä¹Ÿåªè®°å½•äº†ä¸€æ¬¡socketè¿æ¥æ—¥å¿—ï¼Œå¹¶ä¸”æ¯æ¬¡çš„channel idéƒ½æ˜¯ä¸€æ ·çš„ã€‚\né¡ºä¾¿å†æµ‹è¯•ä¸‹ï¼Œå¦‚æœæŠŠserverä¸­çš„ChannelOption.SO_KEEPALIVEè®¾ç½®ä¸ºfalseï¼Œæ˜¯ä¸ä¼šå½±å“httpçš„keep-aliveçš„ã€‚\n","date":"2019-07-06","permalink":"https://iminto.github.io/post/netty%E5%AE%9E%E7%8E%B0http%E6%9C%8D%E5%8A%A1%E5%99%A8keep-alive%E6%97%A0%E6%95%88%E7%9A%84%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","tags":["Java"],"title":"Nettyå®ç°httpæœåŠ¡å™¨keep Aliveæ— æ•ˆçš„é—®é¢˜æ’æŸ¥"},{"content":"æˆ‘ç”¨çš„filebeat7æ¥æ”¶é›†æ—¥å¿—å‘ç»™Elastic searchï¼Œç‰ˆæœ¬æ˜¯7.1.1ï¼Œå¯¹åº”çš„elasticsearchç‰ˆæœ¬å’Œå…¶ç›¸åŒã€‚\né»˜è®¤çš„ï¼Œfilebeatç”Ÿæˆçš„ç´¢å¼•åå­—æ˜¯filebeat-7.1.1-2019.06.24è¿™ç§ï¼Œä¸åˆ©äºåŒºåˆ†ä¸åŒçš„ä¸šåŠ¡ï¼Œéœ€è¦è‡ªå®šä¹‰ç´¢å¼•ï¼Œçœ‹äº†ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œ æ˜¯è¿™ä¹ˆå†™çš„\nindexedit The index name to write events to. The default is \u0026quot;filebeat-%{[agent.version]}-%{+yyyy.MM.dd}\u0026quot; (for example, \u0026quot;filebeat-7.2.0-2019-06-26\u0026quot;). If you change this setting, you also need to configure the setup.template.name and setup.template.pattern options (see Load the Elasticsearch index template). If you are using the pre-built Kibana dashboards, you also need to set the setup.dashboards.index option (see Load the Kibana dashboards). You can set the index dynamically by using a format string to access any event field. For example, this configuration uses a custom field, fields.log_type, to set the index: output.elasticsearch: hosts: [\u0026quot;http://localhost:9200\u0026quot;] index: \u0026quot;%{[fields.log_type]}-%{[agent.version]}-%{+yyyy.MM.dd}\u0026quot;  é‡ç‚¹æåˆ°äº†è¿˜éœ€è¦ä¿®æ”¹setup.template.nameå’Œsetup.template.patternï¼Œäºæ˜¯æˆ‘é…ç½®å¦‚ä¸‹ï¼š\noutput.elasticsearch: hosts: [\u0026quot;127.0.0.1:9200\u0026quot;] index: \u0026quot;ngerr-%{[agent.version]}-%{+yyyy.MM.dd}\u0026quot; setup.template.name: \u0026quot;ngerr\u0026quot; setup.template.pattern: \u0026quot;ngerr-*\u0026quot;  ç»“æœå‘ç°æ— è®ºå¦‚ä½•éƒ½ä¸ç”Ÿæ•ˆï¼Œæ‰¾äº†å¾ˆå¤šæ–‡ç« éƒ½è¯´é…ç½®è¿™å‡ ä¸ªåœ°æ–¹å°±è¡Œï¼ŒåŒ…æ‹¬googleä¹Ÿæœä¸åˆ°ç»“æœã€‚æˆ‘è¯•äº†ä¸åŒçš„é…ç½®ï¼Œç”šè‡³æŠŠsetup.templateé…ç½®è°ƒäº†ä½ç½®ï¼Œè¿˜æ˜¯å¾’åŠ³ï¼Œæ§åˆ¶å°æ°¸è¿œéƒ½æ˜¯è¾“å‡ºå¦‚ä¸‹\n2019-06-26T13:11:20.287+0800 INFO pipeline/output.go:95 Connecting to backoff(elasticsearch(http://127.0.0.1:9200)) 2019-06-26T13:11:20.294+0800 INFO elasticsearch/client.go:734 Attempting to connect to Elasticsearch version 7.1.1 2019-06-26T13:11:20.379+0800 INFO [index-management] idxmgmt/std.go:223 Auto ILM enable success. 2019-06-26T13:11:20.380+0800 INFO [index-management.ilm] ilm/std.go:134 do not generate ilm policy: exists=true, overwrite=false 2019-06-26T13:11:20.380+0800 INFO [index-management] idxmgmt/std.go:238 ILM policy successfully loaded. 2019-06-26T13:11:20.380+0800 INFO [index-management] idxmgmt/std.go:361 Set setup.template.name to '{filebeat-7.1.1 {now/d}-000001}' as ILM is enabled. 2019-06-26T13:11:20.380+0800 INFO [index-management] idxmgmt/std.go:366 Set setup.template.pattern to 'filebeat-7.1.1-*' as ILM is enabled. 2019-06-26T13:11:20.380+0800 INFO [index-management] idxmgmt/std.go:400 Set settings.index.lifecycle.rollover_alias in template to {filebeat-7.1.1 {now/d}-000001} as ILM is enabled. 2019-06-26T13:11:20.380+0800 INFO [index-management] idxmgmt/std.go:404 Set settings.index.lifecycle.name in template to {filebeat-7.1.1 map[policy:{\u0026quot;phases\u0026quot;:{\u0026quot;hot\u0026quot;:{\u0026quot;actions\u0026quot;:{\u0026quot;rollover\u0026quot;:{\u0026quot;max_age\u0026quot;:\u0026quot;30d\u0026quot;,\u0026quot;max_size\u0026quot;:\u0026quot;50gb\u0026quot;}}}}}]} as ILM is enabled. 2019-06-26T13:11:20.383+0800 INFO template/load.go:129 Template already exists and will not be overwritten. 2019-06-26T13:11:20.383+0800 INFO [index-management] idxmgmt/std.go:272 Loaded index template. 2019-06-26T13:11:20.524+0800 INFO [index-management] idxmgmt/std.go:283 Write alias successfully generated.  {filebeat-7.1.1 {now/d}-000001} è¿™ä¸ªåå­—æ€»æ˜¯ä¼šè¦†ç›–æˆ‘è‡ªå·±çš„é…ç½®ã€‚åå¤å°è¯•ï¼Œè§‰å¾—æ˜¯ ILM è¿™ä¸ªä¸œè¥¿åœ¨ä½œæ¢—ï¼Œäºæ˜¯è¯•ç€æœç´¢äº†ä¸‹â€œfilebeat ILM is enabledâ€ï¼Œå‘ç°äº†è¿™ä¸ªissue ï¼Œæœ‰ä¸å°‘äººè¸©å‘äº†ã€‚æå‡ºissueçš„äººä¹ŸæŒ‡å‡ºäº†æ–‡æ¡£æ²¡æœ‰è¯´æ¸…æ¥šã€‚\næŒ‡å‘äº†è¿™ä¸ªå®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/beats/filebeat/current/ilm.html\nåŸæ¥\n Starting with version 7.0, Filebeat uses index lifecycle management by default when it connects to a cluster that supports lifecycle management. Filebeat loads the default policy automatically and applies it to any indices created by Filebeat.\n å¯æƒœçš„æ˜¯filebeatçš„é…ç½®é¡¹é‚£é‡Œä¸€ç›´æ²¡æœ‰è¯´æ¸…æ¥šã€‚ç½‘ä¸Šç”±äºå¤§å¤šæ•°äººç”¨çš„éƒ½æ˜¯å¾ˆä¿å®ˆçš„é…ç½®å’Œè¾ƒè€çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¾ˆéš¾æœç´¢åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œæˆ‘åŸºæœ¬ä¸Šæ˜¯å¤´å‡ ä¸ªè¸©å‘çš„äº†ã€‚\nåŠ ä¸Šè¿™ä¸ªé…ç½®å°±å¥½äº†ï¼š\nsetup.ilm.enabled: false  å¸Œæœ›èƒ½å¸®åˆ°è¸©å‘çš„äººï¼Œæˆ‘å·²ç»åœ¨è¿™ä¸ªé—®é¢˜ä¸Šæµªè´¹äº†ä¸‰å››ä¸ªå°æ—¶äº†ã€‚\n","date":"2019-06-26","permalink":"https://iminto.github.io/post/filebeat%E4%BF%AE%E6%94%B9index%E7%9A%84%E4%B8%80%E4%B8%AA%E5%9D%91/","tags":["Java"],"title":"Filebeat7è‡ªå®šä¹‰indexçš„ä¸€ä¸ªå‘"},{"content":"æœ¬æ¥æˆ‘ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œæ˜¯å¾ˆä¸å±‘æäº§å“çš„ï¼Œä½†æ—¶ä¸æ—¶æ€»è§åˆ°ä¸€äº›äº§å“äººå¹ç‰›çš®ï¼Œä¹Ÿå¿ä¸ä½å‡‘ä¸ªçƒ­é—¹ã€‚\né’‰é’‰(DingTalk)æ˜¯ä¸€æ¬¾ç”±é˜¿é‡Œå·´å·´é›†å›¢å¼€å‘çš„ç”¨äºå•†åŠ¡æ²Ÿé€šå’Œå·¥ä½œååŒçš„IMï¼Œå…¶å’Œä¼ä¸šç‰ˆå¾®ä¿¡å æ®äº†ä¸­å›½çš„å¤§éƒ¨åˆ†ä¼ä¸šIMå¸‚åœºã€‚é˜¿é‡Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ“…é•¿åšç¤¾äº¤çš„å…¬å¸ï¼Œé’‰é’‰ä¹Ÿæ˜¯ä¸€æ¬¾å‘½é€”å¤šèˆ›çš„äº§å“ã€‚2014å¹´å·¦å³é˜¿é‡Œåœ¨å†…éƒ¨å¼ºè¡Œæ¨å¹¿æ¥å¾€ï¼Œä¸€æ¬¾æ‰¿è½½äº†é˜¿é‡Œç¤¾äº¤æ¢¦çš„äº§å“ï¼ŒèŠ±äº†å·¨é¢çš„ç ”å‘å’Œè¥é”€è´¹ç”¨åï¼Œä¾ç„¶æ˜¯æŠ˜æˆŸæ²‰æ²™ã€‚åæ¥ï¼Œæ¥å¾€çš„å›¢é˜Ÿä¿ç•™äº†éƒ¨åˆ†ä¸‹æ¥ï¼Œåšèµ·äº†é’‰é’‰ï¼Œé’ˆå¯¹åŠå…¬ç¤¾äº¤ï¼Œå±…ç„¶åšæˆåŠŸäº†ã€‚\nåœ¨åŠå…¬ç¤¾äº¤ä¸Šï¼Œé’‰é’‰çš„å´›èµ·ç”šè‡³æ—©äºä»¥ç¤¾äº¤é—»åçš„è…¾è®¯ï¼Œåœ¨ç¤¾äº¤ä¸Šæ‰³å›äº†ä¸€å±€ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯å”¯ä¸€çš„ä¸€å±€ã€‚å¾®ä¿¡å’ŒQQåœ¨é’‰é’‰åä¹Ÿå¿«é€Ÿæ¨å‡ºäº†åŠå…¬ç¤¾äº¤QQå’Œä¼ä¸šå¾®ä¿¡ç­‰åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨å®ƒä»¬æ¨å‡ºåï¼Œé’‰é’‰åœ¨å¾ˆå¤šåŸå¸‚ä½¿ç”¨çš„é¢‘ç‡å·²ç»å¾ˆé«˜äº†ã€‚\næˆ‘ç”¨çš„æ˜¯linuxæ“ä½œç³»ç»Ÿï¼Œé’‰é’‰å¹¶æ²¡æœ‰å®˜æ–¹linuxç‰ˆæœ¬ï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä¼šä½¿ç”¨æ‰‹æœºé’‰é’‰å’Œç½‘é¡µç‰ˆé’‰é’‰å‡‘åˆã€‚ä½†æ˜¯æŸä¸€æ¬¡æ‰“å¼€é’‰é’‰è®¾ç½®çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªé—®é¢˜ã€‚\n\nä¸çŸ¥å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œç½‘é¡µç‰ˆé’‰é’‰çš„è®¾ç½®ä½¿ç”¨äº†æµè¡Œçš„switchå¼€å…³ï¼Œä½†æ˜¯ç”¨äº†çº¢è‰²å’Œç»¿è‰²çš„æ­é…ã€‚å¯èƒ½é’‰é’‰çš„è®¾è®¡å’Œå¼€å‘è€…è§‰å¾—â€œçº¢ç¯åœï¼Œç»¿ç¯è¡Œâ€çš„æ¦‚å¿µå·²ç»æ·±å…¥äººå¿ƒï¼Œä½†æ˜¯ä»–ä»¬æ˜¯å¦æƒ³åˆ°äº†ä¸€ä¸ªäº‹å®ï¼šä¸­å›½å­˜åœ¨è¿‘äº¿çš„è‰²ç›²å’Œè‰²å¼±ç”¨æˆ·ï¼Œè¿™å…¶ä¸­åˆä»¥çº¢ç»¿è‰²ç›²è‰²å¼±æœ€å¤šï¼\nçº¢è‰²å’Œç»¿è‰²ï¼Œæ˜¯ä¸¤ä¸ªå¯¹æ¯”åº¦æ¯”è¾ƒæ¥è¿‘çš„é¢œè‰²ï¼Œä¹Ÿæ˜¯æœ€éš¾è¾¨è¯†çš„ä¸¤ä¸ªé¢œè‰²ï¼Œåˆ«è¯´å¯¹è‰²ç›²å’Œè‰²å¼±ç”¨æˆ·æ¥è¯´ï¼Œå³ä½¿æ˜¯å¯¹äºæ™®é€šäººæ¥è¯´ï¼Œåœ¨æŸäº›å…‰çº¿æ¡ä»¶ä¸‹ï¼Œçº¢ç»¿è‰²ä¹Ÿæ˜¯å¾ˆéš¾äºè¾¨è¯†çš„ã€‚å®é™…ä¸Šåœ¨æ‰“å¼€è¿™ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿæ„£äº†ä¸€ä¼šï¼Œæ‰è¾¨æ¸…äº†è¿™ä¸¤ä¸ªé¢œè‰²çŠ¶æ€ã€‚\næ­£å› ä¸ºçº¢ç»¿è‰²æ˜¯å¾ˆéš¾äºè¾¨è¯†çš„ä¸¤ç§é¢œè‰²ï¼Œç°åœ¨åŸå¸‚çš„çº¢ç»¿ç¯ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æºäº†è“è‰²çš„ï¼Œæ‰€ä»¥å¤§å®¶çœ‹åˆ°çš„ç»¿ç¯ï¼Œéƒ½æ˜¯æ³›è“çš„ï¼Œè€Œä¸æ˜¯å•çº¯çš„ç»¿è‰²ã€‚è¿˜æœ‰çš„åŸå¸‚ï¼Œç»¿ç¯ä¸ä»…æºäº†è“è‰²ï¼Œè¿˜ä¼šä½¿ç”¨åŠ¨ç”»æˆ–å£°éŸ³æç¤ºè¡Œäººè½¦è¾†ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†å‡å°‘äº†ç‰¹æ®Šç”¨æˆ·ç”šè‡³æ˜¯æ­£å¸¸ç”¨æˆ·çš„å›°æ‰°ã€‚\né˜¿é‡Œä¸€ç›´å®£ä¼ äº§å“çš„äººæ–‡å…³æ€€ï¼Œæ¯”å¦‚é›‡ä½£æ®‹ç–¾äººå®¢æœï¼Œæ”¯ä»˜å®æ”¯æŒè¯­éŸ³æ”¯ä»˜ç­‰ï¼Œä½†æ˜¯å¯æ›¾æƒ³åˆ°ï¼Œä»–ä»¬å¦å¤–ä¸€æ¬¾æœ€æµè¡Œçš„ä¼ä¸šIMè½¯ä»¶ï¼Œå´å¿½ç•¥äº†ä¸Šäº¿äººï¼\näº§å“çš„è®¾è®¡å¼€å‘ä¸­ï¼Œæœ‰è®¸å¤šç»†èŠ‚ï¼Œåªæœ‰çœŸæ­£ç”¨å¿ƒçš„äººæ‰ä¼šæ³¨æ„åˆ°ï¼Œå¹¶è®¾è®¡å‡ºç”¨æˆ·å‹å¥½çš„è½¯ä»¶ï¼Œå‡å°‘ç”¨æˆ·çš„å›°æ‰°ã€‚\nä½œè€…ä½¿ç”¨äº†é’‰é’‰å¾ˆä¹…äº†ï¼Œæœ€æ—©çš„APPç‰ˆè®¾ç½®é¡µé¢å°±æ˜¯ä½¿ç”¨çº¢è‰²å’Œç»¿è‰²æ¥ä½œä¸ºswithå¼€å…³çš„ï¼Œä½œè€…æ›¾ç»åœ¨å¾®åšç­‰å¤šä¸ªæ¸ é“å‘é˜¿é‡Œåé¦ˆï¼Œå¯æƒœä¸€ç›´æ²¡æœ‰æ”¶åˆ°é˜¿é‡Œçš„å›å¤ï¼Œç›´åˆ°ä¸€å¹´åçš„æŸå¤©ï¼Œé’‰é’‰æ‚„æ‚„åœ°æ”¹äº†è¿™ä¸ªç»†èŠ‚ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯æ— æ„ä¸­ä¿®æ”¹è¿˜æ˜¯çœŸçš„æ”¶åˆ°äº†ç”¨æˆ·çš„åé¦ˆã€‚é—æ†¾çš„æ˜¯ï¼Œç½‘é¡µç‰ˆé’‰é’‰è‡³ä»Šæ²¡æœ‰ä¿®æ”¹è¿™ä¸ªç»†èŠ‚ã€‚\n","date":"2019-05-06","permalink":"https://iminto.github.io/post/oh-dingtalk/","tags":["é—²æ‰¯æ·¡"],"title":"ä»é’‰é’‰ä¸€ä¸ªå¿½ç•¥äº†è¿‘äº¿äººçš„äº§å“ç»†èŠ‚è°ˆè°ˆäº§å“æ€ç»´"},{"content":"å…¬å¸çš„ç”Ÿäº§æœåŠ¡å™¨ä¹°äº†QiZhi Technologieçš„å ¡å’æœºï¼Œæ¯æ¬¡ç™»å½•éƒ½å¾—è¾“å…¥å¯†ç +ç©ºæ ¼+OTOPéªŒè¯ç ï¼Œéƒ½å¾—æ‰“å¼€æ‰‹æœºAPPæ“ä½œä¸€æŠŠï¼Œçƒ¦ä¸èƒœçƒ¦ã€‚\nä¸å¯å¿ï¼Œæƒ³äº†æƒ³ï¼Œè¿˜æ˜¯å€ŸåŠ©Javaåœ¨æ¯æ¬¡è°ƒç”¨æ—¶è‡ªåŠ¨ç”ŸæˆéªŒè¯ç ï¼Œç„¶åæä¸ªsshè‡ªåŠ¨ç™»å½•ï¼ˆåˆ«é—®æˆ‘é—®å•¥ä¸ç”¨å…¬é’¥ï¼Œå“ªæœ‰æƒé™å•Šï¼‰å¾—äº†ã€‚\nç»“åˆä¹‹å‰å†™çš„åšå®¢ TOTPç®—æ³•Javaç‰ˆæœ¬ï¼Œå¾ˆå®¹æ˜“å°±å†™å‡ºè®¡ç®—éªŒè¯ç çš„ä»£ç ï¼š\npublic long getCode(String secret, long timeMsec) throws Exception { Base32 codec = new Base32(); byte[] decodedKey = codec.decode(secret); long t = (timeMsec / 1000L) / 30L; for (int i = -window_size; i \u0026lt;= window_size; ++i) { long hash; try { hash = verify_code(decodedKey, t + i); return hash; } catch (Exception e) { e.printStackTrace(); } } return 0L; }  å†™ä¸€ä¸ªç±»ï¼Œä¸“é—¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ç”ŸæˆéªŒè¯ç ï¼Œè·å–ç¨‹åºæ‰§è¡Œç»“æœ\njava -Dfile.encoding=UTF-8 -classpath /soft/tool/authcode/ GoogleAuthTest  ï¼Œæ¥ä¸‹æ¥ï¼Œè¦å®ç°è‡ªåŠ¨ç™»å½•å°±ç®€å•å¤šäº†ï¼Œå…ˆå†™ä¸€ä¸ªshell\n#!/bin/bash passwd=$(java -Dfile.encoding=UTF-8 -classpath /soft/tool/authcode/ GoogleAuthTest) ./prod.exp $passwd  shellè°ƒç”¨javaç”ŸæˆéªŒè¯ç ï¼Œç„¶åä¼ ç»™expectè„šæœ¬\n#!/bin/expect set timeout 10 set fullpasswd [lindex $argv 0] spawn ssh -l chenwen 172.10.3.110 expect \u0026quot;*ssword*\u0026quot; send \u0026quot;dev744988 $fullpasswd\\r\u0026quot; interact  ä¸åˆ°100è¡Œæ–°ä»£ç ï¼Œæå®šæ”¶å·¥ï¼Œå…¨ç¨‹ä¸åˆ°åŠå°æ—¶ã€‚æœ€è€—æ—¶çš„è¿˜æ˜¯ä¼ é€’å˜é‡ç»™expactèŠ±äº†ä¸å°‘æ—¶é—´ã€‚\n","date":"2018-11-16","permalink":"https://iminto.github.io/post/auto-login-bastion-with-otop-by-java/","tags":["Java","Linux"],"title":"ä½¿ç”¨Javaè‡ªåŠ¨ç™»å½•éœ€è¦åŠ¨æ€å¯†ç çš„å ¡å’æœº"},{"content":"åœ¨Linuxé‡Œï¼Œç”¨æˆ·å±‚é¢å¹¶æ²¡æœ‰æ–‡ä»¶åˆ›å»ºæ—¶é—´çš„æ¦‚å¿µï¼Œæ— è®ºæ˜¯ç”¨lsè¿˜æ˜¯stat æŒ‡ä»¤ï¼Œéƒ½æ— æ³•è·å–åˆ°æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´\n[tudou@tudou-pc statx]$ stat test-statx.c æ–‡ä»¶ï¼štest-statx.c å¤§å°ï¼š6656 å—ï¼š16 IO å—ï¼š4096 æ™®é€šæ–‡ä»¶ è®¾å¤‡ï¼š805h/2053d Inodeï¼š6684737 ç¡¬é“¾æ¥ï¼š1 æƒé™ï¼š(0644/-rw-r--r--) Uidï¼š( 1000/ tudou) Gidï¼š( 1001/ tudou) æœ€è¿‘è®¿é—®ï¼š2018-10-07 13:16:29.000000000 +0800 æœ€è¿‘æ›´æ”¹ï¼š2018-10-07 13:21:09.855461986 +0800 æœ€è¿‘æ”¹åŠ¨ï¼š2018-10-07 13:21:09.855461986 +0800 åˆ›å»ºæ—¶é—´ï¼š-  å¯ä»¥çœ‹åˆ°ã€Œåˆ›å»ºæ—¶é—´ã€ä¸€è¡Œæ€»æ˜¯ã€Œ-ã€ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨ç™¾åº¦çš„è¯ï¼Œä¼šçœ‹åˆ°å¾ˆå¤šæ–‡ç« è¯´ï¼Œæœ€è¿‘æ”¹åŠ¨æ—¶é—´å°±æ˜¯åˆ›å»ºæ—¶é—´ã€‚çš„ç¡®ï¼Œæˆ‘ä»¬æ‹¿å¾ˆå¤šæ–‡ä»¶è¯•éªŒäº†ä¸‹ï¼Œè¿™ä¸ªæœ€è¿‘æ”¹åŠ¨æ—¶é—´ï¼ˆChange Timeï¼‰ç¡®å®å’Œåˆ›å»ºæ—¶é—´å¾ˆç›¸è¿‘ï¼Œç„¶è€ŒChange timeå¹¶ä¸æ˜¯Create timeï¼Œå®ƒå®é™…æ˜¯æ–‡ä»¶å±æ€§ä¿®æ”¹æ—¶é—´ã€‚ è¯•ä¸€ä¸‹å³çŸ¥ï¼š\n[tudou@tudou-pc ä¸‹è½½]$ ./statx ~/.face statx(/home/tudou/.face) = 0 results=fff Size: 7589 Blocks: 16 IO Block: 4096 regular file Device: 08:05 Inode: 5505043 Links: 1 Access: (0644/-rw-r--r--) Uid: 1000 Gid: 1001 Access: 2018-09-16 01:15:52.320014139+0800 Modify: 2018-09-16 01:15:52.320014139+0800 Change: 2018-09-16 01:15:52.320014139+0800 Birth: 2018-09-16 01:15:52.320014139+0800 Attributes: 0000000000000000 (........ ........ ........ ........ ........ ........ ....-... .---.-..) [tudou@tudou-pc ä¸‹è½½]$ chattr +u ~/.face [tudou@tudou-pc ä¸‹è½½]$ ./statx ~/.face statx(/home/tudou/.face) = 0 results=fff Size: 7589 Blocks: 16 IO Block: 4096 regular file Device: 08:05 Inode: 5505043 Links: 1 Access: (0644/-rw-r--r--) Uid: 1000 Gid: 1001 Access: 2018-09-16 01:15:52.320014139+0800 Modify: 2018-09-16 01:15:52.320014139+0800 Change: 2018-10-07 16:17:10.929769171+0800 Birth: 2018-09-16 01:15:52.320014139+0800 Attributes: 0000000000000000 (........ ........ ........ ........ ........ ........ ....-... .---.-..)  ä¸è¿‡ï¼Œlinuxä¹Ÿä¸æ˜¯å®Œå…¨ä¸æ”¯æŒæ–‡ä»¶åˆ›å»ºæ—¶é—´ï¼Œæ–‡ä»¶ç³»ç»Ÿå¦‚ext4å…¶å®æ˜¯æ”¯æŒçš„ï¼Œåªæ˜¯æ²¡æœ‰APIå¯ä»¥è·å–åˆ°è¿™ä¸ªæ•°æ®ã€‚æ¯”å¦‚Javaæä¾›çš„æ–‡ä»¶APIï¼Œä¹Ÿå°±å› æ­¤æ— æ³•è·å–æ–‡ä»¶åˆ›å»ºæ—¶é—´ã€‚\nä¸è¿‡ï¼Œè‡ªå†…æ ¸ 4.11 ç‰ˆæœ¬å¼•å…¥çš„ statx ç³»ç»Ÿè°ƒç”¨æ”¯æŒè·å–åˆ›å»ºæ—¶é—´äº†ï¼Œå­—æ®µåé‡Œç”¨çš„æ˜¯ btimeï¼ˆBirth timeï¼‰ã€‚\nå¦‚æœç”¨æˆ·æƒ³è¦å®ç°åœ¨ä»£ç é‡Œè·å–è¿™ä¸ªåˆ›å»ºæ—¶é—´ï¼Œé‚£ä¹ˆåªéœ€è¦è°ƒç”¨glibcæä¾›çš„APIå³å¯ã€‚ä½†æ˜¯ç›®å‰glibcè¿˜æ²¡æœ‰æ”¯æŒï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±ç”¨syscallå‡½æ•°è°ƒç”¨ã€‚å¦‚æœä»…ä»…åªæ˜¯æƒ³è‡ªå·±å®ç°ä¸€ä¸ªå°å·¥å…·æ¥è·å–è¿™ä¸ªæ—¶é—´ï¼Œé‚£ä¹ˆå†…æ ¸æºç æ ‘é‡Œ samples/statx/test-statx.c è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ç°æˆçš„å®ç°ã€‚ ä¸‹è½½æºç ï¼šhttps://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.18.12.tar.xzï¼Œé€‰æ‹©ä¸€ä¸ªå’Œè‡ªå·±æ“ä½œç³»ç»Ÿç‰ˆæœ¬æœ€è¿‘çš„æºç åˆ†æ”¯ . ä½ è¦æ˜¯ä¸æƒ³ä¸‹è½½å‡ åMçš„linuxæºç çš„è¯ï¼Œä¹Ÿå¯ä»¥ä»è¿™é‡Œè·å–åˆ°å„ä¸ªlinuxç‰ˆæœ¬çš„æºç  ç¼–è¯‘æ–‡ä»¶ï¼š\n[tudou@tudou-pc statx]$ gcc -O2 -o statx test-statx.c In file included from /usr/include/sys/stat.h:446, from test-statx.c:28: /usr/include/bits/statx.h:25:8: é”™è¯¯ï¼šâ€˜struct statx_timestampâ€™é‡å®šä¹‰ struct statx_timestamp ^~~~~~~~~~~~~~~ In file included from test-statx.c:26: /usr/include/linux/stat.h:56:8: é™„æ³¨ï¼šåŸå…ˆåœ¨è¿™é‡Œå®šä¹‰ struct statx_timestamp { ^~~~~~~~~~~~~~~ In file included from /usr/include/sys/stat.h:446, from test-statx.c:28: /usr/include/bits/statx.h:36:8: é”™è¯¯ï¼šâ€˜struct statxâ€™é‡å®šä¹‰  æ³¨é‡Šå¦‚ä¸‹ä¸¤è¡Œä»£ç ï¼š\n#define _GNU_SOURCE #define _ATFILE_SOURCE  å†æ¬¡ç¼–è¯‘å³å¯ã€‚\n[tudou@tudou-pc statx]$ gcc -O2 -o statx test-statx.c [tudou@tudou-pc statx]$ ./statx test-statx.c statx(test-statx.c) = 0 results=fff Size: 6656 Blocks: 16 IO Block: 4096 regular file Device: 08:05 Inode: 6684737 Links: 1 Access: (0644/-rw-r--r--) Uid: 1000 Gid: 1001 Access: 2018-10-07 13:16:29.000000000+0800 Modify: 2018-10-07 13:21:09.855461986+0800 Change: 2018-10-07 13:21:09.855461986+0800 Birth: 2018-10-07 13:16:47.771175840+0800 Attributes: 0000000000000000 (........ ........ ........ ........ ........ ........ ....-... .---.-..)  å¦å¤–ä¸€ä¸ªæ€è·¯ï¼Œ ä½¿ç”¨debugfsæ¥æã€‚\né™„ï¼šglibcå³å°†æ”¯æŒstatxè°ƒç”¨Glibc Support For Statx Is Finally Under Review\nå‚è€ƒï¼š https://blog.lilydjwg.me/2018/7/11/get-file-birth-time-in-linux.213101.html\n","date":"2018-10-07","permalink":"https://iminto.github.io/post/get-createtime-in-linux/","tags":["Linux"],"title":"Linux ä¸‹è·å–æ–‡ä»¶åˆ›å»ºæ—¶é—´"},{"content":"ç°åœ¨çš„ä¸€äº›Linuxè½¯ä»¶å¾ˆæµè¡Œä½¿ç”¨binè¿™ç§å®‰è£…åŒ…æ ¼å¼ï¼Œåªéœ€è¦ä¸‹è½½ä¸ªå®‰è£…åŒ…å°±èƒ½è‡ªåŠ¨å®‰è£…è§£å‹ï¼Œæ¯”tar.gzçœäº‹ï¼Œæ¯”.debï¼Œ.rpmçš„å®‰è£…åŒ…å…¼å®¹æ€§å¼ºï¼Œé€‚åº”èŒƒå›´å¹¿ã€‚ä½†ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œbinå®‰è£…åŒ…è®©äººæ— æ³•çŸ¥é“é‡Œé¢çš„ç»†èŠ‚ï¼Œè¿˜æ˜¯æœ‰æ‰€é¡¾è™‘çš„ã€‚æ¯”å¦‚æˆ‘å‰å‡ å¤©éœ€è¦ä¸‹è½½ä¸€ä¸ªJRE6ï¼Œä½†Oracleå®˜æ–¹åœ¨JDK7ä¹‹å‰éƒ½æ²¡æœ‰tar.gzåŒ…ï¼Œåªæœ‰binåŒ…ã€‚æˆ‘è‚¯å®šä¸èƒ½ç›´æ¥å®‰è£…binæ–‡ä»¶å•Šï¼Œè¿™ä¼šç ´åæˆ‘æœ¬æœºå·²æœ‰çš„JDK8å¼€å‘ç¯å¢ƒã€‚\næ€ä¹ˆä»binæ–‡ä»¶é‡Œæå–å‡ºåŸå§‹å®‰è£…åŒ…å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ã€‚ç”¨viæ‰“å¼€ä¸€ä¸ªbinæ–‡ä»¶å°±çŸ¥é“äº†ï¼Œbinæ–‡ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªshæ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„åˆå¹¶æ–‡ä»¶ï¼Œå‰é¢ä¸€æ®µæ˜¯shå‘½ä»¤ï¼Œè´Ÿè´£å®é™…çš„å®‰è£…ï¼Œå®ƒä¼šæå–ååŠéƒ¨åˆ†çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒååŠéƒ¨åˆ†ä¸€èˆ¬æ˜¯ä¸ªå‹ç¼©æ–‡ä»¶åŒ…æˆ–è€…è‡ªè§£å‹æ–‡ä»¶çš„äºŒè¿›åˆ¶æµã€‚\nvi jre-for-linux.bin  å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€è¡Œæ˜¯\n#!/bin/bash  æ¥ä¸‹æ¥å°±æ˜¯ä¸€å †å®‰è£…å’Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæå–è§£å‹éƒ¨åˆ†äº†ï¼Œæœ€å…³é”®çš„éƒ¨åˆ†åœ¨è¿™å‡ è¡Œ\noutname=install.sfx.$$ tail ${tail_args} +162 \u0026quot;$0\u0026quot;\u0026gt;$outname chmod +x $outname  ç»§ç»­å¾€ä¸‹çœ‹ï¼Œ267è¡Œæ˜¯exit 0ï¼Œä»ç¬¬268è¡Œå¼€å§‹ï¼Œå°±æ˜¯ä¸€å †çœ‹ä¼¼ä¹±ç çš„äºŒè¿›åˆ¶äº†ï¼Œåˆ°è¿™é‡Œé‚£å°±æ¸…æ™°å¤šäº†\n# ä»268è¡Œèµ·æå–äºŒè¿›åˆ¶æ–‡ä»¶ tail -n +268 jre-for-linux.bin \u0026gt;install.sfx # å› ä¸ºæ˜¯sfxæ ¼å¼ï¼Œå°±ç”¨7zè§£å‹ 7z x install.sfx  åˆ°æ­¤è§£å‹æˆåŠŸã€‚æ‰‹åŠ¨å®‰è£…ï¼Œä½¿ç”¨exportè®¾ç½®ä¸´æ—¶å˜é‡ï¼Œå°±ç”¨ä¸Šäº†JRE6äº†ã€‚\n","date":"2018-06-02","permalink":"https://iminto.github.io/post/linux%E4%B8%8B%E8%A7%A3%E5%8E%8Bbin%E6%96%87%E4%BB%B6/","tags":["Linux"],"title":"linuxä¸‹è§£å‹binæ–‡ä»¶"},{"content":"ä»Šå¤©åœ¨ä¿®ä¸€ä¸ªè€é¡¹ç›®ï¼Œä½¿ç”¨çš„æ˜¯jfinalæ¡†æ¶ï¼Œè¿™ä¸ªæ¡†æ¶ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¼ ç»Ÿçš„æ¡†æ¶ï¼Œåªæ”¯æŒæ‰“åŒ…æˆwarè¿è¡Œæ”¾å…¥å®¹å™¨ä¸­è¿è¡Œï¼Œä½†æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨jettyå¿«é€Ÿå¯åŠ¨å’Œè°ƒè¯•ã€‚ä¸ªäººä¸æ˜¯å¾ˆå–œæ¬¢jettyï¼Œé‚æ¢æˆäº†undertowã€‚ å¼•å…¥å¦‚ä¸‹ä¾èµ–\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.undertow\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;undertow-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.0.1.Final\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.undertow\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;undertow-servlet\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.0.1.Final\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt;  å†å†™ä¸€ä¸ªå¯åŠ¨ç±»å°±å¥½äº†\npublic class Main { public static void main(String[] args) throws Exception { DeploymentInfo servletBuilder = Servlets.deployment() .setContextPath(\u0026quot;/\u0026quot;) .setClassLoader(Main.class.getClassLoader()) .setDeploymentName(\u0026quot;zooadmin.war\u0026quot;) ; FilterInfo jfinalFilter=new FilterInfo(\u0026quot;jfinal\u0026quot;,JFinalFilter.class); jfinalFilter.addInitParam(\u0026quot;configClass\u0026quot;,\u0026quot;com.baicai.core.Config\u0026quot;); servletBuilder.addFilter(jfinalFilter); servletBuilder.addFilterUrlMapping(\u0026quot;jfinal\u0026quot;,\u0026quot;/*\u0026quot;, DispatcherType.REQUEST); servletBuilder.addFilterUrlMapping(\u0026quot;jfinal\u0026quot;,\u0026quot;/*\u0026quot;, DispatcherType.FORWARD); servletBuilder.setResourceManager(new FileResourceManager(new File(\u0026quot;src/main/webapp\u0026quot;), 1024)); DeploymentManager manager = Servlets.defaultContainer().addDeployment(servletBuilder); manager.deploy(); PathHandler path = Handlers.path(Handlers.redirect(\u0026quot;/\u0026quot;)) .addPrefixPath(\u0026quot;/\u0026quot;, manager.start()); Undertow server = Undertow.builder() .addHttpListener(1080, \u0026quot;localhost\u0026quot;) .setHandler(path) .build(); // start server server.start(); } }  ç›´æ¥åœ¨è¿™ä¸ªç±»ä¸Šè¿è¡Œmainæ–¹æ³•å³å¯ã€‚å…³é”®çš„åœ°æ–¹å°±æ˜¯æŠŠä¼ ç»Ÿçš„webé¡¹ç›®çš„web.xmlç¿»è¯‘æˆJavaä»£ç è€Œå·²ã€‚ æœ¬æ¥æƒ³ç»§ç»­å®ç°springbooté‚£ç§fatjarçš„æ‰“åŒ…æ–¹å¼ï¼Œæœ€åå‘ç°ç°æœ‰çš„mavenæ’ä»¶éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œspringæ˜¯è‡ªå·±æ‰©å±•äº†jarçš„ä¸€å¥—åè®®å®ç°çš„ï¼Œå®ç°èµ·æ¥é¢‡æœ‰éš¾åº¦ã€‚ç•™å¾…ä»¥åæŠ˜è…¾å§\n","date":"2018-05-19","permalink":"https://iminto.github.io/post/%E4%BD%BF%E7%94%A8%E5%86%85%E5%B5%8Cundertow%E5%BC%80%E5%8F%91%E8%B0%83%E8%AF%95jfinal%E9%A1%B9%E7%9B%AE/","tags":["Java"],"title":"ä½¿ç”¨å†…åµŒundertowå¼€å‘è°ƒè¯•jfinalé¡¹ç›®"},{"content":"ä¹‹å‰å…¬å¸çš„ä¸€ä¸ªç½‘ç«™ä½¿ç”¨äº†OTPæ¥åšäºŒæ¬¡éªŒè¯ï¼Œç„¶åæˆ‘å°±åœ¨æ‰‹æœºä¸Šå®‰è£…äº†freeotpè¿™æ¬¾è½¯ä»¶æ¥ç®¡ç†OTPå¯†ç ï¼Œç­‰åˆ°æ¢æ‰‹æœºäº†ï¼Œæ‰å‘ç°æ²¡æ³•å¯¼å‡ºåŸæ‰‹æœºçš„é…ç½®ï¼Œè¿™å°±å°´å°¬äº†ã€‚FreeOTP is sponsored and officially published by Red Hatï¼Œä¹Ÿç®—æ˜¯å¤§å®¶é—ºç§€å‡ºå“çš„è½¯ä»¶ï¼Œå±…ç„¶ä¸æ”¯æŒè¿™ä¹ˆé‡è¦çš„åŠŸèƒ½ã€‚\nè¯•äº†å¾ˆå¤šæ–¹æ³•ï¼Œåœ¨æ‰‹æœºçš„æ–‡ä»¶ç®¡ç†å™¨ä¸­åˆ°å¤„æœç´¢ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªé…ç½®ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šfreeotpæŠŠå¯†é’¥å­˜æ”¾åœ¨äº†ç³»ç»Ÿç›®å½•ï¼Œæ²¡æœ‰rootçš„è¯ï¼Œæ˜¯æ²¡æ³•æŸ¥çœ‹å’Œå¤„ç†ç³»ç»Ÿç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå³ä½¿ç”¨å¤‡ä»½å·¥å…·ä¹Ÿå¤‡ä»½ä¸å‡ºæ¥ã€‚\nå½“åˆç½‘ç«™çš„OTPäºŒç»´ç ä¹Ÿæ‰¾ä¸åˆ°äº†ï¼Œç½‘ç«™ä¹Ÿæ²¡æ‰¾åˆ°é‡æ–°è®¾ç½®OTPçš„å…¥å£ï¼Œæœ¬ç€ä¸‡äº‹ä¸æ±‚äººçš„æƒ³æ³•ï¼Œæš‚æ—¶è¿˜ä¸æƒ³æœ€åæ±‚åŠ©è¿ç»´ã€‚çœ‹æ¥å”¯ä¸€çš„åŠæ³•å°±æ˜¯rootæ‰‹æœºäº†ï¼Œè¯•äº†å¾ˆå¤šå·¥å…·ï¼Œæ²¡æƒ³åˆ°kingrootå±…ç„¶æ”¯æŒrooté­…è“æ‰‹æœºäº†ã€‚\nrootæˆåŠŸåï¼Œé©¬ä¸Šå»freeotpçš„é…ç½®å­˜å‚¨ç›®å½•æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ° /data/data/org.fedorahosted.freeotp/shared_prefs/tokens.xml æ–‡ä»¶ï¼Œå¾—åˆ°å¦‚ä¸‹çš„é…ç½®,é…ç½®ä¸­çš„å¼•å·è¢«è½¬ä¹‰äº†\n\u0026lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?\u0026gt; \u0026lt;map\u0026gt; \u0026lt;string name=\u0026quot;bbcx@qq.com:chen\u0026quot;\u0026gt;{\u0026quot;algo\u0026quot;:\u0026quot;SHA256\u0026quot;,\u0026quot;counter\u0026quot;:0,\u0026quot;digits\u0026quot;:6,\u0026quot;issuerExt\u0026quot;:\u0026quot;bbcx@qq.com\u0026quot;,\u0026quot;label\u0026quot;:\u0026quot;chen\u0026quot;,\u0026quot;period\u0026quot;:30,\u0026quot;secret\u0026quot;:[17,-56,-42,-70,-48,-79,53],\u0026quot;type\u0026quot;:\u0026quot;TOTP\u0026quot;}\u0026lt;/string\u0026gt; \u0026lt;string name=\u0026quot;bbc\u0026quot;\u0026gt;{\u0026quot;algo\u0026quot;:\u0026quot;SHA1\u0026quot;,\u0026quot;counter\u0026quot;:0,\u0026quot;digits\u0026quot;:6,\u0026quot;issuerExt\u0026quot;:\u0026quot;\u0026quot;,\u0026quot;label\u0026quot;:\u0026quot;bbc\u0026quot;,\u0026quot;period\u0026quot;:30,\u0026quot;secret\u0026quot;:[0,1,2,3],\u0026quot;type\u0026quot;:\u0026quot;TOTP\u0026quot;}\u0026lt;/string\u0026gt; \u0026lt;string name=\u0026quot;tokenOrder\u0026quot;\u0026gt;[\u0026quot;bbcx@qq.com:bbcx\u0026quot;,\u0026quot;bbc\u0026quot;]\u0026lt;/string\u0026gt; \u0026lt;/map\u0026gt;  å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œé¢æ˜¯å°±æ˜¯å…³äºotpçš„å…¨éƒ¨é…ç½®äº†ï¼Œæœ€å…³é”®çš„å°±æ˜¯secretå­—æ®µï¼Œè¿™é‡Œåšäº†åŠ å¯†ï¼Œåå¤è¯•éªŒäº†åŠå¤©ï¼Œæ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œæœ€ç»ˆæƒ³åˆ°Googleï¼Œæ‰¾åˆ°äº†è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼š https://github.com/viljoviitanen/freeotp-export/blob/master/README.md ï¼Œåªéœ€è¦æŠŠtokens.xmlè´´åˆ°è¿™é‡Œï¼Œhttps://rawgit.com/viljoviitanen/freeotp-export/master/export-xml.htmlï¼Œå°±èƒ½è¿˜åŸå‡ºäºŒç»´ç æ¥ï¼Œç”¨æ–°æ‰‹æœºæ‰«æå°±å¥½äº†ã€‚\näº‹æƒ…è¿˜æ²¡å®Œï¼Œæœ€åæƒ³å»freeotpçš„å®˜æ–¹é‚£é‡Œååº”ä¸‹ï¼Œæ²¡æƒ³åˆ°å®˜æ–¹çš„æ€åº¦è®©æˆ‘å¤§è·Œçœ¼é•œï¼Œhttps://github.com/freeotp/freeotp-android/issues/20ï¼Œâ€œå‡ºé—¨å³è½¬ä¹°æ”¶è´¹è½¯ä»¶å»ï¼Œè€å­å°±æ˜¯ä¸å¢åŠ å¤‡ä»½åŠŸèƒ½ï¼Œä½ èƒ½å’‹åœ°â€ã€‚\n\u0026quot;'''Can I create backupcodes'''? ''No, but if you're using an Android smartphone you can replace the Google Authenticator app with Authenticator Plus. It's a really nice app that can import your existing settings, sync between devices and backup/restore using your sd-card. It's not a free app, but it's well worth the money.''\u0026quot; This proprietary app, Authenticator Plus, does look very nice and has some nice features, but the most beneficial I think is its ability to backup and restore codes. This could be a huge addition to FreeOTP and I would like to request that someone considers this feature and looks at a way of implementing it. I am not able to code myself.  æœ€ç»ˆï¼Œåœ¨ç”¨æˆ·ä¹‰æ„¤å¡«è†ºçš„è¯„è®ºä¸‹ï¼Œå‘ç°è¿™ä¸ªè½¯ä»¶ andOTPï¼ŒçœŸæ˜¯å…´å¥‹ï¼Œæ»¡è¶³äº†æˆ‘å¯¹OTPè½¯ä»¶çš„æ‰€æœ‰éœ€æ±‚ï¼Œä¹Ÿæ”¯æŒå¤‡ä»½å’Œå¯¼å…¥ï¼ŒæåŠ›æ¨èã€‚\nç«‹é©¬å¸è½½äº†æ‹½æ‹½çš„freeOTPï¼Œè£…ä¸ŠandOTPï¼Œæ„Ÿè§‰æ•´ä¸ªä¸–ç•Œéƒ½é˜³å…‰æ˜åªšã€‚å¼€æºçš„å‚²æ…¢çœŸæ˜¯é¢†æ‚Ÿäº†ï¼Œæƒ¹ä¸èµ·æƒ¹ä¸èµ·ã€‚\n","date":"2018-05-14","permalink":"https://iminto.github.io/post/export-freeopt-config/","tags":null,"title":"å¯¼å‡ºfreeOTPä¸­çš„é…ç½®"},{"content":"å¾ˆä¹…æ²¡æ›´æ–°åšå®¢äº†ï¼Œæƒ³åˆ°å‡ ä¸ªå°å‘ï¼Œè™½ç„¶æ²¡å•¥æŠ€æœ¯å«é‡ï¼Œä½†æˆ–è®¸æœ‰äººä¸çŸ¥é“å‘¢ã€‚\n1.åˆ é™¤sublistçš„å…ƒç´ å¯¼è‡´åŸå¯¹è±¡å…ƒç´ è¢«åˆ é™¤ çœ‹ä¸‹é¢è¿™æ®µä»£ç \nList\u0026lt;Integer\u0026gt; students=new ArrayList\u0026lt;Integer\u0026gt;(); for (int i = 0; i \u0026lt;5 ; i++) { students.add(i); } List\u0026lt;Integer\u0026gt; subList=new ArrayList\u0026lt;Integer\u0026gt;(); subList=students.subList(0,5); subList.remove(0); subList.remove(1); for (int i = 0; i \u0026lt;5 ; i++) { System.out.println(i+\u0026quot;=\u0026quot;+students.get(i)); }  studentsæ˜¯ä¸ªlistï¼Œç„¶åæˆ‘ä»¬æ–°å»ºç«‹äº†ä¸€ä¸ªsubListå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æˆªå–äº†studentsçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ é™¤äº†subListå¯¹è±¡é‡Œçš„ä¸€äº›å…ƒç´ ï¼Œçœ‹ä¸‹è¿è¡Œç»“æœã€‚\n0=1 1=3 2=4 Exception in thread \u0026quot;main\u0026quot; java.lang.IndexOutOfBoundsException: Index: 3, Size: 3 at java.util.ArrayList.rangeCheck(ArrayList.java:657) at java.util.ArrayList.get(ArrayList.java:433) at bai.ListDo.main(ListDo.java:17)  éš¾é“è¯´ï¼Œåˆ é™¤subListå¯¹è±¡é‡Œçš„å…ƒç´ ä¹Ÿä¼šå¯¼è‡´studentsé‡Œçš„å…ƒç´ è¢«åˆ é™¤ï¼Ÿæˆ‘æ˜æ˜æ˜¯æ–°å»ºäº†ä¸€ä¸ªå¯¹è±¡å•Šã€‚ç„¶è€Œï¼Œäº‹å®ç¡®å®æ˜¯è¿™æ ·çš„ã€‚ æˆ‘ä»¬è¦ç†è§£ä¸€ä¸ªäº‹æƒ…ï¼Œä½¿ç”¨newæ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåªæ˜¯å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾è¿™ä¸ªå¯¹è±¡çš„åœ°å€æŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¸ªæ–°å»ºçš„å¯¹è±¡åœ°å€ï¼ŒæŒ‡å‘çš„å´æ˜¯åŸæœ‰å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨subListè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä»studentsé‡ŒæŠŠå†…å®¹æ‹·è´äº†ä¸€ä»½ï¼Œä»…ä»…æ˜¯çºªå½•äº†ä¸€ä¸ªæŒ‡é’ˆçš„ç§»åŠ¨ï¼Œè¿™æ ·ä»æŸç§è§’åº¦æ¥è¯´ï¼Œæ˜¯æé«˜äº†æ€§èƒ½èŠ‚çœå†…å­˜çš„åšæ³•ã€‚ çœ‹ä¸€ä¸‹subListè¿™ä¸ªæ–¹æ³•çš„JavaDocæˆ‘ä»¬å°±æ›´æ¸…æ¥šäº†ã€‚\nReturns a view of the portion of this list between the specified * \u0026lt;tt\u0026gt;fromIndex\u0026lt;/tt\u0026gt;, inclusive, and \u0026lt;tt\u0026gt;toIndex\u0026lt;/tt\u0026gt;, exclusive. (If * \u0026lt;tt\u0026gt;fromIndex\u0026lt;/tt\u0026gt; and \u0026lt;tt\u0026gt;toIndex\u0026lt;/tt\u0026gt; are equal, the returned list is * empty.) The returned list is backed by this list, so non-structural * changes in the returned list are reflected in this list, and vice-versa. * The returned list supports all of the optional list operations supported * by this list.\u0026lt;p\u0026gt;  ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°subListæ–¹æ³•å‘¢ï¼Œé€šå¸¸æ˜¯æ¥æ”¶åˆ°äº†ä¸€ä¸ªå¤§çš„listï¼Œéœ€è¦åˆ‡å‰²æˆä¸€ä¸ªä¸ªå°çš„å­listå†åŠ å·¥å¤„ç†ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨å’Œæé«˜æ€§èƒ½ï¼Œå¦‚æœä¸æ³¨æ„çš„è¯ï¼Œå°±å¾ˆå®¹æ˜“è§¦å‘è¿™ç§éšå½¢çš„bugã€‚æ‰€ä»¥ï¼Œä½¿ç”¨subListæ—¶ä¸è¦è½»æ˜“åšå¢åˆ æ“ä½œï¼Œè¦ä¹ˆä¸ä½¿ç”¨subListæ–¹æ³•ï¼Œè€Œæ˜¯æ‰‹åŠ¨add.\n2.SimpleDateFormatçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ å¾ˆå¤šåšå®¢å’Œæ–‡ç« éƒ½ä¼šå‘Šè¯‰æˆ‘ä»¬ï¼Œä¸€å®šè¦æ³¨æ„SimpleDateFormatçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚£ç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ çœ‹ä¸‹é¢çš„ä»£ç \npublic class DateFormatTest extends Thread { @Override public void run() { while(true) { try { this.join(2000); } catch (InterruptedException e1) { e1.printStackTrace(); } try { System.out.println(this.getName()+\u0026quot;:\u0026quot;+DateUtil.parse(\u0026quot;2018-05-05 12:12:12\u0026quot;)); } catch (ParseException e) { e.printStackTrace(); } } } public static void main(String[] args) { for(int i = 0; i \u0026lt; 3; i++){ new DateFormatTest().start(); } } } class DateUtil { private static final SimpleDateFormat sdf = new SimpleDateFormat(\u0026quot;yyyy-MM-dd HH:mm:ss\u0026quot;); public static String formatDate(Date date)throws ParseException{ return sdf.format(date); } public static Date parse(String strDate) throws ParseException{ return sdf.parse(strDate); } }  è¿è¡Œè¿™æ®µä»£ç åï¼Œä¼šå‘ç°Thread-1ä¼šæŠ¥å‡ºException in thread \u0026ldquo;Thread-0\u0026rdquo; Exception in thread \u0026ldquo;Thread-1\u0026rdquo; java.lang.NumberFormatException: multiple points çš„å¼‚å¸¸ï¼Œå¹¶ä¸”å¯¼è‡´Thread-2æœ‰ä¸€äº›é”™è¯¯çš„æ—¥æœŸè¾“å‡ºã€‚ä¸ºä»€ä¹ˆå‘¢ï¼ŒåŸå› åœ¨äºSimpleDataFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºSimpleDataFormaté‡Œé¢ç”¨äº†Calendar è¿™ä¸ªæˆå‘˜å˜é‡æ¥å®ç°SimpleDataFormat,å¹¶ä¸”åœ¨Parse å’ŒFormatçš„æ—¶å€™å¯¹Calendar è¿›è¡Œäº†ä¿®æ”¹ï¼Œcalendar.clear()ï¼Œcalendar.setTime(date); ä¸ºäº†çº¿ç¨‹å®‰å…¨å’Œæ•ˆç‡çš„åŒé‡å…¼é¡¾ï¼Œå»ºè®®ä½¿ç”¨ThreadLocalï¼Œä»£ç å¦‚ä¸‹ï¼š\npublic class DateUtil1 { private static final ThreadLocal\u0026lt;DateFormat\u0026gt; messageFormat = new ThreadLocal\u0026lt;DateFormat\u0026gt;(); private static final String MESSAGE_FORMAT = \u0026quot;MM-dd HH:mm:ss.ms\u0026quot;; private static final DateFormat getDateFormat() { DateFormat format = messageFormat.get(); if (format == null) { format = new SimpleDateFormat(MESSAGE_FORMAT, Locale.getDefault()); messageFormat.set(format); } return format; } }  å¦‚æœè‡ªå·±æ²¡æœ‰æŠŠæ¡çš„è¯ï¼Œè¿˜æ˜¯å»ºè®®æ¯æ¬¡newä¸€ä¸ªSimpleDataFormatå¯¹è±¡ã€‚ Javaé‡Œé¢è¿˜æœ‰è®¸å¤šçº¿ç¨‹ä¸å®‰å…¨çš„ç±»ï¼Œä½¿ç”¨è¿™äº›ç±»çš„æ—¶å€™ï¼ŒåŠ¡å¿…æ³¨æ„ä½¿ç”¨åŒæ­¥åŸè¯­ï¼Œæˆ–è€…ä½¿ç”¨newæ–°å»ºä¸€ä¸ªå¯¹è±¡çœäº‹ï¼Œæˆ–è€…ä½¿ç”¨å¯¹åº”çš„çº¿ç¨‹å®‰å…¨çš„ç±»ã€‚æ¯”å¦‚hashMapå¯¹åº”çš„ConcurrentHashMap.\n3.splitçš„å‘ çœ‹ä¸‹é¢çš„ä»£ç ï¼Œ\nString[] re=\u0026quot;2|33|4\u0026quot;.split(\u0026quot;|\u0026quot;); for (int i = 0; i \u0026lt;re.length ; i++) { System.out.println(re[i]); }  ä½ ä»¥ä¸ºè¾“å‡ºçš„ç»“æœä¼šæ˜¯2,33,4ï¼Œå®é™…ä¸Šå´æ˜¯ 2,|ï¼Œ3,3ï¼Œ|ï¼Œ4ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Œç¨å¾®çœ‹ä¸€ä¸‹splitçš„æ–¹æ³•æ³¨é‡Šå°±çŸ¥é“äº†ï¼ŒåŸæ¥splitçš„åˆ†éš”ç¬¦å‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²ã€‚ æ‰€ä»¥ï¼Œæ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯String.split(\u0026quot;\\|\u0026quot;) å½“ç„¶ï¼Œè¿™ç§å‘çº¯ç²¹æ˜¯ç”±äºå¯¹JavaåŸºæœ¬æ–¹æ³•çš„ä½¿ç”¨ä¸ç†Ÿæ‚‰é€ æˆçš„ï¼Œæ˜¯å®Œå…¨å¯ä»¥é¿å…çš„ã€‚\n","date":"2018-05-05","permalink":"https://iminto.github.io/post/java_trap/","tags":["Java"],"title":"Javaé‡Œå¸¸è§çš„å‡ ä¸ªè¯­æ³•å°å‘"},{"content":"â€ƒè¿™ä¸¤å¤©æƒ³ç»™åšå®¢åšä¸ªæ’ä»¶,åˆ©ç”¨é˜¿é‡Œäº‘çš„OSSæ¥å­˜å‚¨æ–‡ä»¶.ä½†é˜¿é‡Œçš„æ–‡æ¡£å’Œä»£ç éƒ½çƒ‚çš„è¶…ä¹æƒ³è±¡,è¦ä¹ˆä»£ç è€æ—§ä¸å ª,è¦ä¹ˆè·Ÿå°è„šè€å¤ªä¸€æ ·å¼•å…¥ä¸€å¨ä¾èµ–,æƒ³å¿…è¿™å—æ˜¯å¤–åŒ…å›¢é˜Ÿåšçš„å§,æˆ–è€…é˜¿é‡Œéæ ¸å¿ƒä¸šåŠ¡å‘˜çš„æŠ€æœ¯æ°´å¹³ä¹Ÿå°±è¿™æ ·å§.\nâ€ƒæ‰€ä»¥æƒ³ç»•å¼€é˜¿é‡Œäº‘å®˜æ–¹æä¾›çš„ä»£ç è‡ªå·±æ•´ä¸€å¥—OSSçš„API,å…ˆè·‘ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„demo,èƒ½åœ¨å®¢æˆ·ç«¯è·‘é€šåå†ç”¨ä»£ç å»å®ç°.æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç”¨REST clientæ¥æ¨¡æ‹Ÿ.æŠ˜è…¾äº†ä¸€ä¸‹,è¿˜æŒºè´¹åŠ²,è®°å½•ä¸‹æŠ˜è…¾è¿‡ç¨‹\nâ€ƒå…ˆæ¥è¯•è¯•ä¸Šä¼ æ–‡ä»¶,é€‰æ‹©PUTæ–¹æ³•,è¦è¯·æ±‚çš„URLä¸ºhttp://baicaidoc.oss-cn-shenzhen.aliyuncs.com/image/small/mm1.jpg ,æ·»åŠ ä»¥ä¸‹header,headerå¤´éœ€è¦åŒ…å«å“ªäº›å†…å®¹å¯ä»¥çœ‹è¿™é‡Œ\nAuthorization:OSS LTAIxkX6Qj2OuMZ6:tLZ7nYYP/hkCJbG/6gkOJ7Mi4E= Date:Thu, 25 Jan 2018 15:20:39 GMT Content-Disposition:attachment;filename=ivy.jpg Host:baicaidoc.oss-cn-shenzhen.aliyuncs.com Content-Encoding:utf-8  ç„¶ååœ¨bodyé‡Œæ·»åŠ file body. è‡³äºheaderå¤´æ€ä¹ˆå†™å’ŒAuthorizationå­—æ®µè®¡ç®—çš„æ–¹æ³•,æ–‡æ¡£é‡Œè¯´çš„æ¯”è¾ƒæ¸…æ™°äº†https://help.aliyun.com/document_detail/31951.html. å°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯Dateå¿…é¡»æ˜¯GMTæ ¼å¼,è¿™ä¸ªå¯¹Javaæ¥è¯´ä¹Ÿå¥½åŠ,ä¸è¿‡è¦æ³¨æ„æ—¶åŒºçš„é—®é¢˜,GMTæ—¶é—´æ¯”ä¸œå…«åŒºæ…¢äº†8ä¸ªå°æ—¶.è¿˜æœ‰Hostéœ€è¦å¸¦ä¸Šbucket,è¿™åœ¨æ—©æœŸæ˜¯ä¸éœ€è¦çš„(æ—©æœŸå¸¦ä¸Šåè€Œä¼šæŠ¥é”™SignatureDoesNotMatch) å¦å¤–å°±æ˜¯è¿™ä¸ªAuthorizationå­—æ®µçš„ç­¾åéœ€è¦æ³¨æ„,base64éœ€è¦å¤„ç†byte[]æ•°ç»„,è€Œä¸æ˜¯å­—ç¬¦ä¸².æ‰€ä»¥ç”¨ç½‘ä¸Šçš„åœ¨çº¿éªŒè¯å·¥å…·æ˜¯éªŒè¯ä¸äº†çš„. Javaç‰ˆçš„ç­¾åä»£ç å¦‚ä¸‹:\nimport bai.tool.Base64; import javax.crypto.Mac; import javax.crypto.spec.SecretKeySpec; import java.security.InvalidKeyException; import java.security.NoSuchAlgorithmException; /** * Hello world! * */ public class App { public static byte[] hamcsha1(byte[] data, byte[] key) { try { SecretKeySpec signingKey = new SecretKeySpec(key, \u0026quot;HmacSHA1\u0026quot;); Mac mac = Mac.getInstance(\u0026quot;HmacSHA1\u0026quot;); mac.init(signingKey); return mac.doFinal(data); } catch (NoSuchAlgorithmException e) { e.printStackTrace(); } catch (InvalidKeyException e) { e.printStackTrace(); } return null; } public static void main( String[] args ) { String toSign=\u0026quot;PUT\\n\u0026quot; + \u0026quot;\\n\u0026quot; + \u0026quot;image/jpeg; charset=UTF-8\\n\u0026quot; + \u0026quot;Thu, 25 Jan 2018 15:20:39 GMT\\n\u0026quot; + \u0026quot;/baicaidoc/image/small/mm1.jpg\u0026quot;; String accessKey=\u0026quot;OrzrzxIsfpFjA7S7yk0Lwy8Bw21TLhquhboiip56\u0026quot;; byte[] hm=hamcsha1(toSign.getBytes(),accessKey.getBytes()); System.out.println(\u0026quot;OSS LTAIxkX6Qj2OuMZ6:\u0026quot;+Base64.encodeToString(hm)); } }  â€ƒå®¢æˆ·ç«¯èƒ½è·‘é€šå°±å¥½åŠäº†ï¼Œæœ€åæ˜¯ä»£ç ï¼Œä½¿ç”¨HttpURLConnectionæ¥å®ç°PUTä¸Šä¼ ä»£ç ã€‚é˜¿é‡Œäº‘çš„OSS SDKå¤ªé‡äº†ï¼Œè€Œä¸€èˆ¬å¸¸ç”¨çš„å°±ä¸Šä¼ å’Œåˆ é™¤åŠŸèƒ½\nimport java.io.*; import java.net.HttpURLConnection; import java.net.MalformedURLException; import java.net.URL; import java.text.SimpleDateFormat; import java.util.Date; import java.util.Locale; import java.util.TimeZone; public class OSSUpload { public String httpUrlConnectionPut(String fileName) { String result = \u0026quot;\u0026quot;; URL url = null; String httpUrl = \u0026quot;http://baicaidoc.oss-cn-shenzhen.aliyuncs.com/image/small/test.jpg\u0026quot;; try { url = new URL(httpUrl); } catch (MalformedURLException e) { e.printStackTrace(); } if (url != null) { HttpURLConnection urlConn; try { urlConn = (HttpURLConnection) url.openConnection(); File file = new File(fileName); urlConn.setRequestProperty(\u0026quot;content-type\u0026quot;, \u0026quot;image/jpeg; charset=UTF-8\u0026quot;); urlConn.setDoOutput(true);// httpæ­£æ–‡å†…ï¼Œå› æ­¤éœ€è¦è®¾ä¸ºtrue, é»˜è®¤æƒ…å†µä¸‹æ˜¯false; urlConn.setDoInput(true);// è®¾ç½®æ˜¯å¦ä»httpUrlConnectionè¯»å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯true; urlConn.setConnectTimeout(15 * 1000); urlConn.setRequestProperty(\u0026quot;User-Agent\u0026quot;, \u0026quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36\u0026quot;); //è®¾ç½®è¯·æ±‚æ–¹å¼ä¸º PUT urlConn.setRequestMethod(\u0026quot;PUT\u0026quot;); urlConn.setRequestProperty(\u0026quot;Connection\u0026quot;, \u0026quot;Keep-Alive\u0026quot;); SimpleDateFormat sdf = new SimpleDateFormat(\u0026quot;EEE, dd MMM yyyy HH:mm:ss 'GMT'\u0026quot;, Locale.US); sdf.setTimeZone(TimeZone.getTimeZone(\u0026quot;GMT\u0026quot;)); urlConn.setRequestProperty(\u0026quot;Host\u0026quot;, \u0026quot;baicaidoc.oss-cn-shenzhen.aliyuncs.com\u0026quot;); urlConn.setRequestProperty(\u0026quot;Content-Encoding\u0026quot;, \u0026quot;UTF-8\u0026quot;); urlConn.setRequestProperty(\u0026quot;Date\u0026quot;, sdf.format(new Date())); urlConn.setRequestProperty(\u0026quot;Content-Length\u0026quot;, String.valueOf(file.length())); urlConn.setRequestProperty(\u0026quot;Authorization\u0026quot;, \u0026quot;OSS LTAIxk223j2OuMZ6:tLZ74YYP/hkCJbG/6gkOJ7Mi4E=\u0026quot;); DataOutputStream dos = new DataOutputStream(urlConn.getOutputStream()); //å†™å…¥è¯·æ±‚å‚æ•° try { InputStream in = new FileInputStream(file); int bytes = 0; byte[] bufferOut = new byte[4096]; while ((bytes = in.read(bufferOut)) != -1) { dos.write(bufferOut, 0, bytes); } dos.flush(); dos.close(); InputStream is = urlConn.getInputStream(); int ch; StringBuffer b = new StringBuffer(); while ((ch = is.read()) != -1) { b.append((char) ch); } System.out.println(\u0026quot;result:\u0026quot; + b.toString()); }catch (IOException e){ e.printStackTrace(); InputStream is=urlConn.getErrorStream(); int ch; StringBuffer b = new StringBuffer(); while ((ch = is.read()) != -1) { b.append((char) ch); } System.out.println(\u0026quot;error result:\u0026quot;+b.toString()); } urlConn.disconnect(); } catch (Exception e) { e.printStackTrace(); }finally { } } return result; } public static void main(String[] args) { OSSUpload oss = new OSSUpload(); oss.httpUrlConnectionPut(\u0026quot;/home/chen/Desktop/tmp/sd.png\u0026quot;); } }  ","date":"2018-01-25","permalink":"https://iminto.github.io/post/aliyun_oss_custom/","tags":["Java"],"title":"æŠ˜è…¾é˜¿é‡Œäº‘OSSçš„API"},{"content":"â€ƒå‰ä¸ä¹…,æœ‰äººé—®åˆ°æˆ‘ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨mb_check_encodingæ¥ä¾¦æµ‹ä¸€æ®µå­—ç¬¦çš„ç¼–ç ï¼Œé¢„æœŸæ˜¯GBKç¼–ç ï¼Œä½†æ˜¯PHPç»™å‡ºæ¥UTF-8ç¼–ç çš„é”™è¯¯åˆ¤æ–­ã€‚é‚£ä¹ˆï¼Œmb_check_encodingçš„æ­£ç¡®å§¿åŠ¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼Œ\n\u0026lt;?php $utf8Str = 'åˆ«abcæ‰¯æ·¡'; var_dump(mb_check_encoding($utf8Str, 'UTF-8')); //è¾“å‡ºtrue var_dump(mb_check_encoding($utf8Str, 'gbk')); //è¾“å‡ºtrue  â€ƒè¿™æ®µä»£ç çš„è¾“å‡ºæ˜¯å•¥å‘¢ï¼ŸæŒ‰ç†ï¼Œæˆ‘ä»¬çš„PHPæ–‡ä»¶ä¿å­˜ä¸ºä»€ä¹ˆç¼–ç ï¼Œé‚£å®ƒè¾“å‡ºçš„å°±åº”è¯¥æ˜¯å•¥ç¼–ç ï¼Œç„¶è€Œä»¥ä¸Šè¾“å‡ºçš„éƒ½æ˜¯trueã€‚å†æ¢ä¸ªä¾‹å­ï¼Œè¿™æ ·å‘¢ï¼Ÿ\n\u0026lt;?php $utf8Str = 'åˆ«abcæ‰¯æ·¡å•Š'; var_dump(mb_check_encoding($utf8Str, 'UTF-8')); var_dump(mb_check_encoding($utf8Str, 'gbk'));  â€ƒåé¢å¤šåŠ äº†ä¸€ä¸ªæ±‰å­—ï¼Œè¿™æ¬¡PHPåšå‡ºäº†æ­£ç¡®çš„åˆ¤æ–­ï¼Œç»™å‡ºäº†æ˜¯UTF-8çš„åˆ¤æ–­ã€‚é‚£ä¹ˆmb_check_encodingåˆ°åº•æœ‰æ²¡æœ‰ç”¨ï¼Ÿæ˜¯è¿™ä¸ªå‡½æ•°æœ‰bugè¿˜æ˜¯æˆ‘è‡ªå·±ä¸æ‡‚å§¿åŠ¿ï¼Ÿ\nâ€ƒéš¾é“æ˜¯ï¼Œåªè¦æ±‰å­—æ˜¯3çš„æ•´æ•°å€å°±ä¼šåˆ¤æ–­å¤±çµï¼Ÿè¯•éªŒåç¡®å®æ˜¯çš„ï¼Œå½“ç„¶è¿™åªæ˜¯è¡¨é¢ç°è±¡ï¼Œä½†æ— ç–‘è¯´æ˜è¿™ä¸ªå‡½æ•°æ˜¯ä¸å¯é çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶å®åŸç†è¯´èµ·æ¥ä¹Ÿä¸éš¾ç†è§£ï¼Œè®¡ç®—æœºå¹¶ä¸æ‡‚ä»€ä¹ˆå«ä¹±ç ã€‚ä¸€æ®µæ–‡å­—ï¼Œè§£é‡ŠæˆUTF8æˆ–GBKå…¶å®éƒ½æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬ç”¨è‚‰çœ¼çœ‹åˆ°æœ‰äº†ä¹±ç ï¼Œæ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œè§‰å¾—è§£é‡Šæˆè¿™ç§ç¼–ç æ˜¯é”™è¯¯çš„ï¼Œè€Œè§£é‡Šæˆå¦å¤–ä¸€ç§ç¼–ç æ‰ç®—æ­£ç¡®ã€‚å¯æ˜¯è®¡ç®—æœºä¸æ‡‚å•Šï¼Œä½ è§‰å¾—æœ‰ä¸ªå­—ç¬¦å¾ˆå¥‡æ€ªï¼Œä½ ä¸è®¤è¯†æ‰€ä»¥è®¤å®šæ˜¯ä¹±ç ï¼Œå¯è®¡ç®—æœºè®¤è¯†å•Šï¼Œå®ƒä¸è§‰å¾—å¥‡æ€ªã€‚é™¤éå­—èŠ‚æ•°è§£é‡Šæˆå¦å¤–ä¸€ç§ç¼–ç ï¼Œä¼šå¤šå‡ºä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”ASCIIç ä¹Ÿä¸æ˜¯å¸¸è§èŒƒå›´ï¼Œè®¡ç®—æœºæ‰èƒ½å¤§èƒ†åˆ¤å®šè§£é‡Šæˆè¿™ç§ç¼–ç ä¸å¯¹ã€‚æ‰€ä»¥è¿™æ ·å»æ£€æµ‹ç¼–ç æ˜¯æ— æ³•å®Œå…¨å¯é åœ°.\nâ€ƒé‚£æ—¢ç„¶mb_check_encodingè¿™ä¸ªå‡½æ•°ä¸å¯é ï¼Œé‚£ä¹ˆç”¨æ­£åˆ™å¯é ä¹ˆï¼Ÿæˆ–è®¸å§ã€‚ ä½†æ˜¯æˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨çš„æ˜¯PHPä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªåŠŸèƒ½ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–è¯­è¨€æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæˆ–è€…æ ¹æœ¬ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Ÿ\nâ€ƒé—®é¢˜è¿˜æ˜¯å‡ºåœ¨PHPæœ¬èº«ã€‚å› ä¸ºå®¢æˆ·ç«¯å¯èƒ½ä¼šæœ‰å¤šç§ç¼–ç è¾“å…¥ï¼ŒPHPä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å°±å¼•å…¥è¿™ä¹ˆä¸€ä¸ªè´´å¿ƒçš„å‡½æ•°ç»™ä½¿ç”¨è€…ã€‚å¯æ˜¯PHPä¸åº”è¯¥æ˜¯é‡åˆ°é—®é¢˜å°±å»åŠ¨æ­ªè„‘ç­‹è§£å†³é—®é¢˜å•Šï¼Œè€Œä¸”è§„èŒƒé—®é¢˜ã€‚ä¸ºä»€ä¹ˆå…¶ä»–è¯­è¨€ä¸éœ€è¦åœ¨SDKé‡Œå¼•å…¥è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿæˆ–è€…è¯´æ˜¯PHPç¨‹åºå‘˜çš„ä½¿ç”¨å§¿åŠ¿ä¸æ­£ç¡®?\nâ€ƒæœ€åï¼Œå…¶å®PHPç»™å‡ºè¿™ä¸ªå‡½æ•°ä¹Ÿä¸ç®—é”™ï¼Œä½†æ˜¯ä¸€å®šè¦å‚ç…§å…¶ä»–è¯­è¨€é‡Œçš„æƒ¯è¡Œåšæ³•ï¼Œåœ¨æ–‡æ¡£é‡Œè¯´æ¸…æ¥šï¼Œè¿™ä¸ªå‡½æ•°çš„åˆ¤æ–­çš„æ˜¯ä¸€ç§â€œå¯ä¿¡åº¦â€ï¼Œè€Œä¸æ˜¯ç»™å‡ºä¸€ä¸ªéæ­¤å³å½¼çš„â€œæƒå¨â€ç»“æœã€‚ä½†æ˜¯é—æ†¾çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°çš„æ–‡æ¡£é‡Œæ²¡è¯´å¾ˆå¥½çš„è¯´æ¸…æ¥šï¼Œè€Œæ˜¯è¿™ä¹ˆå†™çš„ï¼Œ\n â€œChecks if the specified byte stream is valid for the specified encoding. It is useful to prevent so-called \u0026ldquo;Invalid Encoding Attack Returns TRUE on success or FALSE on failure.â€\n â€ƒå…¶å®åŠ ä¸Šè¿™æ ·ä¸€å¥è¯â€œThis function only give the confidence level of the resultâ€å°±å¥½äº†ï¼Œä¹Ÿå°±ä¸ä¼šå¹³ç™½å¼•èµ·é‚£ä¹ˆå¤šçš„ç–‘è™‘ã€‚\nâ€ƒæ¯”å¦‚ï¼ŒPythonçš„åšæ³•å°±æ¯”è¾ƒä¸“ä¸šï¼Œchardetæ¨¡å—ç»™å‡ºçš„æ˜¯ä¸€ä¸ªç½®ä¿¡æ£€æµ‹ï¼Œè€Œä¸æ˜¯étrueå³falseçš„åˆ¤æ–­ã€‚javaé‡Œé¢çš„ç¬¬ä¸‰æ–¹å·¥å…·åŒ…cpdetectorä¹ŸæŒ‡å‡ºäº†å…¶è§„åˆ™ï¼ŒæŒ‰ç…§â€œè°æœ€å…ˆè¿”å›éç©ºçš„æ¢æµ‹ç»“æœï¼Œå°±ä»¥è¯¥ç»“æœä¸ºå‡†â€çš„åŸåˆ™è¿”å›æ¢æµ‹åˆ°çš„å­—ç¬¦é›†ç¼–ç ã€‚å…¶æ˜¯åŸºäºç»Ÿè®¡å­¦åŸç†çš„ï¼Œä¸ä¿è¯å®Œå…¨æ­£ç¡®ã€‚\n","date":"2018-01-12","permalink":"https://iminto.github.io/post/php%E7%9A%84mb_check_encoding%E5%87%BD%E6%95%B0%E7%9A%84%E5%AD%98%E5%9C%A8%E6%98%AF%E9%B8%A1%E8%82%8B%E5%90%97/","tags":["PHP"],"title":"PHPçš„mb_check_encodingå‡½æ•°çš„å­˜åœ¨æ˜¯é¸¡è‚‹å—"},{"content":"â€ƒé’ˆå¯¹æœ€æ–°ç«ç‹æµè§ˆå™¨50+ä»¥ä¸Šç‰ˆæœ¬çš„firebugåè®®ï¼Œç±»ä¼¼FirePHPï¼Œä½†æ˜¯FirePHPå·²ç»å¾ˆä¹…ä¸æ›´æ–°ï¼Œå¹¶ä¸”å¯¹æœ€æ–°çš„æµè§ˆå™¨ä¹Ÿå·²å¤±æ•ˆã€‚\n è¿™ä¸ªåœ¨Firebugä¹‹ä¸Šè¿è¡Œçš„æ‰©å±•ï¼Œç»“åˆä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„åº“ï¼Œå°±å¯ä»¥è®©ä½ çš„PHPä»£ç å‘æµè§ˆå™¨å‘é€è°ƒè¯•ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯ä»¥HTTPå“åº”å¤´ï¼ˆHTTP headersï¼‰çš„æ–¹å¼ç¼–ç ã€‚ç»è¿‡è®¾ç½®ï¼Œä½ å¯ä»¥åƒåœ¨Firebugæ§åˆ¶å°è°ƒè¯•JavaScriptä»£ç ä¸€æ ·å¾—åˆ°PHPè„šæœ¬çš„è­¦å‘Šå’Œé”™è¯¯æç¤ºã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“æ­¥éª¤ã€‚\n ç›´æ¥ä¸Šä»£ç \nimport com.alibaba.fastjson.JSON; import java.util.ArrayList; import java.util.HashMap; import java.util.Map; import java.util.Objects; /** * @version V1.0 * @Description:ç›´æ¥è¾“å‡ºæœåŠ¡å™¨ç«¯è°ƒè¯•æ—¥å¿—åˆ°æ§åˆ¶å°ï¼Œç®€æ˜“ç‰ˆæœ¬ã€‚ * @date 2017/6/13 16:51 */ public class DebugTool { public final String VERSION = \u0026quot;2.0.j1\u0026quot;; public final String HEADER_NAME = \u0026quot;X-ChromeLogger-Data\u0026quot;; protected Map\u0026lt;String, Object\u0026gt; console = new HashMap\u0026lt;\u0026gt;(); private String response=\u0026quot;\u0026quot;; public DebugTool() { console.put(\u0026quot;version\u0026quot;, VERSION); console.put(\u0026quot;columns\u0026quot;, new String[]{\u0026quot;log\u0026quot;, \u0026quot;backtrace\u0026quot;, \u0026quot;type\u0026quot;}); console.put(\u0026quot;rows\u0026quot;, new ArrayList\u0026lt;Objects\u0026gt;()); console.put(\u0026quot;request_uri\u0026quot;, this.getClass().getName()); } public DebugTool(Class cls) { this(); console.put(\u0026quot;request_uri\u0026quot;, cls.getName()); } public void log(Object o) { log(o,\u0026quot;\u0026quot;); } public void info(Object o) { log(o,\u0026quot;info\u0026quot;); } public void warn(Object o) { log(o,\u0026quot;warn\u0026quot;); } public void error(Object o) { log(o,\u0026quot;error\u0026quot;); } public void log(Object o,String type) { Object[] info; if(o instanceof Map){ info = new Object[]{o}; }else { info = new Object[]{o.toString()}; } Object[] obj = new Object[]{info, console.get(\u0026quot;request_uri\u0026quot;), type}; ArrayList\u0026lt;Object\u0026gt; rows = (ArrayList\u0026lt;Object\u0026gt;) console.get(\u0026quot;rows\u0026quot;); rows.add(obj); console.put(\u0026quot;rows\u0026quot;, rows); } public String getResponse(){ String json = JSON.toJSONString(console); json = Base64.encodeToString(json); return json; } }  ä½¿ç”¨æ–¹æ³•ï¼š\nDebugTool debug=new DebugTool(this.getClass()); tool.log(\u0026quot;hello å…«é˜¿å“¥\u0026quot;); Map hash=new HashMap(); hash.put(\u0026quot;25\u0026quot;,\u0026quot;å¼ ä¸‰\u0026quot;); hash.put(\u0026quot;19\u0026quot;,\u0026quot;æå››\u0026quot;); tool.warn(hash); response.add(DebugTool.HEADER_NAME,tool.response);  ä»…å¯¹æœ€æ–°ç‰ˆFirefoxæœ‰æ•ˆã€‚æ–°ç‰ˆchromeæœ‰è‡ªå·±çš„debugåè®®ï¼ˆä½¿ç”¨websocketï¼‰ã€‚æœ‰è¶£çš„æ˜¯ï¼Œè¿™æœ¬æ¥æ˜¯ä¸€ä¸ªchromeæµè§ˆå™¨æ”¯æŒçš„åè®®ï¼Œåæ¥chromeæ”¾å¼ƒäº†ï¼Œè€ŒFirefoxæ‹¿è¿‡æ¥äº†ã€‚ å‚è€ƒï¼šhttps://craig.is/writing/chrome-logger\n","date":"2018-01-10","permalink":"https://iminto.github.io/post/firejava%E8%BE%93%E5%87%BAjava%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E8%B0%83%E8%AF%95%E6%97%A5%E5%BF%97%E5%88%B0%E6%8E%A7%E5%88%B6%E5%8F%B0/","tags":["Java"],"title":"FireJavaè¾“å‡ºJavaæœåŠ¡å™¨ç«¯è°ƒè¯•æ—¥å¿—åˆ°æ§åˆ¶å°"},{"content":"TOTP æ¦‚å¿µ TOTP - Time-based One-time Password Algorithm is an extension of the HMAC-based One Time Password algorithm HOTP to support a time based moving factor.\nTOTPï¼ˆåŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•ï¼‰æ˜¯æ”¯æŒæ—¶é—´ä½œä¸ºåŠ¨æ€å› ç´ åŸºäºHMACä¸€æ¬¡æ€§å¯†ç ç®—æ³•çš„æ‰©å±•ã€‚å®ƒæ˜¯OTPç®—æ³•çš„ä¸€ç§\nç®—æ³•å¦‚ä¸‹: TOTP = Truncate(HMAC-SHA-1(K, (T - T0) / X))\nK å…±äº«å¯†é’¥ T æ—¶é—´ T0 å¼€å§‹è®¡æ•°çš„æ—¶é—´æ­¥é•¿ X æ—¶é—´æ­¥é•¿\nä»£ç å®ç° æœ€ç®€å®ç°éœ€è¦å¦‚ä¸‹ä¸¤ä¸ªç±» 1.Base32.java\npublic class Base32 { private static final char[] ALPHABET = { 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '2', '3', '4', '5', '6', '7' }; private static final byte[] DECODE_TABLE; static { DECODE_TABLE = new byte[128]; for (int i = 0; i \u0026lt; DECODE_TABLE.length; i++) { DECODE_TABLE[i] = (byte) 0xFF; } for (int i = 0; i \u0026lt; ALPHABET.length; i++) { DECODE_TABLE[(int) ALPHABET[i]] = (byte) i; if (i \u0026lt; 24) { DECODE_TABLE[(int) Character.toLowerCase(ALPHABET[i])] = (byte) i; } } } public static String encode(byte[] data) { char[] chars = new char[((data.length * 8) / 5) + ((data.length % 5) != 0 ? 1 : 0)]; for (int i = 0, j = 0, index = 0; i \u0026lt; chars.length; i++) { if (index \u0026gt; 3) { int b = data[j] \u0026amp; (0xFF \u0026gt;\u0026gt; index); index = (index + 5) % 8; b \u0026lt;\u0026lt;= index; if (j \u0026lt; data.length - 1) { b |= (data[j + 1] \u0026amp; 0xFF) \u0026gt;\u0026gt; (8 - index); } chars[i] = ALPHABET[b]; j++; } else { chars[i] = ALPHABET[((data[j] \u0026gt;\u0026gt; (8 - (index + 5))) \u0026amp; 0x1F)]; index = (index + 5) % 8; if (index == 0) { j++; } } } return new String(chars); } public static byte[] decode(String s) throws Exception { char[] stringData = s.toCharArray(); byte[] data = new byte[(stringData.length * 5) / 8]; for (int i = 0, j = 0, index = 0; i \u0026lt; stringData.length; i++) { int val; try { val = DECODE_TABLE[stringData[i]]; } catch (ArrayIndexOutOfBoundsException e) { throw new Exception(\u0026quot;Illegal character\u0026quot;); } if (val == 0xFF) { throw new Exception(\u0026quot;Illegal character\u0026quot;); } if (index \u0026lt;= 3) { index = (index + 5) % 8; if (index == 0) { data[j++] |= val; } else { data[j] |= val \u0026lt;\u0026lt; (8 - index); } } else { index = (index + 5) % 8; data[j++] |= (val \u0026gt;\u0026gt; index); if (j \u0026lt; data.length) { data[j] |= val \u0026lt;\u0026lt; (8 - index); } } } return data; } }  2.GoogleAuthenticator.java\nimport javax.crypto.spec.SecretKeySpec; import java.security.InvalidKeyException; import java.security.NoSuchAlgorithmException; import java.security.SecureRandom; import java.util.Base64; import javax.crypto.Mac; public class GoogleAuthenticator { // taken from Google pam docs - we probably don't need to mess with these public static final int SECRET_SIZE = 10; public static final String SEED = \u0026quot;g8GjEvTbW5oVSV7avLBdwIHqGlUYNzKFI7izOF8GwLDVKs2m0QN7vxRs2im5MDaNCWGmcD2rvcZx\u0026quot;; public static final String RANDOM_NUMBER_ALGORITHM = \u0026quot;SHA1PRNG\u0026quot;; int window_size = 3; // default 3 - max 17 (from google docs)æœ€å¤šå¯åç§»çš„æ—¶é—´ /** * set the windows size. This is an integer value representing the number of 30 second windows * we allow * The bigger the window, the more tolerant of clock skew we are. * @param s window size - must be \u0026gt;=1 and \u0026lt;=17. Other values are ignored */ public void setWindowSize(int s) { if (s \u0026gt;= 1 \u0026amp;\u0026amp; s \u0026lt;= 17) window_size = s; } /** * Generate a random secret key. This must be saved by the server and associated with the * users account to verify the code displayed by Google Authenticator. * The user must register this secret on their device. * @return secret key */ public static String generateSecretKey() { SecureRandom sr = null; try { sr = SecureRandom.getInstance(RANDOM_NUMBER_ALGORITHM); sr.setSeed(Base64.getDecoder().decode(SEED)); byte[] buffer = sr.generateSeed(SECRET_SIZE); Base32 codec = new Base32(); byte[] bEncodedKey = codec.encode(buffer).getBytes(); String encodedKey = new String(bEncodedKey); return encodedKey; }catch (NoSuchAlgorithmException e) { // should never occur... configuration error } return null; } /** * Return a URL that generates and displays a QR barcode. The user scans this bar code with the * Google Authenticator application on their smartphone to register the auth code. They can also * manually enter the * secret if desired * @param user user id (e.g. fflinstone) * @param host host or system that the code is for (e.g. myapp.com) * @param secret the secret that was previously generated for this user * @return the URL for the QR code to scan */ public static String getQRBarcodeURL(String user, String host, String secret) { String format = \u0026quot;https://www.google.com/chart?chs=200x200\u0026amp;chld=M%%7C0\u0026amp;cht=qr\u0026amp;chl=otpauth://totp/%s@%s%%3Fsecret%%3D%s\u0026quot;; return String.format(format, user, host, secret); } /** * Check the code entered by the user to see if it is valid * @param secret The users secret. * @param code The code displayed on the users device * @param t The time in msec (System.currentTimeMillis() for example) * @return * @throws Exception */ public boolean check_code(String secret, long code, long timeMsec) throws Exception { Base32 codec = new Base32(); byte[] decodedKey = codec.decode(secret); // convert unix msec time into a 30 second \u0026quot;window\u0026quot; // this is per the TOTP spec (see the RFC for details) long t = (timeMsec / 1000L) / 30L; // Window is used to check codes generated in the near past. // You can use this value to tune how far you're willing to go. for (int i = -window_size; i \u0026lt;= window_size; ++i) { long hash; try { hash = verify_code(decodedKey, t + i); }catch (Exception e) { // Yes, this is bad form - but // the exceptions thrown would be rare and a static configuration problem e.printStackTrace(); throw new RuntimeException(e.getMessage()); //return false; } if (hash == code) { return true; } } // The validation code is invalid. return false; } private static int verify_code(byte[] key, long t) throws NoSuchAlgorithmException, InvalidKeyException { byte[] data = new byte[8]; long value = t; for (int i = 8; i-- \u0026gt; 0; value \u0026gt;\u0026gt;\u0026gt;= 8) { data[i] = (byte) value; } SecretKeySpec signKey = new SecretKeySpec(key, \u0026quot;HmacSHA1\u0026quot;); Mac mac = Mac.getInstance(\u0026quot;HmacSHA1\u0026quot;); mac.init(signKey); byte[] hash = mac.doFinal(data); int offset = hash[20 - 1] \u0026amp; 0xF; // We're using a long because Java hasn't got unsigned int. long truncatedHash = 0; for (int i = 0; i \u0026lt; 4; ++i) { truncatedHash \u0026lt;\u0026lt;= 8; // We are dealing with signed bytes: // we just keep the first byte. truncatedHash |= (hash[offset + i] \u0026amp; 0xFF); } truncatedHash \u0026amp;= 0x7FFFFFFF; truncatedHash %= 1000000; return (int) truncatedHash; } }  æµ‹è¯•ç±»å¦‚ä¸‹:\nimport org.junit.Test; public class GoogleAuthTest { @Test public void genSecretTest() { String secret = GoogleAuthenticator.generateSecretKey(); System.out.println(\u0026quot;secret=\u0026quot;+secret); String url = GoogleAuthenticator.getQRBarcodeURL(\u0026quot;testuser\u0026quot;, \u0026quot;testhost\u0026quot;, secret); System.out.println(\u0026quot;Please register \u0026quot; + url); System.out.println(\u0026quot;Secret key is \u0026quot; + secret); } // Change this to the saved secret from the running the above test. static String savedSecret = \u0026quot;VGH25A7M54QPME5F\u0026quot;; @Test public void authTest() throws Exception { // enter the code shown on device. Edit this and run it fast before the code expires! long code = 146841; long t = System.currentTimeMillis(); GoogleAuthenticator ga = new GoogleAuthenticator(); ga.setWindowSize(5); //should give 5 * 30 seconds of grace... boolean r = ga.check_code(savedSecret, code, t); System.out.println(\u0026quot;Check code = \u0026quot; + r); } }  OTP Authåè®® åœ¨å®é™…ä½¿ç”¨ä¸­,é€šå¸¸æŠŠsecretåµŒå…¥ä¸€æ®µURLä¸­å¹¶ä»¥äºŒç»´ç çš„å½¢å¼å‘å¸ƒ,è¿™ä¸ªURLä¸€èˆ¬ç§°ä¸ºotpauthåè®®.å…¶URLå¦‚ä¸‹æ‰€ç¤º: otpauth://totp/testuser@testhost?secret=VGH25A7M54QPME5F\u0026amp;algorithm=SHA1\u0026amp;digits=6\u0026amp;period=30\n","date":"2018-01-08","permalink":"https://iminto.github.io/post/totp%E7%AE%97%E6%B3%95java%E7%89%88%E6%9C%AC/","tags":["Java"],"title":"TOTPç®—æ³•Javaç‰ˆæœ¬"},{"content":"â€ƒå‰æ®µæ—¶é—´ç”¨valaå¼€å‘äº†ä¸€ä¸ªå¾ˆå°çš„ç¨‹åº,ä½“éªŒäº†ä¸€æŠŠvalaçš„ä½¿ç”¨,ç½‘ä¸Šå…³äºvalaçš„æ–‡ç« æ¯”è¾ƒå°‘,æ‰€ä»¥å†™ä¸€ç¯‡åšå®¢,å¦‚æœä½ æœ‰ç›¸åŒçš„ä½¿ç”¨ç»éªŒå¯ä»¥äº¤æµä¸‹.\nâ€ƒæ ¹æ®ç™¾åº¦ç™¾ç§‘çš„è§£é‡Šï¼Œvalaæ˜¯ä¸€ç§æ–°çš„ã€ä¸ºGNOMEå¼€å‘è€…æä¾›çš„å…·æœ‰ç°ä»£åŒ–ç¼–ç¨‹è¯­è¨€åŠŸèƒ½çš„ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚Valaæ˜¯ä¸€ç§å’ŒC#æåº¦ç±»ä¼¼çš„è¯­è¨€ã€‚\nâ€ƒä¼—æ‰€å‘¨çŸ¥,Cæ˜¯ä¸€é—¨å¤è€è€Œè½åçš„è¯­è¨€,è™½ç„¶ç”±äºå†å²åŸå› ,å¤§é‡çš„æ“ä½œç³»ç»Ÿåº•å±‚ä»ç„¶åœ¨ä½¿ç”¨C(æ¯•ç«Ÿæœ€æ—©å†™åº•å±‚çš„é‚£æ‰¹äººæ—©å°±é€€ä¼‘ç”šè‡³ä¸åœ¨äººä¸–äº†,è°åˆæ„¿æ„æ²¡äº‹æ‰¾äº‹å»é‡æ„å‘¢.ä¸è¿‡,è¿˜åˆ«è¯´,Googleå°±åœ¨å¹²è¿™ç§äº‹,å¼€å‘å…¨æ–°çš„æ“ä½œç³»ç»Ÿ),ä½†å¹¶ä¸é€‚ç”¨äºå¤§å‹é¡¹ç›®å’Œåä½œå¼€å‘.å°½ç®¡Linuxçš„ä½œè€…Linusæåº¦æ†æ¨C++è¿™æ ·çš„é¢å‘å¯¹è±¡çš„è¯­è¨€,å¹¶æ‹’ç»C++åœ¨Linuxå†…æ ¸çš„ä½¿ç”¨.ä½†æ˜¯,Linuxçš„å…¶å®ƒå¼€å‘è€…ä¹Ÿå¿ƒçŸ¥è‚šæ˜,Cå¹¶ä¸æ˜¯ä¸€åˆ‡,å¹¶ä¸”åœ¨Linuxçš„å„ä¸ªæ–¹é¢å¤§é‡ä½¿ç”¨C++å’Œé¢å‘å¯¹è±¡çš„å¼€å‘æ¨¡å¼.çŸ¥åçš„KDEæ¡Œé¢å°±æ˜¯åŸºäºQTæ¥æ„å»ºçš„,è€ŒQTæ˜¯å¯¹C++çš„ä¸€ä¸ªæ‰©å±•,Linuxä¸Šçš„å¤§éƒ¨åˆ†å¯ç”¨çš„åº”ç”¨éƒ½æ˜¯åŸºäºQTæ¥æ„å»ºçš„,è€Œå¦ä¸€ä¸ªæ¡Œé¢ç¯å¢ƒGnomeåˆ™ä½¿ç”¨äº†GTKç»‘å®š,åŒæ—¶ä¹Ÿå¤§é‡ä½¿ç”¨äº†é¢å‘å¯¹è±¡çš„ç‰¹æ€§å’Œç»„ä»¶,æ¯”å¦‚Gobject,Vala.Valaçš„ä¸€ä¸ªé‡è¦ä½¿ç”¨åœºæ™¯å°±æ˜¯Gnomeç¯å¢ƒçš„GUIå¼€å‘.\nâ€ƒValaè¯­è¨€çš„ä¸»è¦ç‰¹ç‚¹ï¼šæ”¯æŒlambdaè¡¨è¾¾å¼ï¼›æ”¯æŒå¯¹è±¡åå°„ä¸å†…çœï¼›ä½¿ç”¨å¼•ç”¨è®¡æ•°è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œè®¡æ•°åµŒå…¥åœ¨å¯¹è±¡å†…ï¼›ä½¿ç”¨Glibå’ŒGobjectçš„ä¸»å¾ªç¯ã€äº‹ä»¶å›è°ƒç³»ç»Ÿã€‚\nå®‰è£… â€ƒåœ¨Ubuntu/Debianä¸‹å®‰è£…å¾ˆç®€å•ï¼Œä½¿ç”¨å‘½ä»¤sudo apt-get install valacï¼Œæµ‹è¯•valacç¼–è¯‘å™¨çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è¾“å…¥valac \u0026ndash;versionå‘½ä»¤ã€‚ æˆ‘ç°åœ¨ä½¿ç”¨çš„æ˜¯0.36ç‰ˆæœ¬,æœ€æ–°ç‰ˆæœ¬åº”è¯¥æ˜¯0.40 Beta.\nHelloWorldç¨‹åº class Demo.HelloWorld : GLib.Object { public static int main(string[] args) { stdout.printf(\u0026quot;Hello, World\\n\u0026quot;); return 0; } }  å…¶å®åœ¨Valaé‡Œ,ç±»å¹¶ä¸æ˜¯å¿…é¡»çš„.ç±»åå’Œæ–‡ä»¶åå¹¶ä¸éœ€è¦ä¸€è‡´,å¹¶ä¸”ä¸€ä¸ªç±»é‡Œå…è®¸å¤šä¸ªç±».\nç¼–è¯‘è¿è¡Œ ç¼–è¯‘è¿™ä¸ªç¨‹åºä½¿ç”¨å‘½ä»¤valac hello.valaï¼Œç¼–è¯‘æˆåŠŸä¹‹åç”Ÿæˆhelloè¿™ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè¿è¡Œè¿™ä¸ªç¨‹åºï¼Œè¾“å…¥ç»“æœä¸ºï¼š Hello, World\nValaä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„åœ°æ–¹å°±æ˜¯å¯ä»¥ç›´æ¥ä»Valaæºç ç¼–è¯‘æˆCæºç ,æ¯”å¦‚ä¸Šé¢çš„ä»£ç å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤ç¼–è¯‘æˆCæºç \nvalac -C ./hello.vala  ç”Ÿæˆçš„Cæºç å¦‚ä¸‹:\n/* hello.c generated by valac 0.36.5, the Vala compiler * generated from hello.vala, do not modify */ #include \u0026lt;glib.h\u0026gt; #include \u0026lt;glib-object.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #define DEMO_TYPE_HELLO_WORLD (demo_hello_world_get_type ()) #define DEMO_HELLO_WORLD(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), DEMO_TYPE_HELLO_WORLD, DemoHelloWorld)) #define DEMO_HELLO_WORLD_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), DEMO_TYPE_HELLO_WORLD, DemoHelloWorldClass)) #define DEMO_IS_HELLO_WORLD(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), DEMO_TYPE_HELLO_WORLD)) #define DEMO_IS_HELLO_WORLD_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), DEMO_TYPE_HELLO_WORLD)) #define DEMO_HELLO_WORLD_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), DEMO_TYPE_HELLO_WORLD, DemoHelloWorldClass)) typedef struct _DemoHelloWorld DemoHelloWorld; typedef struct _DemoHelloWorldClass DemoHelloWorldClass; typedef struct _DemoHelloWorldPrivate DemoHelloWorldPrivate; struct _DemoHelloWorld { GObject parent_instance; DemoHelloWorldPrivate * priv; }; struct _DemoHelloWorldClass { GObjectClass parent_class; }; static gpointer demo_hello_world_parent_class = NULL; GType demo_hello_world_get_type (void) G_GNUC_CONST; enum { DEMO_HELLO_WORLD_DUMMY_PROPERTY }; gint demo_hello_world_main (gchar** args, int args_length1); DemoHelloWorld* demo_hello_world_new (void); DemoHelloWorld* demo_hello_world_construct (GType object_type); gint demo_hello_world_main (gchar** args, int args_length1) { gint result = 0; FILE* _tmp0_; _tmp0_ = stdout; fprintf (_tmp0_, \u0026quot;Hello, World\\n\u0026quot;); result = 0; return result; } int main (int argc, char ** argv) { #if !GLIB_CHECK_VERSION (2,35,0) g_type_init (); #endif return demo_hello_world_main (argv, argc); } DemoHelloWorld* demo_hello_world_construct (GType object_type) { DemoHelloWorld * self = NULL; self = (DemoHelloWorld*) g_object_new (object_type, NULL); return self; } DemoHelloWorld* demo_hello_world_new (void) { return demo_hello_world_construct (DEMO_TYPE_HELLO_WORLD); } static void demo_hello_world_class_init (DemoHelloWorldClass * klass) { demo_hello_world_parent_class = g_type_class_peek_parent (klass); } static void demo_hello_world_instance_init (DemoHelloWorld * self) { } GType demo_hello_world_get_type (void) { static volatile gsize demo_hello_world_type_id__volatile = 0; if (g_once_init_enter (\u0026amp;demo_hello_world_type_id__volatile)) { static const GTypeInfo g_define_type_info = { sizeof (DemoHelloWorldClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) demo_hello_world_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (DemoHelloWorld), 0, (GInstanceInitFunc) demo_hello_world_instance_init, NULL }; GType demo_hello_world_type_id; demo_hello_world_type_id = g_type_register_static (G_TYPE_OBJECT, \u0026quot;DemoHelloWorld\u0026quot;, \u0026amp;g_define_type_info, 0); g_once_init_leave (\u0026amp;demo_hello_world_type_id__volatile, demo_hello_world_type_id); } return demo_hello_world_type_id__volatile; }  â€ƒå¯ä»¥çœ‹å‡º valaå®é™…æ˜¯æŠŠvalaæºç ç¼–è¯‘æˆGObjectçš„è¯­æ³•,å¹¶ä¸”åŠ å…¥äº†å¾ˆå¤šè¯­æ³•ç³–.ç”±äºvalaçš„è¿™ä¸ªç‰¹æ€§,ä»è€Œä¹Ÿå†³å®šäº†valaæ˜¯ä¸€ç§æ€§èƒ½æ¯”è¾ƒé«˜çš„è¯­è¨€.æ—¢èƒ½è·å¾—é¢å‘å¯¹è±¡çš„ä¾¿åˆ©,åˆèƒ½è·å¾—æ¥è¿‘äºCè¯­è¨€çš„æ€§èƒ½.\nâ€ƒvalaå¯ä»¥å¤§é‡ä½¿ç”¨glibçš„åº“,å…·æœ‰æ¯”è¾ƒå¼ºçš„è¡¨ç°åŠ›å’Œè¾ƒé«˜çš„å¼€å‘æ•ˆç‡.ç„¶è€Œç”±äºå…¶å®šä½çš„é—®é¢˜,ä¸èƒ½åœ¨æœåŠ¡ç«¯å¸‚åœºåˆ†å¾—ä¸€æ¯ç¾¹,å¯¼è‡´å‘å±•æä¸ºæœ‰é™,å¯æƒœäº†è¿™é—¨åœ¨æˆ‘çœ‹æ¥,åœ¨Linuxä¸Šå¼€å‘ä½“éªŒä»…æ¬¡äºC++å’ŒJavaçš„è¯­è¨€.å¦‚æœä½ æ¥è§¦è¿‡C++ 17 ä»¥ä¸Šæ ‡å‡†çš„C++,ä½ å°±ä¼šæ„Ÿè§‰åˆ°C++çš„è¡¨ç°èƒ½åŠ›å’Œå¼€å‘æ•ˆç‡,å·²ç»æ˜¯ä¸€é—¨æ¯”è¾ƒç°ä»£åŒ–çš„è¯­è¨€äº†,å¹¶ä¸ä¼šæ¯”è„šæœ¬è¯­è¨€ä½å¤šå°‘.\n","date":"2018-01-08","permalink":"https://iminto.github.io/post/vala%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/","tags":["Vala"],"title":"Valaä½¿ç”¨ä½“éªŒ"}]